!function(t){var e={};function i(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);var n=function(){function t(t){this.observable=t,this.callback=function(){}}return t.prototype.unsubscribe=function(){this.observable.unsubscribe(this)},t}(),r=function(){function t(){this.subscriptions=[]}return t.prototype.subscribe=function(t){var e=new n(this);return e.callback=t,this.subscriptions.push(e),e},t.prototype.unsubscribe=function(t){var e=this.subscriptions.indexOf(t);this.subscriptions.splice(e,1)},t.prototype.next=function(t){for(var e=0,i=this.subscriptions;e<i.length;e++){i[e].callback(t)}},t}(),o={pi:3.1415,deg2rad:3.1415/180,rad2deg:180/3.1415,eps:1e-5};function s(t){return 0==(t&t-1)}function a(t,e){return Math.abs(t-e)<o.eps}function h(t,e,i){return Math.max(e,Math.min(i,t))}function u(t,e){return(t-t%e)/e}var c,l=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i}return t.prototype.multiplyNum=function(e){return new t(this.x*e,this.y*e,this.z*e)},t.prototype.multiplyNumSelf=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.prototype.multiplyMatSelf=function(t){return this.x=t.e[0]*this.x+t.e[4]*this.y+t.e[8]*this.z+t.e[12],this.y=t.e[1]*this.x+t.e[5]*this.y+t.e[9]*this.z+t.e[13],this.z=t.e[2]*this.x+t.e[6]*this.y+t.e[10]*this.z+t.e[14],this},t.prototype.set=function(e,i,n){if(e instanceof f)this.x=e.x,this.y=e.y;else if(e instanceof t)this.x=e.x,this.y=e.y,this.z=e.z;else{if(void 0===i||void 0===n)throw new Error("Vector3.set(): 'x' is number but no 'y' and 'z' provided");this.x=e,this.y=i,this.z=n}return this},t.prototype.length=function(){return Math.sqrt(this.lengthQ())},t.prototype.lengthQ=function(){return Math.pow(this.x,2)+Math.pow(this.y,2)+Math.pow(this.z,2)},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z)},t.prototype.addToSelf=function(e,i,n){if(e instanceof f)this.x+=e.x,this.y+=e.y;else if(e instanceof t)this.x+=e.x,this.y+=e.y,this.z+=e.z;else{if(null==i||null==n)throw new Error("Vector3.addToSelf() first argument is number, but no second and third are provided");this.x+=e,this.y+=i,this.z+=n}return this},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z)},t.prototype.normal=function(){var e=this.length();return e<o.eps?new t(0,0,0):this.multiplyNum(1/e)},t.prototype.normalize=function(){var t=this.length();return t<o.eps?this.set(0,0,0):this.multiplyNumSelf(1/t),this},t.prototype.lerp=function(t,e){return t.subtract(this).multiplyNum(e).add(this)},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.prototype.cross=function(e){return new t(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},t.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.prototype.negateVector=function(){return new t(-this.x,-this.y,-this.z)},t.prototype.asVector2=function(){return new f(this.x,this.y)},t}(),p=new l(0,0,1),f=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.fromAngle=function(e){return new t(Math.cos(-e*o.deg2rad),Math.sin(e*o.deg2rad)).normalize()},t.prototype.set=function(e,i){if(e instanceof t||e instanceof l)this.x=e.x,this.y=e.y;else{if(void 0===i)throw new Error("Vector2.set(): 'x' is number, but no 'y' provided");this.x=e,this.y=i}return this},t.prototype.equalTo=function(t){return a(this.x,t.x)&&a(this.y,t.y)},t.prototype.toAngle=function(){return Math.atan2(this.y,this.x)*o.rad2deg},t.prototype.lengthQ=function(){return Math.pow(this.x,2)+Math.pow(this.y,2)},t.prototype.length=function(){return Math.sqrt(this.lengthQ())},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.addToSelf=function(e,i){if(e instanceof t||e instanceof l)this.x+=e.x,this.y+=e.y;else{if(void 0===i)throw new Error("Vector2.addToSelf(): 'x' is number but no 'y' provided");this.x+=e,this.y+=i}return this},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y)},t.prototype.subtractFromSelf=function(e,i){if(e instanceof t||e instanceof l)this.x-=e.x,this.y-=e.y;else{if(void 0===i)throw new Error("Vector2.subtractFromSelf(): 'x' is number but no 'y' provided");this.x-=e,this.y-=i}return this},t.prototype.multiplyNum=function(e){return new t(this.x*e,this.y*e)},t.prototype.multiplyNumSelf=function(t){return this.x*=t,this.y*=t,this},t.prototype.multiplyVecSelf=function(e,i){if(e instanceof t)this.x*=e.x,this.y*=e.y;else{if(null==i)throw new Error("Vector2.multiplyVecSelf(): 'x' is number but no 'y' provided");this.x*=e,this.y*=i}return this},t.prototype.normal=function(){var e=this.length();return e<o.eps?new t(0,0):this.multiplyNum(1/e)},t.prototype.normalize=function(){var t=this.length();return t<o.eps?this.set(0,0):this.multiplyNumSelf(1/t),this},t.prototype.toString=function(){return"x: "+this.x+", y:"+this.y},t}();!function(t){t[t.TouchDown=0]="TouchDown",t[t.TouchUp=1]="TouchUp",t[t.TouchMove=2]="TouchMove",t[t.KeyDown=3]="KeyDown",t[t.KeyUp=4]="KeyUp",t[t.Wheel=5]="Wheel"}(c||(c={}));var d,y,m,g=function(){return function(){this.isDown=!1,this.start=new f(0,0),this.current=new f(0,0)}}(),v=new(function(){function t(){this.touches=[new g,new g,new g,new g,new g,new g,new g,new g,new g,new g],this.mousePos=new f(0,0),this.isKeyDown=new Array(256),this.lastWheelDelta=0,this.events=new r}return t.prototype.process=function(t){var e=t.key;switch(t.inputType){case c.TouchDown:this.touches[e].isDown=!0,this.touches[e].start.set(t.x,t.y),this.touches[e].current.set(t.x,t.y);break;case c.TouchUp:this.touches[e].isDown=!1;break;case c.TouchMove:this.touches[e].current.set(t.x,t.y),this.mousePos.set(t.x,t.y);break;case c.KeyDown:this.isKeyDown[e]=!0;break;case c.KeyUp:this.isKeyDown[e]=!1;break;case c.Wheel:this.lastWheelDelta=t.w}this.events.next(t)},t}()),w=function(){function t(t,e,i,n,r){this.inputType=t,this.key=e,this.x=i,this.y=n,this.w=r,this._initialized=!1,this._initialized=!0}return t.prototype.reset=function(t,e,i,n,r){this.inputType=t,this.key=e,this.x=i,this.y=n,this.w=r,this._initialized=!0},t}();!function(t){t[t.NoInput=0]="NoInput",t[t.LeftButton=1]="LeftButton",t[t.RightButton=2]="RightButton",t[t.Cancel=3]="Cancel",t[t.MiddleButton=4]="MiddleButton",t[t.XButton1=5]="XButton1",t[t.XButton2=6]="XButton2",t[t.Back=8]="Back",t[t.Tab=9]="Tab",t[t.Clear=12]="Clear",t[t.Return=13]="Return",t[t.Shift=16]="Shift",t[t.Ctrl=17]="Ctrl",t[t.Alt=18]="Alt",t[t.Pause=19]="Pause",t[t.CapsLock=20]="CapsLock",t[t.Escape=27]="Escape",t[t.Space=32]="Space",t[t.PageUp=33]="PageUp",t[t.PageDown=34]="PageDown",t[t.End=35]="End",t[t.Home=36]="Home",t[t.Left=37]="Left",t[t.Up=38]="Up",t[t.Right=39]="Right",t[t.Down=40]="Down",t[t.PrintScreen=44]="PrintScreen",t[t.Insert=45]="Insert",t[t.Delete=46]="Delete",t[t._0=48]="_0",t[t._1=49]="_1",t[t._2=50]="_2",t[t._3=51]="_3",t[t._4=52]="_4",t[t._5=53]="_5",t[t._6=54]="_6",t[t._7=55]="_7",t[t._8=56]="_8",t[t._9=57]="_9",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.LeftWin=91]="LeftWin",t[t.RightWin=92]="RightWin",t[t.Select=93]="Select",t[t.NumPad0=96]="NumPad0",t[t.NumPad1=97]="NumPad1",t[t.NumPad2=98]="NumPad2",t[t.NumPad3=99]="NumPad3",t[t.NumPad4=100]="NumPad4",t[t.NumPad5=101]="NumPad5",t[t.NumPad6=102]="NumPad6",t[t.NumPad7=103]="NumPad7",t[t.NumPad8=104]="NumPad8",t[t.NumPad9=105]="NumPad9",t[t.NumPadMul=106]="NumPadMul",t[t.NumPadAdd=107]="NumPadAdd",t[t.NumPadSeparator=108]="NumPadSeparator",t[t.NumPadSub=109]="NumPadSub",t[t.NumPadDecimal=110]="NumPadDecimal",t[t.NumPadDiv=111]="NumPadDiv",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.F13=124]="F13",t[t.F14=125]="F14",t[t.F15=126]="F15",t[t.F16=127]="F16",t[t.F17=128]="F17",t[t.F18=129]="F18",t[t.F19=130]="F19",t[t.F20=131]="F20",t[t.F21=132]="F21",t[t.F22=133]="F22",t[t.F23=134]="F23",t[t.F24=135]="F24",t[t.NumLock=144]="NumLock",t[t.ScrollLock=145]="ScrollLock",t[t.WheelUp=151]="WheelUp",t[t.WheelDown=152]="WheelDown",t[t.Semicolon=186]="Semicolon",t[t.Equal=187]="Equal",t[t.Comma=188]="Comma",t[t.Dash=189]="Dash",t[t.Period=190]="Period",t[t.ForwardSlash=191]="ForwardSlash",t[t.GraveAccent=192]="GraveAccent",t[t.OpenBracket=219]="OpenBracket",t[t.BackSlash=220]="BackSlash",t[t.CloseBracket=221]="CloseBracket",t[t.SingleQuote=222]="SingleQuote"}(d||(d={}));var x,b,_,T,M,C,S,P,k,A=function(){function t(){}return t.registerWebGLContext=function(t){y=t},t.registerWebGLRenderer=function(t){m=t},t}();!function(t){t[t.Repeat=0]="Repeat",t[t.ClampToEdge=1]="ClampToEdge",t[t.MirrorRepeat=2]="MirrorRepeat"}(x||(x={})),function(t){t[t.Nearest=0]="Nearest",t[t.Linear=1]="Linear"}(b||(b={})),function(t){t[t.Pos2Tex2=0]="Pos2Tex2",t[t.Pos3Tex2=1]="Pos3Tex2",t[t.Pos3Tex2Nor3=2]="Pos3Tex2Nor3",t[t.Pos3Tex2Col4=3]="Pos3Tex2Col4"}(_||(_={})),function(t){t[t.Byte=0]="Byte",t[t.Short=1]="Short",t[t.Int=2]="Int"}(T||(T={})),function(t){t[t.vaCoord=0]="vaCoord",t[t.vaNormal=1]="vaNormal",t[t.vaTexCoord0=2]="vaTexCoord0",t[t.vaTexCoord1=3]="vaTexCoord1",t[t.vaColor=4]="vaColor"}(M||(M={})),function(t){t[t.None=0]="None",t[t.Alpha=1]="Alpha",t[t.Additive=2]="Additive",t[t.Multiply=3]="Multiply",t[t.Screen=4]="Screen"}(C||(C={})),function(t){t[t.None=0]="None",t[t.Back=1]="Back",t[t.Front=2]="Front"}(S||(S={})),function(t){t[t.Never=0]="Never",t[t.Less=1]="Less",t[t.Equal=2]="Equal",t[t.LessOrEqual=3]="LessOrEqual",t[t.Greater=4]="Greater",t[t.NotEqual=5]="NotEqual",t[t.GreaterOrEqual=6]="GreaterOrEqual",t[t.Always=7]="Always"}(P||(P={})),function(t){t[t.All=0]="All",t[t.Color=1]="Color",t[t.Depth=2]="Depth"}(k||(k={}));var E,D,B=function(){function t(e,i){if(this.format=e,this.count=i,this.buffer=y.createBuffer(),!this.buffer)throw new Error("Error while creating Index Buffer");var n=i*t.getSizeFromFormat(e);switch(e){case T.Byte:this._intArray=new Uint8Array(i);break;case T.Short:this._intArray=new Uint16Array(i);break;case T.Int:this._intArray=new Uint32Array(i);break;default:throw new Error("new IndexBuffer() - wrong index format: "+this.format)}this.bind(),y.bufferData(y.ELEMENT_ARRAY_BUFFER,n,y.STATIC_DRAW)}return t.getSizeFromFormat=function(t){switch(t){case T.Byte:return 1;case T.Short:return 2;case T.Int:return 4}},t.getWebGLFormat=function(t){switch(t){case T.Byte:return y.UNSIGNED_BYTE;case T.Short:return y.UNSIGNED_SHORT;case T.Int:return y.UNSIGNED_INT}},t.prototype.free=function(){y.deleteBuffer(this.buffer)},t.prototype.bind=function(){y.bindBuffer(y.ELEMENT_ARRAY_BUFFER,this.buffer)},t.prototype.update=function(t,e){this.bind(),this._intArray.set(t,e),y.bufferSubData(y.ELEMENT_ARRAY_BUFFER,0,this._intArray)},t}(),O=function(){function t(){this.e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}return t.fromVectorAngle=function(e,i){var n=Math.sin(e),r=Math.cos(e),o=1-r,s=i.x*i.y,a=i.y*i.z,h=i.z*i.x,u=i.x*n,c=i.y*n,l=i.z*n,p=o*s,f=o*a,d=o*h,y=new t;return y.e=[o*i.x*i.x+r,p+l,d-c,0,p-l,o*i.y*i.y+r,f+u,0,d+c,f-u,o*i.z*i.z+r,0,0,0,0,1],y},t.prototype.multiplyMat=function(e){var i=new t,n=this,r=e;return i.e=[n.e[0]*r.e[0]+n.e[4]*r.e[1]+n.e[8]*r.e[2]+n.e[12]*r.e[3],n.e[1]*r.e[0]+n.e[5]*r.e[1]+n.e[9]*r.e[2]+n.e[13]*r.e[3],n.e[2]*r.e[0]+n.e[6]*r.e[1]+n.e[10]*r.e[2]+n.e[14]*r.e[3],n.e[3]*r.e[0]+n.e[7]*r.e[1]+n.e[11]*r.e[2]+n.e[15]*r.e[3],n.e[0]*r.e[4]+n.e[4]*r.e[5]+n.e[8]*r.e[6]+n.e[12]*r.e[7],n.e[1]*r.e[4]+n.e[5]*r.e[5]+n.e[9]*r.e[6]+n.e[13]*r.e[7],n.e[2]*r.e[4]+n.e[6]*r.e[5]+n.e[10]*r.e[6]+n.e[14]*r.e[7],n.e[3]*r.e[4]+n.e[7]*r.e[5]+n.e[11]*r.e[6]+n.e[15]*r.e[7],n.e[0]*r.e[8]+n.e[4]*r.e[9]+n.e[8]*r.e[10]+n.e[12]*r.e[11],n.e[1]*r.e[8]+n.e[5]*r.e[9]+n.e[9]*r.e[10]+n.e[13]*r.e[11],n.e[2]*r.e[8]+n.e[6]*r.e[9]+n.e[10]*r.e[10]+n.e[14]*r.e[11],n.e[3]*r.e[8]+n.e[7]*r.e[9]+n.e[11]*r.e[10]+n.e[15]*r.e[11],n.e[0]*r.e[12]+n.e[4]*r.e[13]+n.e[8]*r.e[14]+n.e[12]*r.e[15],n.e[1]*r.e[12]+n.e[5]*r.e[13]+n.e[9]*r.e[14]+n.e[13]*r.e[15],n.e[2]*r.e[12]+n.e[6]*r.e[13]+n.e[10]*r.e[14]+n.e[14]*r.e[15],n.e[3]*r.e[12]+n.e[7]*r.e[13]+n.e[11]*r.e[14]+n.e[15]*r.e[15]],i},t.prototype.multiplyMatSelf=function(t){return this.e=this.multiplyMat(t).e,this},t.prototype.multiplyVec=function(t){return new l(this.e[0]*t.x+this.e[4]*t.y+this.e[8]*t.z+this.e[12],this.e[1]*t.x+this.e[5]*t.y+this.e[9]*t.z+this.e[13],this.e[2]*t.x+this.e[6]*t.y+this.e[10]*t.z+this.e[14])},t.prototype.multiplyNum=function(e){for(var i=new t,n=0;n<16;++n)i.e[n]=this.e[n]*e;return i},t.prototype.identity=function(){this.e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},t.prototype.ortho=function(t,e,i,n,r,o){this.e=[2/(e-t),0,0,0,0,2/(n-i),0,0,0,0,-2/(o-r),0,-(e+t)/(e-t),-(n+i)/(n-i),-(o+r)/(o-r),1]},t.prototype.perspective=function(t,e,i,n){t=Math.min(179.9,Math.max(0,t));var r=i*Math.tan(t*o.deg2rad*.5),s=r*e;this.frustum(-s,s,-r,r,i,n)},t.prototype.frustum=function(t,e,i,n,r,o){this.e=[2*r/(e-t),0,0,0,0,2*r/(n-i),0,0,(e+t)/(e-t),(n+i)/(n-i),(o+r)/(r-o),-1,0,0,2*o*r/(r-o),0]},t.prototype.transpose=function(){for(var e=new t,i=0;i<4;++i)for(var n=0;n<4;++n)e.e[4*i+n]=this.e[4*n+i];return e},t.prototype.rotate=function(e,i){var n=t.fromVectorAngle(e,i);this.multiplyMatSelf(n)},Object.defineProperty(t.prototype,"position",{get:function(){return new l(this.e[12],this.e[13],this.e[14])},set:function(t){this.e[12]=t.x,this.e[13]=t.y,this.e[14]=t.z},enumerable:!0,configurable:!0}),t}(),F=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=i,this.w=n}return t.prototype.set=function(e,i,n,r){if(e instanceof t)this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w;else{if(void 0===i||void 0===n||void 0===r)throw new Error("Vector.set() - x is number, but no y, z, w provided");this.x=e,this.y=i,this.z=n,this.w=r}return this},t.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]},t}(),R=function(){function t(){this.viewProjection=new O,this.model=new O,this.modelViewProjection=new O,this.color=new F(1,1,1,1),this.calculateMVP()}return t.prototype.calculateMVP=function(){this.modelViewProjection=this.viewProjection.multiplyMat(this.model)},t}(),I=function(){function t(t,e){if(this.format=t,this.count=e,this.buffer=y.createBuffer(),this.buffer){this.bind();var i=e*this.getSizeFromFormat(this.format);y.bufferData(y.ARRAY_BUFFER,i,y.STATIC_DRAW),this._floatArray=new Float32Array(e*this.getFloatCountFromFormat(this.format))}else console.log("Error while creating Vertex Buffer")}return t.prototype.bind=function(){y.bindBuffer(y.ARRAY_BUFFER,this.buffer);var t=this.getSizeFromFormat(this.format);switch(this.format){case _.Pos3Tex2:y.enableVertexAttribArray(M.vaCoord),y.enableVertexAttribArray(M.vaTexCoord0),y.vertexAttribPointer(M.vaCoord,3,y.FLOAT,!1,t,0),y.vertexAttribPointer(M.vaTexCoord0,2,y.FLOAT,!1,t,12);break;case _.Pos2Tex2:y.enableVertexAttribArray(M.vaCoord),y.enableVertexAttribArray(M.vaTexCoord0),y.vertexAttribPointer(M.vaCoord,2,y.FLOAT,!1,t,0),y.vertexAttribPointer(M.vaTexCoord0,2,y.FLOAT,!1,t,8);break;case _.Pos3Tex2Nor3:y.enableVertexAttribArray(M.vaCoord),y.enableVertexAttribArray(M.vaTexCoord0),y.enableVertexAttribArray(M.vaNormal),y.vertexAttribPointer(M.vaCoord,3,y.FLOAT,!1,t,0),y.vertexAttribPointer(M.vaTexCoord0,2,y.FLOAT,!1,t,12),y.vertexAttribPointer(M.vaNormal,3,y.FLOAT,!1,t,20);break;case _.Pos3Tex2Col4:y.enableVertexAttribArray(M.vaCoord),y.enableVertexAttribArray(M.vaTexCoord0),y.enableVertexAttribArray(M.vaColor),y.vertexAttribPointer(M.vaCoord,3,y.FLOAT,!1,t,0),y.vertexAttribPointer(M.vaTexCoord0,2,y.FLOAT,!1,t,12),y.vertexAttribPointer(M.vaColor,4,y.FLOAT,!1,t,20)}},t.prototype.free=function(){y.deleteBuffer(this.buffer)},t.prototype.update=function(t,e){this.bind(),this._floatArray.set(t,e),y.bufferSubData(y.ARRAY_BUFFER,0,this._floatArray)},t.prototype.getSizeFromFormat=function(t){return 4*this.getFloatCountFromFormat(t)},t.prototype.getFloatCountFromFormat=function(t){switch(t){case _.Pos3Tex2:return 5;case _.Pos2Tex2:return 4;case _.Pos3Tex2Nor3:return 8;case _.Pos3Tex2Col4:return 9}},t}(),V=8,z=function(){function t(t){this.canvasElement=t,this.renderParams=new R,this._blendingMode=C.None,this._depthWrite=!1,this._depthTest=!1,this._depthFunc=P.Never,this._textureSampler=new Array(V),this._statTextureBind=0,this._statTriCount=0,this._statDIPCount=0,this.onMouseMove=function(t){},this.onMouseDown=function(t,e){},this.onMouseUp=function(t,e){},this.onKeyDown=function(t){},this.onKeyUp=function(t){};var e=t.getContext("webgl")||t.getContext("experimental-webgl");e?(A.registerWebGLContext(e),A.registerWebGLRenderer(this),this.initWebGL(),this.createScreenQuad(),this.initEvents(),t.focus()):console.log("GL initialize failed")}return Object.defineProperty(t.prototype,"textureBinds",{get:function(){return this._statTextureBind},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"triCount",{get:function(){return this._statTriCount},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dipCount",{get:function(){return this._statDIPCount},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),t.prototype.free=function(){this._screenQuadVB.free(),this._screenQuadIB.free()},t.prototype.resize=function(t,e){this.setViewPort(0,0,t,e)},t.prototype.resetStates=function(){this.setCullMode(S.Back),this.setBlendingMode(C.Alpha),this.setDepthFunc(P.LessOrEqual),this.setDepthWrite(!0),this.setDepthTest(!0),this._activeSampler=-1;for(var t=0;t<V;++t)this._textureSampler[t]=null;this._shader=null,this._vertexBuffer=null,this._indexBuffer=null,this._frameBuffer=null,this.renderParams.color.set(1,1,1,1),this.renderParams.viewProjection.identity(),this.renderParams.model.identity()},t.prototype.resetStatistics=function(){this._statDIPCount=0,this._statTextureBind=0,this._statTriCount=0},t.prototype.clear=function(t){switch(t){case k.All:y.clear(y.COLOR_BUFFER_BIT|y.DEPTH_BUFFER_BIT);break;case k.Color:y.clear(y.COLOR_BUFFER_BIT);break;case k.Depth:y.clear(y.DEPTH_BUFFER_BIT)}},t.prototype.setClearColor=function(t){y.clearColor(t.x,t.y,t.z,t.w)},t.prototype.setClearColorRGB=function(t,e,i,n){y.clearColor(t,e,i,n)},t.prototype.setViewPort=function(t,e,i,n){this._width=i,this._height=n,y.viewport(t,e,i,n)},t.prototype.setCullMode=function(t){if(t!==this._cullMode){switch(t){case S.None:y.disable(y.CULL_FACE);break;case S.Front:y.cullFace(y.FRONT);break;case S.Back:y.cullFace(y.BACK)}this._cullMode===S.None&&y.enable(y.CULL_FACE),this._cullMode=t}},t.prototype.setBlendingMode=function(t){if(t!==this._blendingMode){switch(t){case C.None:y.disable(y.BLEND);break;case C.Alpha:y.blendFunc(y.SRC_ALPHA,y.ONE_MINUS_SRC_ALPHA);break;case C.Additive:y.blendFunc(y.ONE,y.ONE);break;case C.Multiply:y.blendFunc(y.DST_COLOR,y.ZERO);break;case C.Screen:y.blendFunc(y.ONE,y.ONE_MINUS_SRC_COLOR)}this._blendingMode===C.None&&y.enable(y.BLEND),this._blendingMode=t}},t.prototype.setDepthWrite=function(t){t!==this._depthWrite&&(y.depthMask(t),this._depthWrite=t)},t.prototype.setDepthTest=function(t){t!==this._depthTest&&(t?y.enable(y.DEPTH_TEST):y.disable(y.DEPTH_TEST),this._depthTest=t)},t.prototype.setDepthFunc=function(t){t!==this._depthFunc&&(y.depthFunc(this.getWebGLComparison(t)),this._depthFunc=t)},t.prototype.setShader=function(t){t!==this._shader&&(y.useProgram(t.program),this._shader=t)},t.prototype.setTexture=function(t,e){this._textureSampler[e]!==t&&(this._activeSampler!==e&&(y.activeTexture(y.TEXTURE0+e),this._activeSampler=e),y.bindTexture(y.TEXTURE_2D,null===t?null:t.texture),this._textureSampler[e]=t,++this._statTextureBind)},t.prototype.setVertexBuffer=function(t){t?t!==this._vertexBuffer&&(t.bind(),this._vertexBuffer=t):y.bindBuffer(y.ARRAY_BUFFER,null)},t.prototype.setIndexBuffer=function(t){t?t!==this._indexBuffer&&(t.bind(),this._indexBuffer=t):y.bindBuffer(y.ELEMENT_ARRAY_BUFFER,null)},t.prototype.drawTriangles=function(t,e,i,n){this.setVertexBuffer(t),this.setIndexBuffer(e),y.drawElements(y.TRIANGLES,n,B.getWebGLFormat(e.format),i*B.getSizeFromFormat(e.format)),++this._statDIPCount,this._statTriCount+=Math.floor(n/3)},t.prototype.drawScreenQuad=function(t){this.renderParams.viewProjection.ortho(0,1,1,0,-1,1),this.renderParams.modelViewProjection=this.renderParams.viewProjection,t.bind(),this.clear(k.All),this.drawTriangles(this._screenQuadVB,this._screenQuadIB,0,6)},t.prototype.initWebGL=function(){var t="\n      Graphics information:\n      Vendor: "+y.getParameter(y.VENDOR)+"\n      Renderer: "+y.getParameter(y.RENDERER)+"\n      OpenGL: "+y.getParameter(y.VERSION)+"\n      GLSL: "+y.getParameter(y.SHADING_LANGUAGE_VERSION)+"\n      ";console.log(t),y.viewport(0,0,this.canvasElement.width,this.canvasElement.height)},t.prototype.initEvents=function(){var t=this,e=new f(this.canvasElement.getBoundingClientRect().left,this.canvasElement.getBoundingClientRect().top);new f(this.canvasElement.width,this.canvasElement.height);this.canvasElement.onmousemove=function(i){var n=t.getInputEventFromMouseEvent(i);v.process(n),t.onMouseMove(new f(i.pageX-e.x,i.pageY-e.y))},this.canvasElement.onmousedown=function(i){i.preventDefault(),t.canvasElement.focus();var n=t.getInputEventFromMouseEvent(i);v.process(n),t.onMouseDown(new f(i.pageX-e.x,i.pageY-e.y),n.key)},this.canvasElement.oncontextmenu=function(t){t.preventDefault()},this.canvasElement.onmouseup=function(i){var n=t.getInputEventFromMouseEvent(i);v.process(n),t.onMouseUp(new f(i.pageX-e.x,i.pageY-e.y),n.key)},this.canvasElement.onwheel=function(e){e.preventDefault();var i=t.getInputEventFromMouseEvent(e);v.process(i)},this.canvasElement.onkeydown=function(e){e.preventDefault();var i=t.getInputEventFromKeyEvent(e);v.process(i),t.onKeyDown(i.key)},this.canvasElement.onkeyup=function(e){e.preventDefault();var i=t.getInputEventFromKeyEvent(e);v.process(i),t.onKeyUp(i.key)}},t.prototype.createScreenQuad=function(){this._screenQuadVB=new I(_.Pos3Tex2Col4,4),this._screenQuadIB=new B(T.Byte,6),this._screenQuadVB.update([1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,0,0,1,0,1,1,1,1,1,0,1,1,0,0,1,1,1,1],0),this._screenQuadIB.update([0,1,2,2,3,0],0)},t.prototype.getWebGLComparison=function(t){switch(t){case P.Never:return y.NEVER;case P.Less:return y.LESS;case P.Equal:return y.EQUAL;case P.LessOrEqual:return y.LEQUAL;case P.Greater:return y.GREATER;case P.NotEqual:return y.NOTEQUAL;case P.GreaterOrEqual:return y.GEQUAL;case P.Always:return y.ALWAYS}},t.prototype.getInputEventFromMouseEvent=function(t){var e;switch(t.button){case 0:e=d.LeftButton;break;case 1:e=d.MiddleButton;break;case 2:e=d.RightButton;break;default:e=d.NoInput}var i=t.pageX-this.canvasElement.getBoundingClientRect().left,n=t.pageY-this.canvasElement.getBoundingClientRect().top,r=c.TouchMove,o=0;switch(t.type){case"mousedown":r=c.TouchDown;break;case"mouseup":r=c.TouchUp;break;case"mousemove":r=c.TouchMove;break;case"wheel":r=c.Wheel,o=t.deltaY}return new w(r,e,i,n,o)},t.prototype.getInputEventFromKeyEvent=function(t){var e=c.TouchMove;switch(t.type){case"keydown":e=c.KeyDown;break;case"keyup":e=c.KeyUp}var i=t.keyCode;return new w(e,i,0,0,0)},t}(),N=function(){function t(t){var e=this;this.deltaTime=0,this.lastTime=0,this.currentTime=0,this.pauseAll=!1,this.renderer=new z(t),this.renderer.onMouseMove=function(t){return e.onMouseMove(t)},this.renderer.onMouseDown=function(t,i){return e.onMouseDown(t,i)},this.renderer.onMouseUp=function(t,i){return e.onMouseUp(t,i)},this.renderer.onKeyDown=function(t){return e.onKeyDown(t)},this.renderer.onKeyUp=function(t){return e.onKeyUp(t)},this.renderer.setViewPort(0,0,t.width,t.height)}return t.prototype.run=function(){var t=this;this.onInit();var e=function(i){t.lastTime=t.currentTime,t.currentTime=i/1e3,t.deltaTime=Math.min(t.currentTime-t.lastTime,.1),t.pauseAll||(t.onUpdate(t.deltaTime),t.onRender()),window.requestAnimationFrame(e)};window.requestAnimationFrame(e)},t.prototype.onRender=function(){this.renderer.clear(k.All),this.renderer.resetStates(),this.renderer.resetStatistics()},t}();!function(t){t[t.Active=0]="Active",t[t.Paused=1]="Paused"}(E||(E={})),function(t){t[t.Hidden=0]="Hidden",t[t.Visible=1]="Visible"}(D||(D={}));var L,U=function(){function t(){this.state=E.Paused,this.renderState=D.Hidden}return t.prototype.load=function(){var t=this;return new Promise(function(e,i){t.state=E.Active,t.renderState=D.Visible,e()})},t.prototype.unload=function(){var t=this;return new Promise(function(e,i){t.state=E.Paused,t.renderState=D.Hidden,e()})},t.prototype.setPause=function(t){this.state=t?E.Paused:E.Active,this.onPause(t)},t.prototype.setHide=function(t){this.renderState=t?D.Hidden:D.Visible},t.prototype.onPause=function(t){},t.prototype.onMouseMove=function(t){},t.prototype.onMouseDown=function(t,e){},t.prototype.onMouseUp=function(t,e){},t.prototype.onKeyDown=function(t){},t.prototype.onKeyUp=function(t){},t}(),j=function(){function t(){this.current=null,this.modal=null,this.scenes={}}return t.prototype.addScene=function(t,e){if(this.scenes[t])throw new Error("Scene with name '"+t+"' already exists");this.scenes[t]=e,e.sceneManager=this},t.prototype.switchTo=function(t){var e=this;this.current?this.current.unload().then(function(){e.current=e.scenes[t],e.current.load()}):(this.current=this.scenes[t],this.current.load())},t.prototype.showModal=function(t,e){return this.current&&(this.current.setPause(!0),e&&this.current.setHide(!0)),this.modal=this.scenes[t],this.modal.load()},t.prototype.closeModal=function(){var t=this;if(!this.modal)throw new Error("Try to close modal but no modal found");return this.modal.unload().then(function(){t.modal=null,t.current&&(t.current.setPause(!1),t.current.setHide(!1))})},t.prototype.update=function(t){for(var e in this.scenes)this.scenes[e].state===E.Active&&this.scenes[e].update(t)},t.prototype.render=function(){for(var t in this.scenes)this.scenes[t].renderState!==D.Hidden&&this.scenes[t].render()},t.prototype.onMouseMove=function(t){for(var e in this.scenes)this.scenes[e].state===E.Active&&this.scenes[e].onMouseMove(t)},t.prototype.onMouseDown=function(t,e){for(var i in this.scenes)this.scenes[i].state===E.Active&&this.scenes[i].onMouseDown(t,e)},t.prototype.onMouseUp=function(t,e){for(var i in this.scenes)this.scenes[i].state===E.Active&&this.scenes[i].onMouseUp(t,e)},t.prototype.onKeyDown=function(t){for(var e in this.scenes)this.scenes[e].state===E.Active&&this.scenes[e].onKeyDown(t)},t.prototype.onKeyUp=function(t){for(var e in this.scenes)this.scenes[e].state===E.Active&&this.scenes[e].onKeyUp(t)},t}(),H=30,W=function(){function t(t,e){this.newItem=t,this.poolObjects=new Array(e||H);for(var i=0;i<this.poolObjects.length;++i)this.poolObjects[i]=this.newItem(),this.poolObjects[i].onDeactivate()}return t.prototype.get=function(){for(var t=0,e=this.poolObjects;t<e.length;t++){var i=e[t];if(!i.active)return i.active=!0,i.onActivate(),i}var n=this.newItem();return n.active=!0,n.onActivate(),this.poolObjects.push(n),n},t.prototype.return=function(t){t.active=!1,t.onDeactivate()},t}();!function(t){t[t.Simple=0]="Simple",t[t.Continuous=1]="Continuous"}(L||(L={}));var G,K=function(){function t(t){this._actionManager=t,this.active=!1,this.paused=!1,this.actionType=L.Simple,this.pauseOnStart=0,this.time=0,this.duration=0,this.nextActions=[],this.action=function(){return!1}}return t.prototype.onActivate=function(){this.active=!0,this.paused=!1,this.time=0,this.duration=0,this.nextActions=[]},t.prototype.onDeactivate=function(){this.active=!1},t.prototype.then=function(t,e,i){return void 0===e&&(e=0),this._actionManager.addAfter(this,t,e,i)},t.prototype.update=function(t){if(this.active&&!this.paused&&(this.time+=t,!(this.time<this.pauseOnStart))){if(this.actionType===L.Simple)return this.action(),this.onDeactivate(),void this.playNextActions();(this.action(t,this.time)||this.duration&&this.time>=this.duration+this.pauseOnStart)&&(this.onDeactivate(),this.playNextActions())}},t.prototype.playNextActions=function(){for(var t=0,e=this.nextActions;t<e.length;t++){e[t].paused=!1}},t}(),X=function(){function t(){var t=this;this._pool=new W(function(){return new K(t)},10)}return t.prototype.add=function(t,e,i){void 0===e&&(e=0);var n=this._pool.get();return void 0!==i&&(n.duration=i),n.pauseOnStart=e,n.actionType=this.isSimpleAction(t)?L.Simple:L.Continuous,n.action=t,n},t.prototype.addAfter=function(t,e,i,n){void 0===i&&(i=0);var r=this.add(e,i,n);return r.paused=!0,t.nextActions.push(r),r},t.prototype.update=function(t){for(var e=0,i=this._pool.poolObjects;e<i.length;e++){i[e].update(t)}},t.prototype.isSimpleAction=function(t){return 0===t.length},t}(),Q=function(t,e,i){return 1===i?t+e:e*(1-Math.pow(2,-15*i))+t},Y=function(t,e,i){return 1===i?t+e:0===e||0===i?t:e*Math.pow(2,-10*i)*Math.sin(6.28*(i-.0625)/.25)+e+t},q=function(t,e,i){return 1===i?t+e:t+e*i};!function(t){t[t.ElasticEaseIn=0]="ElasticEaseIn",t[t.ElasticEaseOut=1]="ElasticEaseOut",t[t.ExpoEaseIn=2]="ExpoEaseIn",t[t.Bounce=3]="Bounce",t[t.Simple=4]="Simple"}(G||(G={}));var $,J,Z=function(){function t(){this.active=!1,this.time=0,this.pauseOnStart=0,this.duration=0,this.start=0,this.finish=0,this.current=0,this.setValue=function(t){return t},this.easingFunc=function(t,e,i){return t}}return t.prototype.onActivate=function(){this.active=!0},t.prototype.onDeactivate=function(){this.active=!1},t.prototype.refresh=function(t,e,i,n,r,o){void 0===o&&(o=0),this.setValue=t,this.easingFunc=this.getEasingFunc(e),this.start=i,i instanceof f||i instanceof l||i instanceof F?this.current.set(i):this.current=this.start,this.finish=n,this.duration=r,this.pauseOnStart=o,this.time=0,this.onActivate()},t.prototype.getUnitValue=function(){return this.time<=this.pauseOnStart?0:this.time>=this.duration+this.pauseOnStart?1:(this.time-this.pauseOnStart)/this.duration},t.prototype.update=function(t){this.active&&(this.time+=t,this.start instanceof f&&this.finish instanceof f?this.current.set(this.easingFunc(this.start.x,this.finish.x-this.start.x,this.getUnitValue()),this.easingFunc(this.start.y,this.finish.y-this.start.y,this.getUnitValue())):this.start instanceof l&&this.finish instanceof l?this.current.set(this.easingFunc(this.start.x,this.finish.x-this.start.x,this.getUnitValue()),this.easingFunc(this.start.y,this.finish.y-this.start.y,this.getUnitValue()),this.easingFunc(this.start.z,this.finish.z-this.start.z,this.getUnitValue())):this.start instanceof F&&this.finish instanceof F?this.current.set(this.easingFunc(this.start.x,this.finish.x-this.start.x,this.getUnitValue()),this.easingFunc(this.start.y,this.finish.y-this.start.y,this.getUnitValue()),this.easingFunc(this.start.z,this.finish.z-this.start.z,this.getUnitValue()),this.easingFunc(this.start.w,this.finish.w-this.start.w,this.getUnitValue())):"number"==typeof this.start&&"number"==typeof this.finish&&(this.current=this.easingFunc(this.start,this.finish-this.start,this.getUnitValue())),this.setValue(this.current),this.time-this.pauseOnStart>=this.duration&&(this.time=this.duration+this.pauseOnStart,this.onDeactivate()))},t.prototype.getEasingFunc=function(t){switch(t){case G.ElasticEaseIn:case G.ElasticEaseOut:return Y;case G.ExpoEaseIn:return Q;case G.Bounce:return Y;case G.Simple:return q}},t}(),tt=function(){function t(){this._pool=new W(function(){return new Z},10)}return t.prototype.update=function(t){for(var e=0,i=this._pool.poolObjects;e<i.length;e++){i[e].update(t)}},t.prototype.addTween=function(t,e,i,n,r,o){void 0===o&&(o=0),this._pool.get().refresh(t,e,i,n,r,o)},t}(),et=function(){function t(){}return t.getElementDataOrEmpty=function(t){var e=document.getElementById(t);return e?e.innerHTML:""},t.getTextFromUrl=function(t){return this.getResponseFromUrl(t)},t.getJSONFromUrl=function(t){return this.getTextFromUrl(t).then(function(t){return JSON.parse(t)})},t.getResponseFromUrl=function(t,e){return new Promise(function(i,n){var r=new XMLHttpRequest;r.open("get",t),void 0!==e&&(r.responseType=e),r.onload=function(){r.status>=200&&r.status<300?i(r.response):n({status:r.status,statusText:r.statusText})},r.onerror=function(){n({status:r.status,statusText:r.statusText})},r.send()})},t}();!function(t){t[t.Vertex=0]="Vertex",t[t.Fragment=1]="Fragment"}($||($={})),function(t){t[t.Vec1=0]="Vec1",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Mat4=4]="Mat4",t[t.Sampler=5]="Sampler",t[t.Int=6]="Int"}(J||(J={}));var it,nt,rt=function(){return function(t,e,i,n,r){void 0===r&&(r=function(){return null}),this.type=t,this.name=e,this.count=i,this.index=n,this.data=r}}(),ot=function(){function t(){this.shaders=[],this.uniforms=[],this.program=y.createProgram(),this.program||console.error("ShaderProgram create failed")}return t.unbind=function(){y.useProgram(null)},t.prototype.free=function(){y.deleteProgram(this.program),this.shaders.forEach(function(t){y.deleteShader(t)})},t.prototype.bind=function(){y.useProgram(this.program);for(var t=0;t<this.uniforms.length;++t)this.uniforms[t].data&&this.setUniform(t)},t.prototype.attach=function(t,e){var i=this.getWebGLShaderType(t),n=y.createShader(i);if(n)if(this.shaders.push(n),y.shaderSource(n,e),y.compileShader(n),y.getShaderParameter(n,y.COMPILE_STATUS)){if(t===$.Vertex){var r=Object.keys(M).filter(function(t){return"number"==typeof M[t]});for(var o in r)y.bindAttribLocation(this.program,parseInt(o),M[o])}y.attachShader(this.program,n)}else{console.log("ShaderProgram.attach() failed - can't compile "+t+" shader\n       InfoLog:");var s=y.getShaderInfoLog(n);console.log(s)}else console.log("ShaderProgram.attach() failed - can't create shader with type "+i+" ("+t+")")},t.prototype.link=function(){var t=this;if(y.linkProgram(this.program),!y.getProgramParameter(this.program,y.LINK_STATUS)){console.log("ShaderProgram.link() failed at link\n        InfoLog:");var e=y.getProgramInfoLog(this.program);console.log(e)}if(y.validateProgram(this.program),!y.getProgramParameter(this.program,y.VALIDATE_STATUS)){console.log("ShaderProgram.link() failed at validate\n        InfoLog:");e=y.getProgramInfoLog(this.program);console.log(e)}this.addUniform(J.Mat4,1,"uModelViewProj",function(){return m.renderParams.modelViewProjection.e}),this.addUniform(J.Vec4,1,"uColor",function(){return m.renderParams.color.asArray()}),this.shaders.forEach(function(e){return y.detachShader(t.program,e)})},t.prototype.addUniform=function(t,e,i,n){var r=y.getUniformLocation(this.program,i);if(!r)return console.log("ShaderProgram.addUniform failed - gl.getUniformLocation for "+i+" returned null (not found)"),null;var o=new rt(t,i,e,r,n);return this.uniforms.push(o)},t.prototype.getUniformIndexByName=function(t){return this.uniforms.filter(function(e){return e.name===t})[0].index||null},t.prototype.setUniform=function(t,e){var i=this.uniforms[t];switch(null!=e&&(i.data=e),i.type){case J.Vec1:y.uniform1fv(i.index,i.data());break;case J.Vec2:y.uniform2fv(i.index,i.data());break;case J.Vec3:y.uniform3fv(i.index,i.data());break;case J.Vec4:y.uniform4fv(i.index,i.data());break;case J.Mat4:y.uniformMatrix4fv(i.index,!1,i.data());break;case J.Sampler:case J.Int:y.uniform1iv(i.index,i.data())}},t.prototype.updateUniformValue=function(t,e){for(var i=-1,n=0;n<this.uniforms.length;++n)if(this.uniforms[n].name===t){i=n;break}-1!==i?this.uniforms[i].data=e:console.error("Uniform of name '"+t+"' was not found")},t.prototype.getWebGLShaderType=function(t){switch(t){case $.Vertex:return y.VERTEX_SHADER;case $.Fragment:return y.FRAGMENT_SHADER;default:return console.log("Unknown ShaderType: "+t+" at ShaderProgram.getWebGLShaderType()"),0}},t}(),st=function(){return function(t,e,i){this.texture=t,this.uniformName=e,this.shaderInternalIndex=i}}(),at=function(){function t(){this.textures=[],this.color=new F(1,1,1,1),this.blend=C.Alpha,this.depthWrite=!0,this.depthTest=!0,this.depthTestFunc=P.Less,this.cull=S.Back}return t.prototype.free=function(){},t.prototype.addTexture=function(t,e){if(this.shader){var i=this.textures.length,n=this.shader.addUniform(J.Sampler,1,e,function(){return[i]});null!==n?this.textures.push(new st(t,e,n)):console.error("Material.addTexture() failed - can't determine shader index for '"+e+"'")}else console.error("Material.addTexture() failed - no shader at material")},t.prototype.bind=function(){m.setBlendingMode(this.blend),m.setCullMode(this.cull),m.setDepthWrite(this.depthWrite),m.setDepthTest(this.depthTest),m.setDepthFunc(this.depthTestFunc),m.renderParams.color=this.color,this.textures.forEach(function(t,e){t.texture.bind(e)}),this.shader&&this.shader.bind()},t.prototype.unbind=function(){ot.unbind()},t}(),ht=function(){function t(){this.positions=[new l,new l,new l,new l],this.texCoords=[new f,new f,new f,new f],this.colors=[new F(1,1,1,1),new F(1,1,1,1),new F(1,1,1,1),new F(1,1,1,1)]}return t.prototype.toArray=function(){return[this.positions[0].x,this.positions[0].y,this.positions[0].z,this.texCoords[0].x,this.texCoords[0].y,this.colors[0].x,this.colors[0].y,this.colors[0].z,this.colors[0].w,this.positions[1].x,this.positions[1].y,this.positions[1].z,this.texCoords[1].x,this.texCoords[1].y,this.colors[1].x,this.colors[1].y,this.colors[1].z,this.colors[1].w,this.positions[2].x,this.positions[2].y,this.positions[2].z,this.texCoords[2].x,this.texCoords[2].y,this.colors[2].x,this.colors[2].y,this.colors[2].z,this.colors[2].w,this.positions[3].x,this.positions[3].y,this.positions[3].z,this.texCoords[3].x,this.texCoords[3].y,this.colors[3].x,this.colors[3].y,this.colors[3].z,this.colors[3].w]},t}(),ut=function(){function t(){this.fontData={},this.material=new at,this.maxSymbolHeight=0}return t.prototype.getSymbolQuad=function(t,e){var i=new ht,n=this.fontData[t];return n?(i.positions[0].set(n.width,n.startY+n.height,0).multiplyNumSelf(e),i.positions[1].set(n.width,n.startY,0).multiplyNumSelf(e),i.positions[2].set(0,n.startY,0).multiplyNumSelf(e),i.positions[3].set(0,n.startY+n.height,0).multiplyNumSelf(e),i.texCoords[0].set(n.tx+n.tw,n.ty+n.th),i.texCoords[1].set(n.tx+n.tw,n.ty),i.texCoords[2].set(n.tx,n.ty),i.texCoords[3].set(n.tx,n.ty+n.th),i):i},t.prototype.hasFontData=function(t){return!!this.fontData[t]},t.prototype.getTextLength=function(t,e){void 0===e&&(e=!0);for(var i,n=0,r=0,o=t;r<o.length;r++){var s=o[r];n+=(i=this.fontData[s])?i.width:0}return e&&(n+=this.fontData[" "].width),n},t}(),ct=function(){function t(){}return t.prototype.load=function(t,e,i,n,r){return new Promise(function(o,s){var a=new ut;et.getResponseFromUrl(t.fontFileSrc,"json").then(function(s){for(var h=0,u=s;h<u.length;h++){var c=u[h];a.fontData[c.symbol]=c,c.height>a.maxSymbolHeight&&(a.maxSymbolHeight=c.height)}t.material?(a.material=t.material,o(a)):t.materialData&&e.load(t.materialData,i,n,r).then(function(t){return a.material=t}).then(function(){return o(a)})})})},t}(),lt=function(){function t(){}return t.prototype.load=function(t,e,i,n){return new Promise(function(r,o){if(!t.shaderProgram&&!t.shaderProgramData)throw new Error("Can't create material - no shader or shader data provided");var s=new at;s.blend=t.blend,s.color=t.color,s.cull=t.cull,s.depthTest=t.depthTest,s.depthTestFunc=t.depthTestFunc,s.depthWrite=t.depthWrite,(t.shaderProgram?new Promise(function(e,i){return e(t.shaderProgram)}):e.load(t.shaderProgramData)).then(function(t){return s.shader=t}).then(function(){for(var e=[],o=function(t){if(t.texture)s.addTexture(t.texture,t.uniformName);else if(t.textureAtlas)s.addTexture(t.textureAtlas,t.uniformName);else if(t.textureData){var r=i.load(t.textureData).then(function(e){return s.addTexture(e,t.uniformName)});e.push(r)}else{if(!t.textureAtlasData)throw new Error("Can't add texture with uniformName '"+t.uniformName+"'\n                 to material - no texture or texture data provided");r=n.load(t.textureAtlasData).then(function(e){return s.addTexture(e,t.uniformName)});e.push(r)}},a=0,h=t.textures;a<h.length;a++){o(h[a])}Promise.all(e).then(function(){return r(s)})})})},t}(),pt=function(){function t(){}return t.prototype.load=function(t){return new Promise(function(e,i){var n=new ot;n.attach($.Vertex,t.vertexShaderText),n.attach($.Fragment,t.fragmentShaderText),n.link(),e(n)})},t}(),ft=function(){function t(){this._audioContext=new AudioContext}return t.prototype.load=function(t){var e=this;return et.getResponseFromUrl(t.soundFileSrc,"arraybuffer").then(function(t){return e._audioContext.decodeAudioData(t)})},t}(),dt=function(){function t(){if(this.width=1,this.height=1,this.texture=y.createTexture(),null!==this.texture){y.bindTexture(y.TEXTURE_2D,this.texture);var t=new Uint8Array([255,255,255,255]);y.texImage2D(y.TEXTURE_2D,0,y.RGBA,1,1,0,y.RGBA,y.UNSIGNED_BYTE,t)}else console.log("Texture create failed - null returned")}return t.unbind=function(){m.setTexture(null,0)},t.prototype.free=function(){y.deleteTexture(this.texture)},t.prototype.setWrap=function(t,e){y.bindTexture(y.TEXTURE_2D,this.texture),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,this.getWebGLWrap(t)),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,this.getWebGLWrap(e))},t.prototype.setFilter=function(t){y.bindTexture(y.TEXTURE_2D,this.texture),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,this.getWebGLFilter(t)),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,this.getWebGLFilter(t))},t.prototype.bind=function(t){void 0===t&&(t=0),m.setTexture(this,t)},t.prototype.loadFromImage=function(t){this.width=t.width,this.height=t.height,y.bindTexture(y.TEXTURE_2D,this.texture),y.texImage2D(y.TEXTURE_2D,0,y.RGBA,y.RGBA,y.UNSIGNED_BYTE,t),s(t.width)&&s(t.height)?y.generateMipmap(y.TEXTURE_2D):(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,y.LINEAR),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,y.LINEAR))},t.prototype.trySetAnisotropic=function(t){var e=y.getExtension("EXT_texture_filter_anisotropic")||y.getExtension("MOZ_EXT_texture_filter_anisotropic")||y.getExtension("WEBKIT_EXT_texture_filter_anisotropic");if(e){var i=y.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT),n=Math.min(t,i);y.texParameterf(y.TEXTURE_2D,e.TEXTURE_MAX_ANISOTROPY_EXT,n)}},t.prototype.getWebGLWrap=function(t){switch(t){case x.Repeat:return y.REPEAT;case x.MirrorRepeat:return y.MIRRORED_REPEAT;default:case x.ClampToEdge:return y.CLAMP_TO_EDGE}},t.prototype.getWebGLFilter=function(t){switch(t){case b.Linear:return y.LINEAR;default:case b.Nearest:return y.NEAREST}},t}(),yt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),mt=(function(){}(),/(.*?)\t(\d*?)\t(\d*?)\t(\d*?)\t(\d*?)\t(\d*?)\t(\d*?)\t(\d*?)\t(\d*?)\t([r]?)/),gt=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._regions=[],e}return yt(e,t),e.prototype.free=function(){t.prototype.free.call(this)},e.prototype.getRegion=function(t){var e=this._regions.filter(function(e){return e.name===t});return 0===e.length?console.error("Can't find region '"+t+"'"):e.length>1&&console.error("Too many regions ("+e.length+") with name '"+t+"'"),e[0]},e.prototype.loadRegionInfo=function(t){for(var e=0,i=t.split("\n").slice(1);e<i.length;e++){var n=i[e];if(n&&0!==n.length){var r=mt.exec(n);r?this._regions.push({texture:this,name:r[1],tx:parseInt(r[2])/this.width,ty:parseInt(r[3])/this.height,tw:parseInt(r[4])/this.width,th:parseInt(r[5])/this.height,rotated:r.length>10&&"r"===r[10]}):console.error("TextureAtlas - can't parse line '"+n+"'")}}},e}(dt),vt=function(){function t(){}return t.prototype.load=function(t){return new Promise(function(e,i){var n=new gt,r=new Image;r.onload=function(o){n.loadFromImage(r),n.setFilter(t.filter),t.anisotropic>0&&n.trySetAnisotropic(t.anisotropic),console.log("Texture '"+t.imageFileSrc+"' loaded, width: "+r.width+", height: "+r.height),et.getTextFromUrl(t.atlasFileSrc).then(function(t){n.loadRegionInfo(t),e(n)}).catch(function(t){return i(t)})},r.onerror=function(t){return i(t)},r.src=t.imageFileSrc})},t}(),wt=function(){function t(){}return t.prototype.load=function(t){return new Promise(function(e,i){var n=new dt,r=new Image;r.onload=function(i){n.loadFromImage(r),n.setFilter(t.filter),t.anisotropic>0&&n.trySetAnisotropic(t.anisotropic),console.log("Texture '"+t.imageFileSrc+"' loaded, width: "+r.width+", height: "+r.height),e(n)},r.onerror=function(t){return i(t)},r.src=t.imageFileSrc})},t}(),xt=function(){function t(){this._textureLoader=new wt,this._textureAtlasLoader=new vt,this._shaderLoader=new pt,this._materialLoader=new lt,this._soundLoader=new ft,this._fontLoader=new ct}return t.prototype.loadTexture=function(t){return this._textureLoader.load(t)},t.prototype.loadTextureAtlas=function(t){return this._textureAtlasLoader.load(t)},t.prototype.loadShaderProgram=function(t){return this._shaderLoader.load(t)},t.prototype.loadMaterial=function(t){return this._materialLoader.load(t,this._shaderLoader,this._textureLoader,this._textureAtlasLoader)},t.prototype.loadSound=function(t){return this._soundLoader.load(t)},t.prototype.loadFont=function(t){return this._fontLoader.load(t,this._materialLoader,this._shaderLoader,this._textureLoader,this._textureAtlasLoader)},t}(),bt=function(){function t(){this.matrix=new O,this.position=new l(0,0,0),this.visible=!0,this._dir=new l(0,0,0),this._right=new l(0,0,0),this._up=new l(0,0,0),this._parent=null,this._absoluteMatrix=new O,this.matrix.identity(),this.parent=null,this.updateVectorsFromMatrix()}return Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},set:function(t){this._parent!==t&&(this._parent=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"up",{get:function(){return this._up},set:function(t){if(t!==this._up){t.normalize();var e=t.cross(this._dir).negate().normalize(),i=e.cross(this._up).normalize();this.updateModelMatrix(i,t,e)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"direction",{get:function(){return this._dir},set:function(t){if(t!==this._dir){t.normalize();var e=this._up.cross(t).negate().normalize(),i=t.cross(e).normalize();this.updateModelMatrix(t,i,e)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._right},set:function(t){if(t!==this._right){t.normalize();var e=t.cross(this._up).normalize(),i=e.cross(t).normalize();this.updateModelMatrix(e,i,t)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"absoluteMatrix",{get:function(){return this.matrix.position=this.position,this._absoluteMatrix=null===this._parent?this.matrix:this._parent.absoluteMatrix.multiplyMat(this.matrix),this._absoluteMatrix},set:function(t){this._absoluteMatrix=t},enumerable:!0,configurable:!0}),t.prototype.free=function(){},t.prototype.renderSelf=function(){m.renderParams.model=this.absoluteMatrix,m.renderParams.calculateMVP(),this.updateVectorsFromMatrix(),this.visible&&this.doRender()},t.prototype.updateModelMatrix=function(t,e,i){this.matrix.e=[i.x,e.x,t.x,0,i.y,e.y,t.y,0,i.z,e.z,t.z,0,this.position.dot(i),this.position.dot(e),this.position.dot(t)],this._dir=t,this._up=e,this._right=i},t.prototype.updateVectorsFromMatrix=function(){this._right.set(this.matrix.e[0],this.matrix.e[4],this.matrix.e[8]),this._up.set(this.matrix.e[1],this.matrix.e[5],this.matrix.e[9]),this._dir.set(this.matrix.e[2],this.matrix.e[6],this.matrix.e[10])},t.prototype.doRender=function(){},t}(),_t=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(t){t[t.Ortho=0]="Ortho",t[t.Perspective=1]="Perspective"}(it||(it={})),function(t){t[t.TopLeft=0]="TopLeft",t[t.Center=1]="Center",t[t.BottomRight=2]="BottomRight"}(nt||(nt={}));var Tt,Mt=function(t){function e(){var e=t.call(this)||this;return e.projectionMatrix=new O,e._scale=1,e.setProjectionParamsFull(0,0,m.width,m.height,45,.01,100,it.Ortho,nt.TopLeft),e.setViewParams(new l(0,0,100),new l(0,0,0),new l(0,1,0)),e}return _t(e,t),Object.defineProperty(e.prototype,"scale",{get:function(){return this._scale},set:function(t){t!==this._scale&&(this._scale=t,this.rebuildProjectionMatrix())},enumerable:!0,configurable:!0}),e.prototype.setProjectionParams=function(t,e,i,n){i=i<0?1:i,n=n<0?1:n,this._x=t,this._y=e,this._width=i,this._height=n,this.rebuildProjectionMatrix()},e.prototype.setProjectionParamsFull=function(t,e,i,n,r,o,s,a,h){this._fov=r,this._zNear=o,this._zFar=s,this._projectionMode=a,this._pivotMode=h,this.setProjectionParams(t,e,i,n)},e.prototype.setViewParams=function(t,e,i){this.matrix.identity(),this._up=i.normal(),this._dir=e.subtract(t).normal(),this._right=this._dir.cross(this._up).normal(),this._up=this._right.cross(this._dir).normal(),this.position=t,this._dir.negate(),this.matrix.e=[this._right.x,this._right.y,this._right.z,this._right.negateVector().dot(this.position),this._up.x,this._up.y,this._up.z,this._up.negateVector().dot(this.position),this._dir.x,this._dir.y,this._dir.z,this._dir.negateVector().dot(this.position),0,0,0,1],this.matrix=this.matrix.transpose(),this.updateVectorsFromMatrix()},e.prototype.translate=function(t,e,i){var n=this._up.multiplyNum(t).add(this._right.multiplyNum(e)).add(this._dir.multiplyNum(i));this.position.addToSelf(n)},e.prototype.rotate=function(t,e){this.matrix.rotate(t,e),this.updateVectorsFromMatrix()},e.prototype.screenToWorld=function(t){if(this._projectionMode===it.Perspective)return console.error("Camera.ScreenToWorld() with perpective camera is not implemented"),new l(0,0,0);var e=(new f).set(this.position).addToSelf(t.multiplyNum(1/this._scale)),i=new f(0,0);switch(this._pivotMode){case nt.Center:i.set(this._width/(2*this._scale),this._height/(2*this._scale));break;case nt.BottomRight:i.set(this._width/this._scale,this._height/this._scale)}return e.subtractFromSelf(i),new l(e.x,e.y,0)},e.prototype.renderSelf=function(){},e.prototype.update=function(){this.matrix.position=new l(0,0,0),this.matrix.position=this.matrix.multiplyVec(this.position.negateVector()),m.renderParams.viewProjection=this.projectionMatrix.multiplyMat(this.matrix),m.renderParams.modelViewProjection=m.renderParams.viewProjection,this.updateVectorsFromMatrix(),m.width===this._width&&m.height===this._height||this.setProjectionParams(0,0,m.width,m.height)},e.prototype.rebuildProjectionMatrix=function(){switch(this.projectionMatrix.identity(),this._projectionMode){case it.Perspective:this.projectionMatrix.perspective(this._fov,this._width/this._height,this._zNear,this._zFar);break;case it.Ortho:var t=2*this._scale;switch(this._pivotMode){case nt.TopLeft:this.projectionMatrix.ortho(0,this._width/this._scale,this._height/this._scale,0,this._zNear,this._zFar);break;case nt.Center:this.projectionMatrix.ortho(-this._width/t,this._width/t,this._height/t,-this._height/t,this._zNear,this._zFar);break;case nt.BottomRight:this.projectionMatrix.ortho(-this._width/t,0,0,-this._height/t,this._zNear,this._zFar)}}},e}(bt),Ct={textures:[{uniformName:"uDiffuse"}],color:new F(1,1,1,1),blend:C.Alpha,depthWrite:!0,depthTest:!0,depthTestFunc:P.Less,cull:S.Back},St={vertexShaderText:"\n  attribute vec3 vaCoord;\n  attribute vec2 vaTexCoord0;\n  attribute vec4 vaColor;\n  varying vec2 texCoord0;\n  varying vec4 vColor;\n  uniform mat4 uModelViewProj;\n\n  void main(void)\n  {\n    texCoord0 = vaTexCoord0;\n    vColor = vaColor;\n    gl_Position = uModelViewProj * vec4(vaCoord, 1.0);\n  }\n  ",fragmentShaderText:"\n  varying highp vec2 texCoord0;\n  varying highp vec4 vColor;\n  uniform sampler2D uDiffuse;\n  uniform highp vec4 uColor;\n\n  void main(void)\n  {\n    gl_FragColor = uColor * vColor * texture2D( uDiffuse, texCoord0 );\n    if (gl_FragColor.a < 0.001)\n      discard;\n  }\n  "},Pt={fontFileSrc:"assets/font.json",materialData:{textures:[{uniformName:"uDiffuse",textureData:{anisotropic:0,filter:b.Linear,imageFileSrc:"assets/font.png"}}],color:new F(1,1,1,1),blend:C.Alpha,depthWrite:!0,depthTest:!0,depthTestFunc:P.Less,cull:S.Back}},kt={imageFileSrc:"assets/atlas.png",atlasFileSrc:"assets/atlas.atlas",filter:b.Nearest,anisotropic:0},At={imageFileSrc:"assets/planet.png",atlasFileSrc:"assets/planet.atlas",filter:b.Nearest,anisotropic:0},Et=function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{h(n.next(t))}catch(t){o(t)}}function a(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){t.done?r(t.value):new i(function(e){e(t.value)}).then(s,a)}h((n=n.apply(t,e||[])).next())})},Dt=function(t,e){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},Bt=function(){function t(){this.loaders=new xt}return t.prototype.loadAll=function(){return Et(this,void 0,void 0,function(){var t,e,i,n,r,o,s;return Dt(this,function(a){switch(a.label){case 0:return this.gameCamera=new Mt,this.guiCamera=new Mt,t=this,[4,this.loaders.loadShaderProgram(St)];case 1:return t.shader=a.sent(),Ct.shaderProgram=this.shader,Ct.textures[0].texture=new dt,Pt.materialData.shaderProgram=this.shader,e=this,[4,this.loaders.loadMaterial(Ct)];case 2:return e.blankMaterial=a.sent(),i=this,[4,this.loaders.loadFont(Pt)];case 3:return i.font=a.sent(),n=this,[4,this.loaders.loadTextureAtlas(kt)];case 4:return n.solarAtlas=a.sent(),Ct.textures[0].texture=void 0,Ct.textures[0].textureAtlas=this.solarAtlas,r=this,[4,this.loaders.loadMaterial(Ct)];case 5:return r.solarMaterial=a.sent(),o=this,[4,this.loaders.loadTextureAtlas(At)];case 6:return o.planetAtlas=a.sent(),Ct.textures[0].textureAtlas=this.planetAtlas,s=this,[4,this.loaders.loadMaterial(Ct)];case 7:return s.planetMaterial=a.sent(),[2,Promise.resolve()]}})})},t}(),Ot={actionManager:new X,tweener:new tt,assets:new Bt},Ft=function(){function t(t,e,i,n){var r=this;this.material=t,this.spriteBatch=e,this.textBatch=i,this.camera=n,this.enabled=!0,this.elements={},this.inputEventsSubscription=v.events.subscribe(function(t){return r.processInput(t)})}return t.prototype.free=function(){this.inputEventsSubscription.unsubscribe()},t.prototype.update=function(t){if(this.enabled)for(var e in this.elements){var i=this.elements[e];i.enabled&&i.update(t)}},t.prototype.render=function(){if(this.enabled){for(var t in this.material.bind(),this.spriteBatch.start(),this.textBatch.start(),this.elements){var e=this.elements[t];e.visible&&e.render(this.spriteBatch,this.textBatch)}this.spriteBatch.finish(),this.textBatch.finish()}},t.prototype.processInput=function(t){if(this.enabled)for(var e in this.elements){var i=this.elements[e];if(i.enabled&&i.visible)(!(-1!==[c.KeyDown,c.KeyUp,c.Wheel].indexOf(t.inputType))||i.focused)&&i.processInput(t)}},t.prototype.addElement=function(t){if(void 0!==this.elements[t.name])throw new Error("Element with name '"+t.name+"' already exists in GuiManager");this.elements[t.name]=t},t.prototype.removeElement=function(t){delete this.elements[t.name]},t.prototype.getElement=function(t){return this.elements[t]},t}(),Rt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),It=function(t){function e(e,i,n){var r=t.call(this)||this;return r.vertices=new Array(36),r._rotation=0,r._textureRegion=null,r._width=e||1,r._height=i||1,r._pivotPoint=n||new f(.5,.5),r.setDefaultVertices(),r.setDefaultTexCoords(),r.setVerticesColor(new F(1,1,1,1)),r}return Rt(e,t),e.getVerticesSize=function(){return 36},e.prototype.free=function(){t.prototype.free.call(this)},Object.defineProperty(e.prototype,"rotation",{get:function(){return this._rotation},set:function(t){a(this._rotation,t)||(this.matrix.identity(),this.matrix.rotate(t*o.deg2rad,p),this._rotation=t,this._rotation>360?this._rotation-=360:this._rotation<-360&&(this._rotation+=360))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(t){a(this._width,t)||(this._width=t,this.setDefaultVertices())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},set:function(t){a(this._height,t)||(this._height=t,this.setDefaultVertices())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pivotPoint",{get:function(){return this._pivotPoint},set:function(t){this._pivotPoint.equalTo(t)||(this._pivotPoint.set(t.x,t.y),this.setDefaultVertices())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return new f(this.width,this.height)},enumerable:!0,configurable:!0}),e.prototype.setDefaultVertices=function(){this.vertices[0]=(1-this.pivotPoint.x)*this._width,this.vertices[1]=(1-this.pivotPoint.y)*this._height,this.vertices[2]=0,this.vertices[9]=(1-this.pivotPoint.x)*this._width,this.vertices[10]=(0-this.pivotPoint.y)*this._height,this.vertices[11]=0,this.vertices[18]=(0-this.pivotPoint.x)*this._width,this.vertices[19]=(0-this.pivotPoint.y)*this._height,this.vertices[20]=0,this.vertices[27]=(0-this.pivotPoint.x)*this._width,this.vertices[28]=(1-this.pivotPoint.y)*this._height,this.vertices[29]=0},e.prototype.setDefaultTexCoords=function(){this.vertices[3]=1,this.vertices[4]=1,this.vertices[12]=1,this.vertices[13]=0,this.vertices[21]=0,this.vertices[22]=0,this.vertices[30]=0,this.vertices[31]=1},e.prototype.setFlippedTexCoords=function(){this.vertices[3]=1,this.vertices[4]=0,this.vertices[12]=1,this.vertices[13]=1,this.vertices[21]=0,this.vertices[22]=1,this.vertices[30]=0,this.vertices[31]=0},e.prototype.flipVerticallyCurrentTexCoords=function(){var t=0;t=this.vertices[30],this.vertices[30]=this.vertices[3],this.vertices[3]=t,t=this.vertices[12],this.vertices[12]=this.vertices[21],this.vertices[21]=t},e.prototype.flipHorizontallyCurrentTexCoords=function(){var t=0;t=this.vertices[4],this.vertices[4]=this.vertices[13],this.vertices[13]=t,t=this.vertices[22],this.vertices[22]=this.vertices[31],this.vertices[31]=t},e.prototype.setVerticesColor=function(t,e,i,n){if(t instanceof F)this.setVerticesColor(t.x,t.y,t.z,t.w);else{if(null==e||null==i||null==n)throw new Error("Not all args passed");for(var r=5;r<33;r+=9)this.vertices[r+0]=t,this.vertices[r+1]=e,this.vertices[r+2]=i,this.vertices[r+3]=n}},e.prototype.setVerticesAlpha=function(t){this.vertices[8]=t,this.vertices[17]=t,this.vertices[26]=t,this.vertices[35]=t},e.prototype.setSize=function(t,e){a(this._width,t)&&a(this._height,e)||(this._width=t,this._height=e,this.setDefaultVertices())},e.prototype.setSizeFromVector2=function(t){this.setSize(t.x,t.y)},e.prototype.multSize=function(t){this.setSize(this._width*t,this._height*t)},e.prototype.setTextureRegion=function(t,e){void 0===e&&(e=!0),this._textureRegion=t,t.rotated?(this.vertices[3]=t.tx,this.vertices[4]=t.ty+t.th,this.vertices[12]=t.tx+t.tw,this.vertices[13]=t.ty+t.th,this.vertices[21]=t.tx+t.tw,this.vertices[22]=t.ty,this.vertices[30]=t.tx,this.vertices[31]=t.ty,e&&this.setSize(t.th*t.texture.height,t.tw*t.texture.width)):(this.vertices[3]=t.tx+t.tw,this.vertices[4]=t.ty+t.th,this.vertices[12]=t.tx+t.tw,this.vertices[13]=t.ty,this.vertices[21]=t.tx,this.vertices[22]=t.ty,this.vertices[30]=t.tx,this.vertices[31]=t.ty+t.th,e&&this.setSize(t.tw*t.texture.width,t.th*t.texture.height))},e.prototype.setTextureCoords=function(t){this.vertices[3]=t[0],this.vertices[4]=t[1],this.vertices[12]=t[2],this.vertices[13]=t[3],this.vertices[21]=t[4],this.vertices[22]=t[5],this.vertices[30]=t[6],this.vertices[31]=t[7]},e.prototype.getTextureRegion=function(){return this._textureRegion},e.prototype.getVerticesWithAbsoluteMatrix=function(){for(var t=this.absoluteMatrix,e=[new l(this.vertices[0],this.vertices[1],this.vertices[2]),new l(this.vertices[9],this.vertices[10],this.vertices[11]),new l(this.vertices[18],this.vertices[19],this.vertices[20]),new l(this.vertices[27],this.vertices[28],this.vertices[29])],i=0;i<e.length;++i)e[i]=t.multiplyVec(e[i]);var n=this.vertices.slice();return n[0]=e[0].x,n[1]=e[0].y,n[2]=e[0].z,n[9]=e[1].x,n[10]=e[1].y,n[11]=e[1].z,n[18]=e[2].x,n[19]=e[2].y,n[20]=e[2].z,n[27]=e[3].x,n[28]=e[3].y,n[29]=e[3].z,n},e.prototype.renderSelf=function(){},e}(bt),Vt={background:{},buttons:[{name:"ContinueButton",labelText:"Продолжить",labelColor:new F(1,1,1,1),labelScale:1,size:new f(150,40),position:new l(480,618,49),pivotPoint:new f(.5,.5),verticesColor:new F(.8,.8,.8,1),hoverVerticesColor:new F(1,1,1,1),textureRegion:{name:"button_green.png",adjustSize:!0}}]},zt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(Tt||(Tt={}));var Nt,Lt,Ut,jt=function(t){function e(e){void 0===e&&(e="");var i=t.call(this)||this;return i.text=e,i.lineSpacing=2,i.letterSpacing=0,i.color=new F(1,1,1,1),i.scale=1,i.shadowEnabled=!1,i.shadowOffset=new f(0,0),i.shadowColor=new F(0,0,0,.5),i.pivotPoint=new f(0,0),i.horizontalAlignment=Tt.Left,i._maxTextWidth=0,i._isWrapped=!0,i}return zt(e,t),e.prototype.free=function(){t.prototype.free.call(this)},Object.defineProperty(e.prototype,"maxTextWidth",{get:function(){return this._maxTextWidth},set:function(t){a(this._maxTextWidth,t)||(this._maxTextWidth=t,this._isWrapped=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isWrapped",{get:function(){return this._isWrapped},set:function(t){this._isWrapped=t},enumerable:!0,configurable:!0}),e.prototype.renderSelf=function(){},e}(bt),Ht=function(){function t(t){var e=Ot.assets.planetAtlas.getRegion("blank.png");this.background=new It(m.width-20,t,new f(.5,.5)),this.background.position.set(m.width/2,this.background.height/2+10,40),this.background.setVerticesColor(1,1,1,.3),this.background.setTextureRegion(e,!1),this.text=new jt,this.text.pivotPoint.set(.5,.5),this.text.parent=this.background,this.text.color.set(1,1,1,1),this.text.maxTextWidth=this.background.width-10,this.text.isWrapped=!0,this.text.position.set(0,0,45)}return t.prototype.getSpritesToRender=function(){return[this.background]},t.prototype.getTextsToRender=function(){return[this.text]},t}(),Wt=function(){function t(t,e){void 0===t&&(t=new f),void 0===e&&(e=new f),this.center=t,this.halfSize=new f(e.x/2,e.y/2)}return t.prototype.overlaps=function(e){return e instanceof t?!(Math.abs(this.center.x-e.center.x)>this.halfSize.x+e.halfSize.x)&&!(Math.abs(this.center.y-e.center.y)>this.halfSize.y+e.halfSize.y):e.overlaps(this)},t.prototype.hit=function(t){return!(Math.abs(this.center.x-t.x)>this.halfSize.x)&&!(Math.abs(this.center.y-t.y)>this.halfSize.y)},t}(),Gt=function(){},Kt=function(){function t(){this.name="Element_"+t.defaultNameIncrementNumber++,this.focused=!1,this.enabled=!0,this.visible=!0,this.onClick=Gt,this.onTouchDown=Gt,this.onTouchUp=Gt,this.onTouchMove=Gt,this.onMouseOver=Gt,this.onMouseOut=Gt,this.onEnable=Gt,this.onFocus=Gt,this.zIndex=0,this.hitBox=new Wt,this._isMouseOver=!1}return t.prototype.processInput=function(t){var e=!1;switch(t.inputType){case c.TouchDown:e=this.hitBox.hit(new f(t.x,t.y)),this.focused=e,e&&this.onTouchDown(this,t);break;case c.TouchUp:if(!(e=this.hitBox.hit(new f(t.x,t.y))))break;this.onTouchUp(this,t),this.focused&&this.onClick(this,t);break;case c.TouchMove:if(e=this.hitBox.hit(new f(t.x,t.y))){if(this.onTouchMove(this,t),this._isMouseOver)break;this._isMouseOver=!0,this.onMouseOver(this,t)}else{if(!this._isMouseOver)break;this._isMouseOver=!1,this.onMouseOut(this,t)}}},t.defaultNameIncrementNumber=0,t}(),Xt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Qt=function(t){function e(){var e=t.call(this)||this;return e.hitBox=new Wt,e.sprite=new It,e.label=new jt("Button"),e.label.pivotPoint.set(.5,.5),e.label.parent=e.sprite,e}return Xt(e,t),e.prototype.render=function(t,e){t.drawSingle(this.sprite),this.label.position.z=this.sprite.position.z+1,e.drawSingle(this.label)},e.prototype.update=function(t){},e.prototype.updateHitBox=function(){this.hitBox.center.set(.5,.5).subtractFromSelf(this.sprite.pivotPoint).multiplyVecSelf(this.sprite.width,this.sprite.height).addToSelf(this.sprite.absoluteMatrix.position),this.hitBox.halfSize.set(this.sprite.width/2,this.sprite.height/2)},e}(Kt),Yt=function(){function t(){}return t.loadMenu=function(t,e){e.buttons.forEach(function(e){var i=new Qt;if(i.name=e.name,i.sprite.setSize(e.size.x,e.size.y),i.sprite.position.set(e.position),i.sprite.setVerticesColor(e.verticesColor),i.sprite.pivotPoint.set(e.pivotPoint),i.sprite.setDefaultVertices(),i.label.color.set(e.labelColor),i.label.text=e.labelText,i.label.scale=e.labelScale,null!=e.labelPosition&&i.label.position.set(e.labelPosition),null!=e.labelPivot&&i.label.pivotPoint.set(e.labelPivot),null!=e.textureRegion){var n=t.material.textures[0].texture;if(null!=n){var r=n.getRegion(e.textureRegion.name);i.sprite.setTextureRegion(r,e.textureRegion.adjustSize)}}i.updateHitBox(),i.onMouseOver=function(t,i){return t.sprite.setVerticesColor(e.hoverVerticesColor)},i.onMouseOut=function(t,i){return t.sprite.setVerticesColor(e.verticesColor)},t.addElement(i)})},t}(),qt=[0,1,2,2,3,0],$t=It.getVerticesSize(),Jt=function(){function t(){this._count=0,this._changed=!1,this._vertexData=new Array(65536),this._indexData=new Array(65536),this._vertexBuffer=new I(_.Pos3Tex2Col4,65536),this._indexBuffer=new B(T.Short,65536)}return t.prototype.free=function(){this._vertexBuffer.free(),this._indexBuffer.free()},t.prototype.start=function(){this._count=0},t.prototype.finish=function(){0!==this._count&&(this._changed&&(this._vertexBuffer.update(this._vertexData,0),this._indexBuffer.update(this._indexData,0)),m.renderParams.modelViewProjection=m.renderParams.viewProjection,m.drawTriangles(this._vertexBuffer,this._indexBuffer,0,6*this._count))},t.prototype.drawSingle=function(t){if(t.visible){for(var e=t.getVerticesWithAbsoluteMatrix(),i=0;i<$t;++i)this._vertexData[this._count*$t+i]=e[i];for(i=0;i<6;++i)this._indexData[6*this._count+i]=qt[i]+4*this._count;++this._count,this._changed=!0}},t.prototype.drawArray=function(t){var e=this;t.forEach(function(t){return e.drawSingle(t)})},t}(),Zt=[0,1,2,2,3,0],te=function(){function t(t){this.font=t,this._count=0,this._changed=!1,this._vertexData=new Array(65536),this._indexData=new Array(65536),this._textOrigin=new f,this._start=new f,this._vertexBuffer=new I(_.Pos3Tex2Col4,65536),this._indexBuffer=new B(T.Short,65536)}return t.prototype.free=function(){this._vertexBuffer.free(),this._indexBuffer.free()},t.prototype.start=function(){this._count=0},t.prototype.finish=function(){0!==this._count&&(this._changed&&(this._vertexBuffer.update(this._vertexData,0),this._indexBuffer.update(this._indexData,0)),this.font.material.bind(),m.renderParams.modelViewProjection=m.renderParams.viewProjection,m.drawTriangles(this._vertexBuffer,this._indexBuffer,0,6*this._count))},t.prototype.drawSingle=function(t){if(t.visible&&""!==t.text){t.maxTextWidth>0&&t.isWrapped&&this.wrapText(t),t.shadowEnabled&&this.drawShadow(t),this.calculateTextOrigin(t),this._start.set(this._textOrigin);for(var e=0,i=t.text;e<i.length;e++){var n=i[e];if("\n"!==n){if(this.font.hasFontData(n)){for(var r=this.font.getSymbolQuad(n,t.scale),o=r.positions[0].x,s=0;s<4;++s)r.positions[s].addToSelf(this._start),r.positions[s].multiplyMatSelf(t.absoluteMatrix),r.colors[s].set(t.color);for(var a=r.toArray(),h=0;h<36;++h)this._vertexData[36*this._count+h]=a[h];for(h=0;h<6;++h)this._indexData[6*this._count+h]=Zt[h]+4*this._count;this._start.x+=o+t.letterSpacing,++this._count,this._changed=!0}}else this._start.x=this._textOrigin.x,this._start.y+=t.scale*(t.lineSpacing+this.font.maxSymbolHeight)}}},t.prototype.drawArray=function(t){var e=this;t.forEach(function(t){return e.drawSingle(t)})},t.prototype.wrapText=function(t){for(var e=[],i=t.text.replace(/\s+/gm," ").split(/\s/gm),n=t.maxTextWidth,r=0,o=i;r<o.length;r++){var s=o[r],a=this.font.getTextLength(s,!0)*t.scale;a<n?(e.push(s+" "),n-=a):(e.push("\n"),e.push(s+" "),n=t.maxTextWidth-a)}t.isWrapped=!0,t.text=e.join("")},t.prototype.drawShadow=function(t){var e=(new l).set(t.position),i=(new F).set(t.color);t.position.addToSelf(t.shadowOffset),t.position.z-=1,t.color.set(t.shadowColor),t.shadowEnabled=!1,this.drawSingle(t),t.position.set(e),t.color.set(i),t.shadowEnabled=!0},t.prototype.calculateTextOrigin=function(t){for(var e=0,i=new f,n=0,r=t.text;n<r.length;n++){var o=r[n];if("\n"!==o){if(this.font.hasFontData(o)){var s=this.font.fontData[o];i.y<1&&s.height>0&&(i.y=this.font.maxSymbolHeight+t.lineSpacing),e+=s.width+t.letterSpacing}}else i.y+=this.font.maxSymbolHeight+t.lineSpacing,e>i.x&&(i.x=e),e=0}i.x=Math.max(i.x,e),i.multiplyNumSelf(t.scale),this._textOrigin.set(i).multiplyNumSelf(-1).multiplyVecSelf(t.pivotPoint)},t}(),ee=function(){function t(t,e){this.spriteMaterial=e,this.spriteBatch=new Jt,this.textBatch=new te(t)}return t.prototype.render=function(t){var e=this;this.spriteMaterial.bind(),this.spriteBatch.start(),this.textBatch.start(),t.forEach(function(t){e.spriteBatch.drawArray(t.getSpritesToRender()),e.textBatch.drawArray(t.getTextsToRender())}),this.spriteBatch.finish(),this.textBatch.finish()},t.prototype.free=function(){this.spriteBatch.free(),this.textBatch.free()},t}();!function(t){t[t.Heal=0]="Heal",t[t.MoreAttackCount=1]="MoreAttackCount",t[t.MoreProtectCount=2]="MoreProtectCount",t[t.IncreaseCriticalChance=3]="IncreaseCriticalChance"}(Nt||(Nt={})),function(t){t[t.Weapon=0]="Weapon",t[t.Shield=1]="Shield",t[t.Engine=2]="Engine",t[t.Misc=3]="Misc",t[t.Consumable=4]="Consumable"}(Lt||(Lt={})),function(t){t[t.Usual=0]="Usual",t[t.Special=1]="Special",t[t.Legendary=2]="Legendary"}(Ut||(Ut={}));var ie,ne={cells:[{position:new f(-50,0),item:{type:Lt.Weapon,name:"Ракетница",cost:100,rarity:Ut.Usual,weapon:{damageMin:4,damageMax:8}}},{position:new f(50,0),item:{type:Lt.Shield,name:"Генератор щита",cost:100,rarity:Ut.Usual,shield:{shieldMultiplier:.3}}},{position:new f(-100,100)},{position:new f(100,100)},{position:new f(0,125)}],credits:100,criticalChance:.1,criticalMultiplier:2,inventorySize:16,inventory:[{type:Lt.Consumable,consumable:{type:Nt.Heal,count:2},cost:100,rarity:Ut.Special,name:"Лечение"},{type:Lt.Consumable,consumable:{type:Nt.IncreaseCriticalChance,count:2},cost:100,rarity:Ut.Special,name:"+ Шанс крит. урона"},{type:Lt.Consumable,consumable:{type:Nt.MoreProtectCount,count:2},cost:100,rarity:Ut.Special,name:"+1 Защита"},{type:Lt.Consumable,consumable:{type:Nt.MoreAttackCount,count:2},cost:100,rarity:Ut.Special,name:"+1 Атака"}],shipMaxHealth:100,shipHealth:100},re=function(){function t(){}return t.generate=function(t,e){var i={type:t,cost:0,rarity:this.getRarity(t,e),name:""};switch(t){case Lt.Weapon:this.generateWeaponForItem(i,e);break;case Lt.Shield:this.generateShieldForItem(i,e);break;case Lt.Misc:this.generateMiscForItem(i,e);break;case Lt.Consumable:this.generateConsumableForItem(i,e);break;default:throw new Error("Type "+t+" is not supported")}return this.updateCost(i),i},t.generateConsumable=function(t,e){var i=se.filter(function(e){return e.type===t})[0];return{consumable:{type:i.type,count:e},cost:e*i.cost,rarity:Ut.Special,type:Lt.Consumable,name:i.name}},t.getRarity=function(t,e){return t===Lt.Consumable?Ut.Special:t===Lt.Misc?Ut.Usual:e<.6?Ut.Usual:e<.9?Ut.Special:Ut.Legendary},t.updateCost=function(t){var e=1;t.rarity===Ut.Special?e=1.5:t.rarity===Ut.Legendary&&(e=3),t.cost=Math.ceil(t.cost*e)},t.generateWeaponForItem=function(t,e){var i=1,n=0,r="Ракетница";t.rarity===Ut.Special?(i=1.5,n=2,r="Отличная ракетница"):t.rarity===Ut.Legendary&&(i=3,n=3,r="Легендарная ракетница");var o=Math.ceil(4+2*Math.random()*i),s=o+Math.ceil(4+2*Math.random()*i);t.weapon={damageMin:o,damageMax:s,shieldPiercing:n-- >0&&Math.random()>.5?.05*i+.15*Math.random():void n++,criticalChanceMultiplier:n-- >0&&Math.random()>.6?.05*i+.25*Math.random():void n++,addAttack:n-- >0&&Math.random()>.7?1:void 0},t.name=r,t.cost=50+3*t.weapon.damageMin+3*t.weapon.damageMax+50*(t.weapon.shieldPiercing||0)+70*(t.weapon.criticalChanceMultiplier||0)+150*(t.weapon.addAttack||0)},t.generateShieldForItem=function(t,e){var i=.3;t.name="Генератор щита",t.rarity===Ut.Special?(i=.4,t.name="Отличный генератор щита"):t.rarity===Ut.Legendary&&(i=.5,t.name="Легендарный генератор щита"),t.shield={shieldMultiplier:i+.08*Math.random(),addProtect:t.rarity!==Ut.Usual&&Math.random()+e>.9?1:void 0},t.cost=Math.ceil(100+100*t.shield.shieldMultiplier+(t.shield.addProtect?200:0))},t.generateMiscForItem=function(t,e){t.misc={count:Math.ceil(25*e+10*Math.random())},t.cost=4*t.misc.count,t.name=oe[Math.floor(oe.length*Math.random())]},t.generateConsumableForItem=function(t,e){var i=se[Math.floor(se.length*Math.random())],n=Math.ceil(5*e);t.consumable={type:i.type,count:n},t.name=i.name,t.cost=i.cost*n},t}(),oe=["Что-то вроде золота","Металлолом","Электроника от дяди Ляо","Сомнительные энергоячейки","Туалетная бумага, почти новая","Корм для животных","Диски с музыкой восьмидесятых","Консервы времен войны","Водяные чипы для убежищ","Китайские запчасти на корабль"],se=[{type:Nt.Heal,cost:50,name:"Лечение"},{type:Nt.IncreaseCriticalChance,cost:50,name:"+ Шанс крит. урона"},{type:Nt.MoreProtectCount,cost:50,name:"+1 Защита"},{type:Nt.MoreAttackCount,cost:50,name:"+1 Атака"}],ae=function(){function t(){}return t.generate=function(t){for(var e={cells:he[Math.floor(he.length*Math.random())].cells.map(function(t){return{position:t}}),credits:Math.ceil(30+300*t),criticalChance:.3*t,criticalMultiplier:2,shipMaxHealth:Math.ceil(125*t),shipHealth:Math.ceil(125*t),inventorySize:0,inventory:[]},i=t,n=t,r=!0,o=0,s=e.cells;o<s.length;o++){var a=s[o];i>0&&r?(i-=.15,a.item=re.generate(Lt.Weapon,t),r=!1):n>0&&(n-=.15,a.item=re.generate(Lt.Shield,t),r=!0)}return e},t}(),he=[{cells:[new f(-50,0),new f(50,0),new f(-100,100),new f(100,100),new f(0,125)]},{cells:[new f(0,0),new f(-100,25),new f(100,25),new f(-100,125),new f(100,125),new f(0,150)]}],ue=function(){function t(){}return t.prototype.initialize=function(){},t.prototype.getSpritesToRender=function(){return[this.sprite]},t.prototype.getTextsToRender=function(){return[]},t.prototype.update=function(t){},t}(),ce=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),le=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ce(e,t),e.buildEnemy=function(t,i){var n=new e;return n.power=i,n.initialize(),n.sprite.position.set(0,0,5),n.sprite.position.set(t),n.speed=15+15*Math.random(),n.enemyData=ae.generate(i),n},e.prototype.initialize=function(){t.prototype.initialize.call(this);var e=Ot.assets.solarAtlas.getRegion("triangle.png");this.sprite=new It,this.sprite.setTextureRegion(e,!1),this.sprite.setVerticesColor(new F(1,.5,.5,1)),this.sprite.setSize(16*(1+this.power),16*(1+this.power))},e.prototype.update=function(e){t.prototype.update.call(this,e),this.lastMoveAction||this.goSomewhere()},e.prototype.goSomewhere=function(){var t=360*Math.random(),e=100+100*Math.random(),i=f.fromAngle(t).multiplyNumSelf(e).addToSelf(this.sprite.position);this.moveToPosition(i)},e.prototype.moveToPosition=function(t){var e=this;this.sprite.rotation=t.subtract(this.sprite.position).toAngle()+90,this.lastMoveAction&&this.lastMoveAction.onDeactivate(),this.lastMoveAction=ve.actionManager.add(function(i){var n=t.subtract(e.sprite.position);return n.length()<1||(n.normalize().multiplyNumSelf(i*e.speed),e.sprite.position.addToSelf(n),!1)}).then(function(){return e.lastMoveAction=void 0})},e}(ue),pe=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),fe=function(t){function e(e,i){var n=t.call(this)||this;return n.name=e,n.radius=i,n}return pe(e,t),e.buildPlanet1=function(){var t=new e("Земля",64);return t.initialize(),t.sprite.position.set(500,500,5),t.sprite.setVerticesColor(new F(29/255,172/255,109/255,1)),t.updateInventory(),t},e.prototype.initialize=function(){t.prototype.initialize.call(this);var e=Ot.assets.solarAtlas.getRegion("circle_bordered.png");this.sprite=new It,this.sprite.setTextureRegion(e,!1),this.sprite.setSize(2*this.radius,2*this.radius),this.text=new jt(this.name),this.text.pivotPoint.set(.5,0),this.text.parent=this.sprite,this.text.position.set(0,70,6),this.text.color=new F(.9,.9,.9,1)},e.prototype.getTextsToRender=function(){return[this.text]},e.prototype.updateInventory=function(){this.inventory=[re.generateConsumable(Nt.Heal,Math.ceil(3*Math.random())),re.generateConsumable(Nt.IncreaseCriticalChance,Math.ceil(3*Math.random())),re.generateConsumable(Nt.MoreAttackCount,Math.ceil(3*Math.random())),re.generateConsumable(Nt.MoreProtectCount,Math.ceil(3*Math.random()))];for(var t=0;t<2;++t)re.generate(Lt.Weapon,.5*Math.random());for(t=0;t<2;++t)re.generate(Lt.Shield,.4*Math.random())},e}(ue),de=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),ye=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return de(e,t),e.buildPlayer=function(){var t=new e;return t.initialize(),t.sprite.position.set(m.width/2,m.height/2,15),t.speed=50,t},e.prototype.initialize=function(){t.prototype.initialize.call(this);var e=Ot.assets.solarAtlas.getRegion("triangle.png");this.sprite=new It,this.sprite.setTextureRegion(e,!1),this.sprite.setSize(16,16)},e}(ue),me=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),ge=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return me(e,t),e.build=function(){var t=new e;return t.initialize(),t.sprite.visible=!1,t},e.prototype.initialize=function(){t.prototype.initialize.call(this);var e=Ot.assets.solarAtlas.getRegion("circle.png");this.sprite=new It,this.sprite.setTextureRegion(e,!1),this.sprite.setSize(24,24),this.sprite.setVerticesColor(new F(.3,1,.3,1)),this.sprite.position.set(0,0,10)},e}(ue),ve=new(function(){function t(){}return t.prototype.reset=function(){this.playerData=ne,this.player=ye.buildPlayer(),this.targetCursor=ge.build(),this.planetToLand=void 0,this.enemyToFight=void 0,this.planets=[fe.buildPlanet1()],this.enemies=[],this.actionManager=new X,this.createStartEnemies()},t.prototype.createStartEnemies=function(){for(var t=0;t<10;++t){var e=360*Math.random(),i=300+300*Math.random(),n=f.fromAngle(e).multiplyNumSelf(i).addToSelf(ve.player.sprite.position),r=le.buildEnemy(n,.3*Math.random());this.enemies.push(r)}},t}()),we=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),xe=function(t){function e(){return t.call(this)||this}return we(e,t),e.prototype.load=function(){var e=this;return this.renderHelper=new ee(Ot.assets.font,Ot.assets.planetMaterial),this.guiManager=new Ft(Ot.assets.planetMaterial,this.renderHelper.spriteBatch,this.renderHelper.textBatch,Ot.assets.guiCamera),Yt.loadMenu(this.guiManager,Vt),this.guiManager.getElement("ContinueButton").onClick=function(){return e.sceneManager.closeModal()},this.dialogBox=new Ht(550),this.dialogBox.text.text="Поражение!\n\nБлагодаря удаче и/или милосердию противника, вы не умираете.\n\nВас находит космический буксир и оттаскивает к ближайшей планете.\nТам путем обмана, хитрости и мольбы вам удается договориться о\nполной починке корабля.\n\nВы теряете 30% всех кредитов, хотя буксировщик хотел забрать всё.\n\nВаш текущий баланс: $"+ve.playerData.credits,this.dialogBox.text.isWrapped=!1,this.background=new It(m.width-10,m.height-10,new f(0,0)),this.background.position.set(5,5,30),this.background.setVerticesColor(0,0,0,.8),this.background.setTextureRegion(Ot.assets.planetAtlas.getRegion("blank.png"),!1),t.prototype.load.call(this)},e.prototype.unload=function(){return this.guiManager.free(),this.renderHelper.free(),t.prototype.unload.call(this)},e.prototype.render=function(){Ot.assets.guiCamera.update(),this.renderHelper.render([this,this.dialogBox]),this.guiManager.render()},e.prototype.update=function(t){this.guiManager.update(t)},e.prototype.getSpritesToRender=function(){return[this.background]},e.prototype.getTextsToRender=function(){return[]},e}(U),be=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),_e=function(){function t(){this.velocity=new f}return t.prototype.onActivate=function(){this.pause=0,this.t=0,this.lifeTime=0,this.velocity.set(0,0)},t.prototype.onDeactivate=function(){},t}(),Te=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.sprite=new It,e}return be(e,t),e.prototype.onActivate=function(){t.prototype.onActivate.call(this),this.sprite.visible=!0,this.sprite.rotation=0,this.sprite.setVerticesColor(1,1,1,1)},e.prototype.onDeactivate=function(){t.prototype.onDeactivate.call(this),this.sprite.visible=!1},e.prototype.updateParams=function(t){this.sprite.position.addToSelf(this.velocity.multiplyNum(t));var e=(this.lifeTime-this.t)/this.lifeTime;this.sprite.setVerticesAlpha(e),this.velocity.multiplyNumSelf(1-.08*Math.random())},e.prototype.getSpritesToRender=function(){return[this.sprite]},e.prototype.getTextsToRender=function(){return[]},e}(_e),Me=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.text=new jt,e}return be(e,t),e.prototype.onActivate=function(){t.prototype.onActivate.call(this),this.text.visible=!0,this.text.color.set(1,1,1,1)},e.prototype.onDeactivate=function(){t.prototype.onDeactivate.call(this),this.text.visible=!1},e.prototype.updateParams=function(t){this.text.position.addToSelf(this.velocity.multiplyNum(t));var e=(this.lifeTime-this.t)/this.lifeTime;this.text.color.w=e,this.text.shadowEnabled&&(this.text.shadowColor.w=e),this.velocity.multiplyNumSelf(1-.08*Math.random())},e.prototype.getSpritesToRender=function(){return[]},e.prototype.getTextsToRender=function(){return[this.text]},e}(_e),Ce=function(t){function e(e,i,n){var r=t.call(this,i,n)||this;return r.renderHelper=e,r.visible=!0,r}return be(e,t),e.prototype.update=function(t){var e=this;this.visible&&this.poolObjects.forEach(function(i){i.active&&(i.pause>0?i.pause-=t:(i.t+=t,i.t>=i.lifeTime?e.return(i):i.updateParams(t)))})},e.prototype.render=function(){this.renderHelper.render(this.poolObjects.filter(function(t){return t.pause<=0}))},e}(W),Se=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return be(e,t),e}(Ce),Pe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return be(e,t),e}(Ce),ke=function(){function t(){}return t.createSmallParticle=function(){var t=new Te;t.sprite.position.set(0,0,50);var e=Ot.assets.solarAtlas.getRegion("circle.png");return t.sprite.setTextureRegion(e,!1),t},t.createTextParticle=function(){var t=new Me;return t.text.position.set(0,0,50),t},t.emitHit=function(t,e){for(var i=0;i<32;++i){var n=t.get(),r=5+5*Math.random();n.sprite.setSize(r,r),n.sprite.setDefaultVertices(),n.sprite.position.set(e).addToSelf(new f(5-10*Math.random(),5-10*Math.random())),n.sprite.rotation=360*Math.random(),n.sprite.setVerticesColor(.9+.1*Math.random(),.2+.1*Math.random(),0+.1*Math.random(),1),n.pause=.1*Math.random(),n.lifeTime=1+.6*Math.random(),n.velocity=f.fromAngle(360*Math.random()).multiplyNumSelf(60+140*Math.random())}},t.emitHitWithShield=function(t,e){for(var i=0;i<32;++i){var n=t.get(),r=5+5*Math.random();n.sprite.setSize(r,r),n.sprite.setDefaultVertices(),n.sprite.position.set(e).addToSelf(new f(5-10*Math.random(),5-10*Math.random())),n.sprite.rotation=360*Math.random(),i<16?n.sprite.setVerticesColor(1,.8,.2,1):n.sprite.setVerticesColor(.1,.2,1,1),n.pause=.1*Math.random(),n.lifeTime=.6+Math.random(),n.velocity=f.fromAngle(360*Math.random()).multiplyNumSelf(60+140*Math.random())}},t.emitCellBoom=function(t,e){for(var i=0;i<64;++i){var n=t.get(),r=1+10*Math.random();n.sprite.setSize(r,r),n.sprite.setDefaultVertices(),n.sprite.position.set(e).addToSelf(new f(5-10*Math.random(),5-10*Math.random())),n.sprite.rotation=360*Math.random(),n.sprite.setVerticesColor(1,.1,.1,1),n.pause=.2*Math.random(),n.lifeTime=2+Math.random(),n.velocity=f.fromAngle(360*Math.random()).multiplyNumSelf(140+100*Math.random())}},t.emitDamageCount=function(t,e,i,n,r){var o=t.get();o.text.text=i.toString(),o.text.color.set(n),o.text.position.set(e),o.text.shadowEnabled=!0,o.text.shadowOffset.set(1,1),o.text.shadowColor.set(0,0,0,1),o.text.scale=r,o.lifeTime=1.6,o.pause=0,o.velocity=f.fromAngle(60*Math.random()-120).multiplyNumSelf(140+100*Math.random())},t}(),Ae=new(function(){return function(){}}()),Ee=function(){function t(t,e){var i=Ot.assets.planetAtlas.getRegion("health_bar_back.png"),n=Ot.assets.planetAtlas.getRegion("health_bar.png");this.back=new It(1,1,new f(0,0)),this.back.position.set(t,e,2),this.back.setTextureRegion(i,!0),this.current=new It(1,1,new f(0,0)),this.current.parent=this.back,this.current.position.set(5,5,this.back.position.z+1),this.current.setTextureRegion(n,!0),this.text=new jt,this.text.position.set(0,0,this.back.position.z+2),this.text.pivotPoint.set(.5,0),this.text.parent=this.current,this.text.color.set(1,1,1,1),this.originalWidth=this.current.width}return t.prototype.updateHealth=function(t,e){var i=this.originalWidth*(t/e);this.current.width=i,this.text.text=t.toString(),this.text.visible=t>0,this.text.position.x=i/2},t}(),De=function(){return function(t,e,i,n,r){this.caption=new jt(t),this.caption.position.set(i,n,1),this.caption.color.set(1,1,1,1),this.value=new jt(e),this.value.parent=this.caption,this.value.position.set(r,0,1),this.value.color.set(1,1,1,1),this.value.letterSpacing=1.5}}(),Be=function(){function t(){}return t.attackDamageMinMaxSummary=function(t){for(var e=0,i=0,n=0,r=this.get(t,Lt.Weapon);n<r.length;n++){var o=r[n];if(!o.weapon)throw new Error("Type is weapon, but no weapon data provided");e+=o.weapon.damageMin,i+=o.weapon.damageMax}return e+"–"+i},t.attackCount=function(t){for(var e=0,i=0,n=this.get(t,Lt.Weapon);i<n.length;i++){var r=n[i];if(!r.weapon)throw new Error("Type is weapon, but no weapon data provided");++e,r.weapon.addAttack&&(e+=r.weapon.addAttack)}return e},t.protectCount=function(t){for(var e=0,i=0,n=this.get(t,Lt.Shield);i<n.length;i++){var r=n[i];if(!r.shield)throw new Error("Type is shield, but no shield data provided");++e,r.shield.addProtect&&(e+=r.shield.addProtect)}return e},t.protectSummary=function(t){for(var e=[],i=0,n=this.get(t,Lt.Shield);i<n.length;i++){var r=n[i];if(!r.shield)throw new Error("Type is shield, but no shield data provided");e.push(1+(r.shield.addProtect||0)+" x "+Math.ceil(100*r.shield.shieldMultiplier)+" %")}return e.join("\n")||"—"},t.criticalChanceSummary=function(t){var e=this.criticalChance(t);return Math.floor(100*e)+" %"},t.criticalMultiplierSummary=function(t){var e=this.criticalMultiplier(t);return Math.floor(100*e)+" %"},t.calculateDamages=function(t){for(var e=[],i=0,n=this.get(t,Lt.Weapon);i<n.length;i++){var r=n[i];if(!r.weapon)throw new Error("Type is weapon, but no weapon data provided");var o=r.weapon.damageMin+Math.random()*(r.weapon.damageMax-r.weapon.damageMin),s=!1;Math.random()<=this.criticalChance(t)&&(o*=t.criticalMultiplier,s=!0),e.push({damage:o,isCritical:s,shieldPiercing:r.weapon.shieldPiercing||0})}return e},t.criticalChance=function(t){for(var e=this.get(t,Lt.Weapon),i=t.criticalChance,n=0,r=e;n<r.length;n++){var o=r[n];if(!o.weapon)throw new Error("Type is weapon, but no weapon data provided");i+=o.weapon.criticalChanceMultiplier||0}return i},t.criticalMultiplier=function(t){return t.criticalMultiplier},t.calculateProtections=function(t){for(var e=[],i=0,n=this.get(t,Lt.Shield);i<n.length;i++){var r=n[i];if(!r.shield)throw new Error("Type is shield, but no shield data provided");var o=r.shield.shieldMultiplier;e.push({protectionMultiplier:o})}return e},t.getRarityColor=function(t,e){switch(void 0===e&&(e=1),t){case Ut.Usual:return new F(1,1,1,e);case Ut.Special:return new F(.5,.5,1,e);case Ut.Legendary:return new F(206/255,92/255,0,e);default:throw new Error("Unknown item rarity: "+t)}},t.get=function(t,e){return t.cells.filter(function(t){return!!t.item&&t.item.type===e}).map(function(t){return t.item})},t}(),Oe=(function(){}(),function(){}(),function(){function t(t,e,i,n){var r=this;if(null==t.consumable)throw new Error("Item type is consumable but no consumable data found");this.type=t.consumable.type,this.count=t.consumable.count;var o=Ot.assets.planetAtlas.getRegion("blank.png");this.background=new Qt,this.background.sprite.setSize(70,70),this.background.sprite.position.set(e,i,2),this.background.sprite.setVerticesColor(1,1,1,.3),this.background.sprite.setTextureRegion(o,!1),this.background.onMouseOver=function(){return r.background.sprite.setVerticesAlpha(.7)},this.background.onMouseOut=function(){return r.background.sprite.setVerticesAlpha(.3)},this.countText=new jt,this.countText.pivotPoint.set(1,1),this.countText.position.set(this.background.sprite.width/2-5,this.background.sprite.height/2-5,4),this.countText.color.set(1,1,1,1),this.countText.shadowEnabled=!0,this.countText.shadowColor.set(0,0,0,1),this.countText.shadowOffset.set(1,2),this.countText.parent=this.background.sprite,this.updateCountText(),this.effectText=new jt,this.effectText.pivotPoint.set(.5,.5),this.effectText.position.set(0,-12,3),this.effectText.color.set(1,1,1,1),this.effectText.shadowEnabled=!0,this.effectText.shadowColor.set(0,0,0,1),this.effectText.shadowOffset.set(1,2),this.effectText.parent=this.background.sprite,n.addElement(this.background)}return t.prototype.isMouseOver=function(t){return this.background.hitBox.hit(t)},t.prototype.canUse=function(t,e){return this.count>0},t.prototype.use=function(t,e){this.internalUse(t,e),--this.count,this.updateCountText()},t.prototype.updateCountText=function(){this.countText.text=this.count.toString()},t}()),Fe=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Re=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n,r)||this;return o.name="+1 Атака",o.removeAfterNumberOfTurns=0,o.background.sprite.setVerticesColor(.7,.1,.1,.3),o.effectText.text="+А",o}return Fe(e,t),e.prototype.internalUse=function(t,e){++t.attacksLeft},e.prototype.removeEffect=function(t,e){},e}(Oe),Ie=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ve=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n,r)||this;return o.name="Повысить вероятность крит. урона",o.removeAfterNumberOfTurns=1,o.background.sprite.setVerticesColor(.7,.7,.1,.3),o.effectText.text="+К",o}return Ie(e,t),e.prototype.internalUse=function(t,e){t.playerData.criticalChance+=.3},e.prototype.removeEffect=function(t,e){t.playerData.criticalChance-=.3},e}(Oe),ze=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ne=function(){function t(t,e,i,n,r){var o=this;this.cells=[],this.onClick=function(t){};for(var s=function(t){var s=i+t%8*59,h=n+59*u(t,8),c=e.length>t?e[t]:void 0,l=new Le(s,h,r,c);l.back.onClick=function(){return o.onClick(l)},a.cells.push(l)},a=this,h=0;h<t;++h)s(h)}return t.prototype.getSpritesToRender=function(){for(var t=[],e=0,i=this.cells;e<i.length;e++){var n=i[e];null!=n.item&&t.push(n.item.sprite)}return t},t.prototype.getTextsToRender=function(){return[]},t.prototype.addItemToInventory=function(t){if(t.type===Lt.Consumable){var e=t,i=this.cells.filter(function(t){return t.item&&t.item.type===Lt.Consumable}).map(function(t){return t.item}).filter(function(t){return t.consType===e.consType});if(1===i.length)return i[0].count+=e.count,i[0].cost+=e.cost,!0}var n=this.cells.filter(function(t){return!t.item});return 0!==n.length&&(n[0].setItem(t),!0)},t}(),Le=function(){function t(t,e,i,n){var r=this,o=Ot.assets.planetAtlas.getRegion("inventory_cell.png");this.back=new Qt,this.back.sprite.position.set(t,e,5),this.back.sprite.setTextureRegion(o,!0),this.back.sprite.setVerticesAlpha(.5),this.back.label.visible=!1,this.back.updateHitBox(),this.back.onMouseOver=function(){return r.back.sprite.setVerticesAlpha(.7)},this.back.onMouseOut=function(){return r.back.sprite.setVerticesAlpha(.5)},i.addElement(this.back),null!=n&&(this.item=Ue.build(n),this.setItem(this.item))}return t.prototype.setItem=function(t){this.item=t,this.item?(this.item.sprite.parent=this.back.sprite,this.back.sprite.setVerticesColor(Be.getRarityColor(this.item.rarity,.5))):this.back.sprite.setVerticesColor(1,1,1,.5)},t}(),Ue=function(){function t(){}return t.build=function(t){var e,i;switch(t.type){case Lt.Weapon:if(null==t.weapon)throw new Error("ItemType is weapon but no weapon data provided");var n=new je;n.damageMin=t.weapon.damageMin,n.damageMax=t.weapon.damageMax,n.shieldPiercing=t.weapon.shieldPiercing,n.criticalChanceMultiplier=t.weapon.criticalChanceMultiplier,n.addAttack=t.weapon.addAttack,e="laser1.png",i=n;break;case Lt.Shield:if(null==t.shield)throw new Error("ItemType is shield but no shield data provided");var r=new He;r.shieldMultiplier=t.shield.shieldMultiplier,r.addProtect=t.shield.addProtect,e="shield1.png",i=r;break;case Lt.Engine:if(null==t.engine)throw new Error("ItemType is engine but no engine data provided");var o=new We;o.dodgeMultiplier=t.engine.dodgeMultiplier,o.speedBoost=t.engine.speedBoost,e="",i=o;break;case Lt.Misc:if(null==t.misc)throw new Error("ItemType is misc but no misc data provided");var s=new Ge;s.count=t.misc.count,e="",i=s;break;case Lt.Consumable:if(null==t.consumable)throw new Error("ItemType is consumable but no consumable data provided");var a=new Ke;a.count=t.consumable.count,a.consType=t.consumable.type,e="",i=a;break;default:throw new Error("Unknown item type: "+t.type)}i.cost=t.cost,i.name=t.name,i.rarity=t.rarity,i.type=t.type;var h=Ot.assets.planetAtlas.getRegion(e||"blank.png");return i.sprite=new It(40,40),i.sprite.setTextureRegion(h,!!e),i.sprite.position.set(0,0,6),i.sprite.rotation=45,i.sprite.width*=.6,i.sprite.height*=.6,i.sprite.setDefaultVertices(),i},t.prototype.toItemData=function(){return{cost:this.cost,name:this.name,rarity:this.rarity,type:this.type}},t}(),je=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ze(e,t),e.prototype.toItemData=function(){var e=t.prototype.toItemData.call(this);return e.weapon={damageMin:this.damageMin,damageMax:this.damageMax,shieldPiercing:this.shieldPiercing,criticalChanceMultiplier:this.criticalChanceMultiplier,addAttack:this.addAttack},e},e}(Ue),He=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ze(e,t),e.prototype.toItemData=function(){var e=t.prototype.toItemData.call(this);return e.shield={shieldMultiplier:this.shieldMultiplier,addProtect:this.addProtect},e},e}(Ue),We=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ze(e,t),e.prototype.toItemData=function(){var e=t.prototype.toItemData.call(this);return e.engine={dodgeMultiplier:this.dodgeMultiplier,speedBoost:this.speedBoost},e},e}(Ue),Ge=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ze(e,t),e.prototype.toItemData=function(){var e=t.prototype.toItemData.call(this);return e.misc={count:this.count},e},e}(Ue),Ke=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ze(e,t),e.prototype.toItemData=function(){var e=t.prototype.toItemData.call(this);return e.consumable={count:this.count,type:this.consType},e},e}(Ue),Xe=function(){function t(t,e,i,n){var r=this,o=Ot.assets.planetAtlas.getRegion("ship_cell.png");this.cellSprite=new Qt,this.cellSprite.label.visible=!1,this.cellSprite.sprite.setTextureRegion(o,!0),this.cellSprite.sprite.position.set(e+t.position.x,i+t.position.y,2),this.cellSprite.sprite.setVerticesAlpha(.3),this.cellSprite.onMouseOver=function(){return r.cellSprite.sprite.setVerticesAlpha(.7)},this.cellSprite.onMouseOut=function(){return r.cellSprite.sprite.setVerticesAlpha(.3)},this.cellSprite.updateHitBox(),n.addElement(this.cellSprite),this._originalPosition=(new f).set(t.position),this.setItem(t.item?Ue.build(t.item):void 0)}return t.prototype.setItem=function(t){this.item=t,this.item?(this.item.sprite.parent=this.cellSprite.sprite,this.cellSprite.sprite.setVerticesColor(Be.getRarityColor(this.item.rarity,.3))):this.cellSprite.sprite.setVerticesColor(1,1,1,.3)},t.prototype.toShipCellData=function(){return{position:this._originalPosition,item:this.item?this.item.toItemData():void 0}},t}(),Qe=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ye=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n,r)||this,s=Ot.assets.planetAtlas.getRegion("inventory_cell_selected.png");return o.protectMark=new It(70,70),o.protectMark.position.set(0,0,15),o.protectMark.parent=o.cellSprite.sprite,o.protectMark.visible=!1,o.protectMark.setVerticesColor(.3,.3,1,1),o.protectMark.setTextureRegion(s,!0),o.protectMark.setSize(1.34*o.protectMark.width,1.34*o.protectMark.height),o.attackMark=new It(15,15),o.attackMark.position.set(0,0,15),o.attackMark.parent=o.cellSprite.sprite,o.attackMark.visible=!1,o.attackMark.setVerticesColor(1,.3,.3,1),o.attackMark.setTextureRegion(s,!0),o.attackMark.setSize(.8*o.attackMark.width,.8*o.attackMark.height),o}return Qe(e,t),e.prototype.markAsProtected=function(){this.markedAsProtected=!0,this.protectMark.visible=!0},e.prototype.markAsAttacked=function(){this.markedAsAttacked=!0,this.attackMark.visible=!0},e.prototype.isMouseOver=function(t){return this.cellSprite.hitBox.hit(t)},e.prototype.reset=function(){this.protectMark.visible=this.attackMark.visible=!1,this.markedAsAttacked=!1,this.markedAsProtected=!1},e}(Xe),qe=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),$e=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n,r)||this;return o.removeAfterNumberOfTurns=0,o._amount=30,o.background.sprite.setVerticesColor(.1,.7,.1,.3),o.effectText.text="+Л",o}return qe(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return"Вылечить "+this._amount+" единиц здоровья"},enumerable:!0,configurable:!0}),e.prototype.canUse=function(e,i){return t.prototype.canUse.call(this,e,i)&&e.playerData.shipHealth<e.playerData.shipMaxHealth},e.prototype.internalUse=function(t,e){t.playerData.shipHealth=Math.min(t.playerData.shipHealth+this._amount,t.playerData.shipMaxHealth),t.updateHealth()},e.prototype.removeEffect=function(t,e){},e}(Oe);!function(t){t[t.Human=0]="Human",t[t.Ai=1]="Ai"}(ie||(ie={}));var Je,Ze=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),ti=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n,r)||this;return o.name="+1 Защита",o.removeAfterNumberOfTurns=0,o.background.sprite.setVerticesColor(.1,.1,.7,.3),o.effectText.text="+Щ",o}return Ze(e,t),e.prototype.internalUse=function(t,e){++t.protectsLeft},e.prototype.removeEffect=function(t,e){},e}(Oe),ei=function(){function t(){this.shipCells=[],this.playerStats=[],this.consumableItems=[],this.activeItems=[],this.onShipCellClick=function(){},this.onConsumableCellClick=function(){}}return t.build=function(e,i,n){var r=new t;r.type=i,r.playerData=e;r.background=new It(400,m.height-150,new f(0,0)),r.background.setVerticesColor(52/255,111/255,149/255,1);var o=Ot.assets.planetAtlas.getRegion("blank.png");switch(r.background.setTextureRegion(o,!1),r.type){case ie.Human:r.background.position.set(10,140,1),r.background.setVerticesColor(.3,.4,.3,1);break;case ie.Ai:r.background.position.set(m.width-10-r.background.width,140,1),r.background.setVerticesColor(.4,.3,.3,1)}r.playerStats.push(new De("Урон (сумм)","",10,340,250),new De("Крит. шанс","",10,365,250),new De("Крит. урон","",10,390,250),new De("Щит","",10,415,250));for(var s=0,a=r.playerStats;s<a.length;s++){a[s].caption.parent=r.background}for(var h=new f(190,130),u=function(t){var e=new Ye(t,h.x,h.y,n);e.cellSprite.sprite.parent=r.background,e.cellSprite.updateHitBox(),e.cellSprite.onClick=function(){return r.onShipCellClick(e)},r.shipCells.push(e)},c=0,l=e.cells;c<l.length;c++){u(l[c])}r.health=new Ee(20,30),r.health.back.parent=r.background;for(var p=0,d=function(t){var e;if(null==t.consumable)throw new Error("Item type is consumable but no consumable data found");switch(t.consumable.type){case Nt.Heal:e=new $e(t,45+80*p++,r.background.height-45,n);break;case Nt.IncreaseCriticalChance:e=new Ve(t,45+80*p++,r.background.height-45,n);break;case Nt.MoreAttackCount:e=new Re(t,45+80*p++,r.background.height-45,n);break;case Nt.MoreProtectCount:e=new ti(t,45+80*p++,r.background.height-45,n);break;default:throw new Error("Unknown item type: "+t.type)}e.background.sprite.parent=r.background,e.background.onClick=function(){return r.onConsumableCellClick(e)},e.background.updateHitBox(),r.consumableItems.push(e)},y=0,g=e.inventory.filter(function(t){return t.type===Lt.Consumable});y<g.length;y++){d(g[y])}return r.updateHealth(),r.updateStats(),r.resetTurnState(),r},t.prototype.getSpritesToRender=function(){for(var t=[this.background,this.health.back,this.health.current],e=0,i=this.shipCells;e<i.length;e++){var n=i[e];t.push(n.cellSprite.sprite),n.item&&t.push(n.item.sprite),t.push(n.attackMark,n.protectMark)}for(var r=0,o=this.consumableItems;r<o.length;r++){var s=o[r];t.push(s.background.sprite)}return t},t.prototype.getTextsToRender=function(){for(var t=[this.health.text],e=0,i=this.playerStats;e<i.length;e++){var n=i[e];t.push(n.caption,n.value)}for(var r=0,o=this.consumableItems;r<o.length;r++){var s=o[r];t.push(s.countText,s.effectText)}return t},t.prototype.updateHealth=function(){this.health.updateHealth(this.playerData.shipHealth,this.playerData.shipMaxHealth)},t.prototype.resetTurnState=function(){for(var t=0,e=this.shipCells;t<e.length;t++){e[t].reset()}this.attacksLeft=Be.attackCount(this.playerData),this.protectsLeft=Be.protectCount(this.playerData);for(var i=0,n=this.activeItems;i<n.length;i++){var r=n[i];--r.roundLeft>0||r.item.removeEffect(this,r.other)}this.activeItems=this.activeItems.filter(function(t){return t.roundLeft>0})},t.prototype.hasProtectsLeft=function(){return this.protectsLeft>0},t.prototype.hasAttacksLeft=function(){return this.attacksLeft>0},t.prototype.isOwnCell=function(t){return this.shipCells.some(function(e){return e===t})},t.prototype.markAsProtect=function(t){if(!this.hasProtectsLeft())throw new Error("No protects left");if(!this.isOwnCell(t))throw new Error("Wrong cell to protect, perhaps it is enemy's one");t.markAsProtected(),--this.protectsLeft},t.prototype.markAsAttack=function(t){if(!this.hasAttacksLeft())throw new Error("No attacks left");if(this.isOwnCell(t))throw new Error("Wrong cell to attack, perhaps it is yours");t.markAsAttacked(),--this.attacksLeft},t.prototype.aiChooseProtectAndAttack=function(t){for(var e,i=!1;this.hasProtectsLeft();){var n=this.shipCells.filter(function(t){return!t.markedAsProtected});if(0===n.length)break;e=n[Math.floor(Math.random()*n.length)],this.markAsProtect(e),i=!0}for(;this.hasAttacksLeft();){var r=t.shipCells.filter(function(t){return!t.markedAsAttacked});if(0===r.length)break;e=r[Math.floor(Math.random()*r.length)],this.markAsAttack(e),i=!0}return i},t.prototype.updateStats=function(){this.playerStats[0].value.text=Be.attackDamageMinMaxSummary(this.playerData),this.playerStats[1].value.text=Be.criticalChanceSummary(this.playerData),this.playerStats[2].value.text=Be.criticalMultiplierSummary(this.playerData),this.playerStats[3].value.text=Be.protectSummary(this.playerData)},t.prototype.hit=function(t){this.playerData.shipHealth-=t,this.playerData.shipHealth<0&&(this.playerData.shipHealth=0),this.updateHealth()},t.prototype.isAlive=function(){return this.playerData.shipHealth>0},t}(),ii=function(){function t(){}return t.takeOffFromPlanet=new r,t.enemyDefeated=new r,t.playerDied=new r,t}(),ni=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(t){t[t.Start=0]="Start",t[t.HumanTurnProtect=1]="HumanTurnProtect",t[t.HumanTurnAttack=2]="HumanTurnAttack",t[t.AiTurn=3]="AiTurn",t[t.Animation=4]="Animation",t[t.Victory=5]="Victory",t[t.Defeat=6]="Defeat"}(Je||(Je={}));var ri,oi=function(t){function e(){return t.call(this)||this}return ni(e,t),e.prototype.load=function(){return console.log("Fight scene is loaded"),this.guiSB=new Jt,this.guiTB=new te(Ot.assets.font),this.guiManager=new Ft(Ot.assets.planetMaterial,this.guiSB,this.guiTB,Ot.assets.guiCamera),this.actionManager=new X,this.renderHelper=new ee(Ot.assets.font,Ot.assets.planetMaterial),this.emitter=new Se(this.renderHelper,function(){return ke.createSmallParticle()},64),this.textEmitter=new Pe(this.renderHelper,function(){return ke.createTextParticle()},8),this.dialog=new Ht(120),this.reset(),t.prototype.load.call(this)},e.prototype.unload=function(){return this.renderHelper.free(),this.guiManager.free(),this.guiSB.free(),this.guiTB.free(),t.prototype.unload.call(this)},e.prototype.render=function(){Ot.assets.guiCamera.update(),this.renderHelper.render([this.human,this.enemy,this.dialog]),this.emitter.render(),this.textEmitter.render()},e.prototype.update=function(t){this.guiManager.update(t),this.actionManager.update(t),this.emitter.update(t),this.textEmitter.update(t)},e.prototype.onKeyDown=function(t){},e.prototype.onMouseDown=function(t,e){},e.prototype.onMouseMove=function(t){},e.prototype.onMouseUp=function(t,e){},e.prototype.reset=function(){var t=this;this.turnNumber=1,this.human=ei.build(Ae.humanData,ie.Human,this.guiManager),this.enemy=ei.build(Ae.enemyData,ie.Ai,this.guiManager),this.human.onConsumableCellClick=function(e){return t.onConsumableCellClick(e)},this.human.onShipCellClick=function(e){return t.onShipCellClick(e,t.human)},this.enemy.onShipCellClick=function(e){return t.onShipCellClick(e,t.enemy)},this.setFightState(Je.Start)},e.prototype.calculateTurn=function(t,e){for(var i=this,n=0,r=Be.calculateDamages(t.playerData),o=Be.calculateProtections(e.playerData),s=function(s){0===r.length&&(r=Be.calculateDamages(t.playerData)),0===o.length&&(o=Be.calculateProtections(e.playerData));var h=r.pop();if(s.markedAsProtected){var u=o.pop(),c=Math.min(1,1-u.protectionMultiplier+h.shieldPiercing);h.damage*=c}h.damage=Math.floor(h.damage),a.actionManager.add(function(){e.hit(h.damage);var t=s.cellSprite.sprite.absoluteMatrix.position.asVector2(),n=h.isCritical?new F(1,.2,.2,1):new F(.7,.7,.1,1);ke.emitDamageCount(i.textEmitter,t,h.damage,n,h.isCritical?1.3:1),s.markedAsProtected?ke.emitHitWithShield(i.emitter,t):ke.emitHit(i.emitter,t)},n+=2)},a=this,h=0,u=e.shipCells.filter(function(t){return t.markedAsAttacked});h<u.length;h++){s(u[h])}},e.prototype.setFightState=function(t){var e=this;switch(t){case Je.Start:this.dialog.text.text="Раунд "+this.turnNumber++,this.setEnableForConsumable(!1),this.setEnableForCells(this.human,!1),this.setEnableForCells(this.enemy,!1),this.human.resetTurnState(),this.enemy.resetTurnState(),this.actionManager.add(function(){e.setEnableForConsumable(!0),e.setEnableForCells(e.human,!0),e.setEnableForCells(e.enemy,!1),e.setFightState(Je.HumanTurnProtect)},3);break;case Je.HumanTurnProtect:if(!this.human.hasProtectsLeft())return void this.setFightState(Je.HumanTurnAttack);this.dialog.text.text="Выберите "+this.human.protectsLeft+" своих отсека для защиты",this.canUseConsumableItems&&(this.dialog.text.text+=" или воспользуйтесь одноразовыми предметами");break;case Je.HumanTurnAttack:if(this.setEnableForCells(this.human,!1),this.setEnableForCells(this.enemy,!0),!this.human.hasAttacksLeft())return void this.setFightState(Je.AiTurn);this.dialog.text.text="Выберите "+this.human.attacksLeft+" отсека противника для атаки",this.canUseConsumableItems&&(this.dialog.text.text+=" или воспользуйтесь одноразовыми предметами");break;case Je.AiTurn:this.setEnableForConsumable(!1),this.setEnableForCells(this.human,!1),this.setEnableForCells(this.enemy,!1),this.dialog.text.text="Ход противника",this.actionManager.add(function(){return e.enemy.aiChooseProtectAndAttack(e.human)},2).then(function(){return e.setFightState(Je.Animation)},2);break;case Je.Animation:this.dialog.text.text="Рассчитываем бой...",this.actionManager.add(function(){return e.calculateTurn(e.human,e.enemy)},.5).then(function(){return e.calculateTurn(e.enemy,e.human)},4).then(function(){var t=!e.enemy.isAlive();!e.human.isAlive()?e.setFightState(Je.Defeat):t?e.setFightState(Je.Victory):e.setFightState(Je.Start)},5);break;case Je.Victory:this.human.resetTurnState(),this.dialog.text.text="Вы победили!",this.actionManager.add(function(){e.updatePlayerData(),e.sceneManager.closeModal().then(function(){return ii.enemyDefeated.next()})},1);break;case Je.Defeat:this.human.resetTurnState(),this.dialog.text.text="Вы проиграли!",this.actionManager.add(function(){e.updatePlayerData(),e.sceneManager.closeModal().then(function(){return ii.playerDied.next()})},1)}this.fightState=t},e.prototype.onShipCellClick=function(t,e){if(this.fightState===Je.HumanTurnProtect){if(e.type===ie.Ai)return;if(t.markedAsProtected)return void console.log("Cell is already protected");this.human.markAsProtect(t),this.setEnableForConsumable(!1),this.setFightState(Je.HumanTurnProtect)}else if(this.fightState===Je.HumanTurnAttack){if(e.type===ie.Human)return;if(t.markedAsAttacked)return void console.log("Cell is already attacked");this.human.markAsAttack(t),this.setEnableForConsumable(!1),this.setFightState(Je.HumanTurnAttack)}},e.prototype.onConsumableCellClick=function(t){var e=this;if(this.canUseConsumableItems)if(t.canUse(this.human,this.enemy))this.actionManager.add(function(){return e.dialog.text.text="Используем «"+t.name+"»"}).then(function(){return e.setFightState(e.fightState)},2),t.use(this.human,this.enemy),this.human.activeItems.push({item:t,other:this.enemy,roundLeft:t.removeAfterNumberOfTurns});else{var i=this.dialog.text.text;this.actionManager.add(function(){return e.dialog.text.text="Нельзя использовать «"+t.name+"»"}).then(function(){return e.dialog.text.text=i},2)}},e.prototype.setEnableForConsumable=function(t){this.canUseConsumableItems=t;for(var e=0,i=this.human.consumableItems;e<i.length;e++){i[e].background.enabled=t}},e.prototype.setEnableForCells=function(t,e){for(var i=0,n=t.shipCells;i<n.length;i++){var r=n[i];r.cellSprite.enabled=e;r.cellSprite.onMouseOut(r.cellSprite,{})}},e.prototype.updatePlayerData=function(){for(var t=[],e=function(e){if(e.type!==Lt.Consumable||!e.consumable)return"continue";var n=e.consumable,r=i.human.consumableItems.filter(function(t){return t.type===n.type});if(0===r.length)return console.error("No such used found. Strange."),"continue";e.cost-=50*(e.consumable.count-r[0].count),e.consumable.count=r[0].count,0===e.consumable.count&&t.push(e)},i=this,n=0,r=this.human.playerData.inventory;n<r.length;n++){e(r[n])}for(var o=0,s=t;o<s.length;o++){var a=s[o],h=this.human.playerData.inventory.indexOf(a);this.human.playerData.inventory.splice(h,1)}},e}(U),si={background:{},buttons:[{name:"LandingButton",labelText:"Приземлиться",labelColor:new F(1,1,1,1),labelScale:1,size:new f(150,40),position:new l(840,718,49),pivotPoint:new f(.5,.5),verticesColor:new F(.8,.8,.8,1),hoverVerticesColor:new F(1,1,1,1),textureRegion:{name:"button_green.png",adjustSize:!0}}]},ai=function(){return function(){}}(),hi=(function(){}(),new ai),ui=function(){function t(t,e){this.camera=t,this.speed=e,this.movement=new f}return t.prototype.update=function(t){this.movement.set(0,0),v.isKeyDown[d.W]||v.isKeyDown[d.Up]?this.movement.addToSelf(0,-1):(v.isKeyDown[d.S]||v.isKeyDown[d.Down])&&this.movement.addToSelf(0,1),v.isKeyDown[d.A]||v.isKeyDown[d.Left]?this.movement.addToSelf(-1,0):(v.isKeyDown[d.D]||v.isKeyDown[d.Right])&&this.movement.addToSelf(1,0),this.movement.normalize().multiplyNumSelf(t*this.speed),this.camera.position.addToSelf(this.movement)},t}(),ci=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),li=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ci(e,t),e.build=function(){var t=new e;return t.initialize(),t},e.prototype.initialize=function(){t.prototype.initialize.call(this),this.sprite=new It;var e=Ot.assets.solarAtlas.getRegion("smoke.png");this.sprite.setTextureRegion(e,!0),this.sprite.position.set(0,0,1)},e.prototype.onActivate=function(){this.sprite.visible=!0;var t=new f(m.width*Math.random(),m.height*Math.random());this.sprite.position.set(t),this.sprite.rotation=360*Math.random(),this.sprite.setVerticesColor(new F(.2*Math.random(),.4*Math.random(),Math.random(),.2))},e.prototype.onDeactivate=function(){this.sprite.visible=!1},e}(ue),pi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ci(e,t),e.prototype.initialize=function(){for(var t=0;t<10;++t)this.get()},e.prototype.update=function(t){},e.prototype.getSpritesToRender=function(){for(var t=[],e=0,i=0,n=this.poolObjects;i<n.length;i++){var r=n[i];r.active&&(r.sprite.position.z=1+.1*e++,t.push(r.sprite))}return t},e.prototype.getTextsToRender=function(){return[]},e}(W),fi=function(){return function(){}}();!function(t){t[t.Enemy=0]="Enemy",t[t.Chest=1]="Chest"}(ri||(ri={}));var di,yi,mi=new fi,gi="game",vi="mainMenu",wi="fight",xi="planet",bi="treasure",_i="start",Ti="defeated",Mi=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ci=function(t){function e(){return t.call(this)||this}return Mi(e,t),e.prototype.load=function(){var e=this;return console.log("Game scene is loaded"),m.setClearColorRGB(2/255,4/255,34/255,1),this.renderHelper=new ee(Ot.assets.font,Ot.assets.solarMaterial),this.guiSpriteBatch=new Jt,this.guiTextBatch=new te(Ot.assets.font),this.guiManager=new Ft(Ot.assets.planetMaterial,this.guiSpriteBatch,this.guiTextBatch,Ot.assets.guiCamera),Yt.loadMenu(this.guiManager,si),this.landingButton=this.guiManager.getElement("LandingButton"),this.landingButton.visible=!1,this.landingButton.onClick=function(){return e.land()},this.solarObjects=[],this.nebulaPool=new pi(function(){return li.build()},16),this.cameraController=new ui(Ot.assets.gameCamera,400),ve.reset(),this.solarObjects=this.solarObjects.concat(ve.planets).concat(ve.enemies),this.solarObjects.push(ve.player,ve.targetCursor),this.nebulaPool.initialize(),this.$takeOffFromPlanet=ii.takeOffFromPlanet.subscribe(function(){return e.onTakeOffFromPlanet()}),this.$enemyDefeated=ii.enemyDefeated.subscribe(function(){return e.onEnemyDefeated()}),this.$playedDied=ii.playerDied.subscribe(function(){return e.onPlayerDied()}),Ot.actionManager.add(function(){return e.sceneManager.showModal(_i)},.5),t.prototype.load.call(this)},e.prototype.unload=function(){return this.guiManager.free(),this.guiTextBatch.free(),this.guiSpriteBatch.free(),this.renderHelper.free(),this.$takeOffFromPlanet.unsubscribe(),this.$enemyDefeated.unsubscribe(),this.$playedDied.unsubscribe(),t.prototype.unload.call(this)},e.prototype.render=function(){Ot.assets.gameCamera.update(),this.renderHelper.render([this.nebulaPool].concat(this.solarObjects)),Ot.assets.guiCamera.update(),this.guiManager.render()},e.prototype.update=function(t){ve.actionManager.update(t);for(var e=0,i=this.solarObjects;e<i.length;e++){i[e].update(t)}this.cameraController.update(t),this.checkFight()},e.prototype.onMouseDown=function(t,e){if(e===d.LeftButton){var i=Ot.assets.gameCamera.screenToWorld(t);this.movePlayerToPosition((new f).set(i))}},e.prototype.onPause=function(e){t.prototype.onPause.call(this,e),this.guiManager.enabled=!e},e.prototype.onTakeOffFromPlanet=function(){ve.planetToLand&&(ve.planetToLand.inventory=hi.planet.shopItems)},e.prototype.onEnemyDefeated=function(){if(ve.enemyToFight){mi.player=ve.playerData,mi.treasure={type:ri.Enemy,cost:ve.enemyToFight.power+.1,credits:ve.enemyToFight.enemyData.credits},this.sceneManager.showModal(bi,!0);var t=ve.enemies.indexOf(ve.enemyToFight),e=this.solarObjects.indexOf(ve.enemyToFight);ve.enemies.splice(t,1),this.solarObjects.splice(e,1),ve.enemyToFight=void 0}},e.prototype.onPlayerDied=function(){ve.enemyToFight=void 0,ve.playerData.credits=Math.floor(.7*ve.playerData.credits),ve.playerData.shipHealth=ve.playerData.shipMaxHealth,ve.player.sprite.position.set(ve.planets[0].sprite.position.asVector2()),this.cameraController.camera.position.set(ve.planets[0].sprite.position.asVector2().subtractFromSelf(m.width/2,m.height/2)),this.sceneManager.showModal(Ti,!0)},e.prototype.movePlayerToPosition=function(t){var e=this;ve.targetCursor.sprite.visible=!0,ve.targetCursor.sprite.position.set(t),ve.player.sprite.rotation=t.subtract(ve.player.sprite.position).toAngle()+90,this.lastPlayerMoveAction&&this.lastPlayerMoveAction.onDeactivate(),this.lastPlayerMoveAction=ve.actionManager.add(function(i){var n=t.subtract(ve.player.sprite.position);return n.length()<1?(e.stopMoving(),!0):(n.normalize().multiplyNumSelf(i*ve.player.speed),ve.player.sprite.position.addToSelf(n),e.checkLanding(),!1)})},e.prototype.stopMoving=function(){this.lastPlayerMoveAction.onDeactivate(),ve.targetCursor.sprite.visible=!1},e.prototype.checkLanding=function(){for(var t=0,e=ve.planets;t<e.length;t++){var i=e[t];if(!(i.sprite.position.subtract(ve.player.sprite.position).lengthQ()>i.radius*i.radius))return void this.setLanding(i)}this.setLanding(void 0)},e.prototype.checkFight=function(){for(var t=0,e=ve.enemies;t<e.length;t++){var i=e[t];if(!(i.sprite.position.subtract(ve.player.sprite.position).lengthQ()>256))return void this.fight(i)}},e.prototype.setLanding=function(t){if(!t)return ve.planetToLand=void 0,void(this.landingButton.visible=!1);ve.planetToLand=t,this.landingButton.visible=!0},e.prototype.land=function(){this.lastPlayerMoveAction.onDeactivate(),ve.planetToLand&&(hi.player=ve.playerData,hi.planet={shopSize:24,name:ve.planetToLand.name,shopItems:ve.planetToLand.inventory},this.sceneManager.showModal(xi,!0))},e.prototype.fight=function(t){this.stopMoving(),ve.enemyToFight=t,Ae.enemyData=t.enemyData,Ae.humanData=ve.playerData,this.sceneManager.showModal(wi,!0)},e}(U),Si={background:{},buttons:[{name:"StartButton",labelText:"Start",labelColor:new F(.3,.3,.3,1),labelScale:1,size:new f(150,40),position:new l(480,400,1),pivotPoint:new f(.5,.5),verticesColor:new F(.9,.8,.8,1),hoverVerticesColor:new F(1,1,1,1)}]},Pi=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),ki=function(t){function e(){return t.call(this)||this}return Pi(e,t),e.prototype.load=function(){var e=this;return this.guiManager=new Ft(Ot.assets.blankMaterial,new Jt,new te(Ot.assets.font),Ot.assets.guiCamera),Yt.loadMenu(this.guiManager,Si),this.guiManager.getElement("StartButton").onClick=function(){return e.sceneManager.switchTo(gi)},t.prototype.load.call(this)},e.prototype.unload=function(){return this.guiManager.free(),t.prototype.unload.call(this)},e.prototype.render=function(){Ot.assets.guiCamera.update(),this.guiManager.render()},e.prototype.update=function(t){this.guiManager.update(t)},e}(U),Ai={background:{},buttons:[{name:"TakeOffButton",labelText:"Взлететь",labelColor:new F(1,1,1,1),labelScale:1,size:new f(150,40),position:new l(810,35,1),pivotPoint:new f(.5,.5),verticesColor:new F(.8,.8,.8,1),hoverVerticesColor:new F(1,1,1,1),textureRegion:{name:"button_red.png",adjustSize:!0}},{name:"RepairButton",labelText:"Починить",labelColor:new F(1,1,1,1),labelScale:1,labelPosition:new f(20,0),labelPivot:new f(0,.5),size:new f(150,40),position:new l(20,723,2),pivotPoint:new f(0,.5),verticesColor:new F(.8,.8,.8,1),hoverVerticesColor:new F(1,1,1,1),textureRegion:{name:"repair_button.png",adjustSize:!0}},{name:"BuySellButton",labelText:"---",labelColor:new F(1,1,1,1),labelScale:1,size:new f(150,40),position:new l(810,733,1),pivotPoint:new f(.5,.5),verticesColor:new F(.8,.8,.8,1),hoverVerticesColor:new F(1,1,1,1),textureRegion:{name:"button_green.png",adjustSize:!0}},{name:"ShipTransferButton",labelText:"---",labelColor:new F(1,1,1,1),labelScale:1,size:new f(150,40),position:new l(580,733,1),pivotPoint:new f(.5,.5),verticesColor:new F(.8,.8,.8,1),hoverVerticesColor:new F(1,1,1,1),textureRegion:{name:"button_green.png",adjustSize:!0}}]},Ei=function(){function t(t,e,i,n){this.stats=[];var r=Ot.assets.planetAtlas.getRegion("ship_cell.png"),o=Ot.assets.planetAtlas.getRegion("blank.png");this.back=new It(i,n,new f(0,0)),this.back.position.set(t,e,1),this.back.setVerticesColor(52/255,111/255,149/255,1),this.back.setTextureRegion(o,!1),this.itemBack=new It(1,1),this.itemBack.parent=this.back,this.itemBack.setTextureRegion(r,!0),this.itemBack.position.set(this.itemBack.width/2+5,this.itemBack.height/2+5,2),this.itemBack.setVerticesAlpha(.5),this.item=new It(1,1),this.item.parent=this.itemBack,this.item.position.set(0,0,3),this.item.rotation=45,this.item.setTextureRegion(o,!1),this.type=new jt("Тип предмета"),this.type.parent=this.back,this.type.pivotPoint.set(0,1),this.type.position.set(5,this.back.height-5,2),this.name=new jt("Название"),this.name.parent=this.back,this.name.pivotPoint.set(0,0),this.name.position.set(this.itemBack.width/2+this.itemBack.position.x+10,5,2),this.name.scale=1.2,this.name.color.set(25/255,222/255,115/255,1),this.name.maxTextWidth=this.back.width-this.name.position.x-5,this.name.isWrapped=!0,this.description=new jt,this.description.parent=this.back,this.description.pivotPoint.set(0,0),this.description.position.set(5,95,2),this.description.maxTextWidth=this.back.width-10,this.description.isWrapped=!0,this.description.scale=.8,this.description.text="Какая-то многострочная и очень длинная строка, в которой есть все, что нужно знать",this.cost=new jt("$"),this.cost.parent=this.back,this.cost.pivotPoint.set(1,1),this.cost.position.set(this.back.width-5,this.back.height-5,2);for(var s=this.itemBack.width/2+this.itemBack.position.x+10,a=0;a<5;a++){var h=new De("","",s,65+25*a,200);h.caption.parent=this.back,this.stats.push(h)}}return t.prototype.update=function(t,e){this.baseItem=t;for(var i=0,n=this.stats;i<n.length;i++){var r=n[i];r.caption.text=r.value.text=""}switch(this.description.text="",this.cost.text="$"+e,this.name.text=t.name,this.itemBack.setVerticesColor(Be.getRarityColor(t.rarity,1)),t.type){case Lt.Consumable:this.type.text="Расходуемое";var o=t;switch(this.stats[0].caption.text="Количество",this.stats[0].value.text=""+o.count,o.consType){case Nt.Heal:this.description.text="Лечит корабль на некоторое количество единиц, которое определяется во время боя";break;case Nt.IncreaseCriticalChance:this.description.text="Увеличивает шанс критического удара по врагу на один раунд";break;case Nt.MoreAttackCount:this.description.text="Увеличивает число атак по вражескому кораблю на один раунд";break;case Nt.MoreProtectCount:this.description.text="Увеличивает число ваших отсеков, закрываемых щитом, на один раунд";break;default:this.description.text="Неизвестный науке расходуемый предмет. Ну, или как минимум программисту этой игры. Баг, короче."}break;case Lt.Engine:this.type.text="Двигатель";var s=t;this.stats[0].caption.text="Уклонение",this.stats[0].value.text=""+s.dodgeMultiplier,this.stats[1].caption.text="Скорость",this.stats[1].value.text=""+s.speedBoost;break;case Lt.Misc:this.type.text="Всячина";var a=t;this.stats[0].caption.text="Количество",this.stats[0].value.text=""+a.count,this.description.text="Отличная штука! Ее можно использовать чуть менее чем никак. Продайте, пока не кончился срок годности.";break;case Lt.Shield:this.type.text="Генератор щита";var h=t;this.stats[0].caption.text="Сила щита",this.stats[0].value.text=Math.ceil(100*h.shieldMultiplier)+" %",h.addProtect&&(this.stats[1].caption.text="Доп. щиты",this.stats[1].value.text="+"+h.addProtect);break;case Lt.Weapon:this.type.text="Оружие";var u=t;this.stats[0].caption.text="Урон",this.stats[0].value.text=u.damageMin+"–"+u.damageMax;var c=1;u.criticalChanceMultiplier&&(this.stats[c].caption.text="Крит. шанс",this.stats[c].value.text="+"+Math.ceil(100*u.criticalChanceMultiplier)+" %",++c),u.shieldPiercing&&(this.stats[c].caption.text="Пробитие щита",this.stats[c].value.text="+"+Math.ceil(100*u.shieldPiercing)+" %",++c),u.addAttack&&(this.stats[c].caption.text="Доп. атаки",this.stats[c].value.text="+"+u.addAttack,++c);break;default:this.type.text="?!?!!?"}this.item.vertices=t.sprite.vertices.slice(),this.item.setSize(1.5*t.sprite.width,1.5*t.sprite.height),this.item.setDefaultVertices()},t.prototype.getSpritesToRender=function(){return[this.back,this.item,this.itemBack]},t.prototype.getTextsToRender=function(){for(var t=[this.name,this.type,this.description,this.cost],e=0,i=this.stats;e<i.length;e++){var n=i[e];t.push(n.caption,n.value)}return t},t.prototype.setVisible=function(t){this.back.visible=this.item.visible=this.itemBack.visible=this.name.visible=this.type.visible=this.description.visible=this.cost.visible=t;for(var e=0,i=this.stats;e<i.length;e++){var n=i[e];n.caption.visible=n.value.visible=t}},t}(),Di=function(){function t(){this.playerStats=[],this.shipCells=[],this.onShipCellClick=function(){}}return t.build=function(e,i){var n=new t;n.playerData=e;n.background=new It(400,m.height-80,new f(0,0)),n.background.position.set(10,70,1),n.background.setVerticesColor(52/255,111/255,149/255,1);var r=Ot.assets.planetAtlas.getRegion("blank.png");n.background.setTextureRegion(r,!1);n.playerStats.push(new De("Урон (сумм)","",10,340,250),new De("Крит. шанс","",10,365,250),new De("Крит. урон","",10,390,250),new De("Щит","",10,415,250));for(var o=0,s=n.playerStats;o<s.length;o++){s[o].caption.parent=n.background}for(var a=new f(200,140),h=0,u=e.cells;h<u.length;h++){var c=u[h];n.shipCells.push(new Xe(c,a.x,a.y,i))}n.health=new Ee(20,630),n.updateHealth(),n.inventory=new Ne(e.inventorySize,e.inventory,480,150,i),n.inventoryCaption=new jt("Инвентарь"),n.inventoryCaption.position.set(450,70,2),n.inventoryCaption.color.set(1,1,1,1),n.inventoryCaption.pivotPoint.set(0,0),n.inventoryCaption.scale=1.3,n.creditsText=new jt("$---"),n.creditsText.position.set(920,70,2),n.creditsText.color.set(1,1,1,1),n.creditsText.pivotPoint.set(1,0),n.creditsText.scale=1.3,n.updateCreditsText();for(var l=function(t){t.cellSprite.onClick=function(){return n.onShipCellClick(t)}},p=0,d=n.shipCells;p<d.length;p++){l(d[p])}return n},t.prototype.updateHealth=function(){this.health.updateHealth(this.playerData.shipHealth,this.playerData.shipMaxHealth)},t.prototype.updateCreditsText=function(){this.creditsText.text="$"+this.playerData.credits},t.prototype.updateStats=function(){this.playerStats[0].value.text=Be.attackDamageMinMaxSummary(this.playerData),this.playerStats[1].value.text=Be.criticalChanceSummary(this.playerData),this.playerStats[2].value.text=Be.criticalMultiplierSummary(this.playerData),this.playerStats[3].value.text=Be.protectSummary(this.playerData)},t.prototype.getSpritesToRender=function(){for(var t=[this.background,this.health.back,this.health.current],e=0,i=this.shipCells;e<i.length;e++){var n=i[e];n.item&&t.push(n.item.sprite)}return t.concat(this.inventory.getSpritesToRender())},t.prototype.getTextsToRender=function(){for(var t=[this.inventoryCaption,this.creditsText,this.health.text],e=0,i=this.playerStats;e<i.length;e++){var n=i[e];t.push(n.caption,n.value)}return t.concat(this.inventory.getTextsToRender())},t}(),Bi=function(){function t(t,e,i,n){this.caption=new jt("Магазин"),this.caption.position.set(e-30,i,2),this.caption.color.set(1,1,1,1),this.caption.scale=1.3,this.inventory=new Ne(t.shopSize,t.shopItems,e,i+70,n)}return t.prototype.getSpritesToRender=function(){return this.inventory.getSpritesToRender()},t.prototype.getTextsToRender=function(){return[this.caption].concat(this.inventory.getTextsToRender())},t}(),Oi=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(t){t[t.Buy=0]="Buy",t[t.Sell=1]="Sell"}(di||(di={})),function(t){t[t.Setup=0]="Setup",t[t.Remove=1]="Remove"}(yi||(yi={}));var Fi=function(t){function e(){return t.call(this)||this}return Oi(e,t),e.prototype.load=function(){var e=this;return this.initGui(),this.renderHelper=new ee(Ot.assets.font,Ot.assets.planetMaterial),this.player=Di.build(hi.player,this.guiManager),this.shop=new Bi(hi.planet,480,260,this.guiManager),this.player.inventory.onClick=function(t){return e.onInventoryClick(t,!1)},this.shop.inventory.onClick=function(t){return e.onInventoryClick(t,!0)},this.player.onShipCellClick=function(t){return e.onShipCellClick(t)},this.itemDescription=new Ei(450.5,490,473,205),this.itemDescription.setVisible(!1),this.selectedShipCell=void 0,this.selectedInventoryCell=void 0,this.updateRepairText(),this.player.updateStats(),t.prototype.load.call(this)},e.prototype.unload=function(){return this.guiManager.free(),this.renderHelper.free(),t.prototype.unload.call(this)},e.prototype.render=function(){Ot.assets.guiCamera.update(),this.renderHelper.render([this.player,this.shop,this.itemDescription,this]),this.guiManager.render()},e.prototype.update=function(t){this.guiManager.update(t)},e.prototype.onKeyDown=function(t){},e.prototype.onMouseDown=function(t,e){},e.prototype.onMouseMove=function(t){},e.prototype.onMouseUp=function(t,e){},e.prototype.getSpritesToRender=function(){return[this.selectedCellBorder]},e.prototype.getTextsToRender=function(){return[this.planetName,this.noMoneyText]},e.prototype.initGui=function(){var t=this;this.guiSB=new Jt,this.guiTB=new te(Ot.assets.font),this.guiManager=new Ft(Ot.assets.planetMaterial,this.guiSB,this.guiTB,Ot.assets.guiCamera),Yt.loadMenu(this.guiManager,Ai),this.takeOffButton=this.guiManager.getElement("TakeOffButton"),this.takeOffButton.onClick=function(){t.updatePlayerData(),t.sceneManager.closeModal(),ii.takeOffFromPlanet.next()},this.repairButton=this.guiManager.getElement("RepairButton"),this.repairButton.onClick=function(){t.tryRepairShip()},this.buyOrSellButton=this.guiManager.getElement("BuySellButton"),this.buyOrSellButton.visible=!1,this.buyOrSellButton.onClick=function(){return t.onBuySellButtonClick()},this.shipTransferButton=this.guiManager.getElement("ShipTransferButton"),this.shipTransferButton.visible=!1,this.shipTransferButton.onClick=function(){return t.onShipTransferButtonClick()},this.planetName=new jt("Планета «"+hi.planet.name+"»"),this.planetName.position.set(480,25,1),this.planetName.scale=1.7,this.planetName.pivotPoint.set(.5,.5),this.noMoneyText=new jt("Недостаточно денег\nдля покупки"),this.noMoneyText.position.set(450.5,700,1),this.noMoneyText.pivotPoint.set(0,0),this.noMoneyText.color.set(1,.1,.1,1),this.noMoneyText.visible=!1,this.selectedCellBorder=new It;var e=Ot.assets.planetAtlas.getRegion("inventory_cell_selected.png");this.selectedCellBorder.setTextureRegion(e),this.selectedCellBorder.setVerticesColor(.7,1,.7,1),this.selectedCellBorder.position.set(-100,-100,10)},e.prototype.updateRepairText=function(){var t=this.getHealthPointPrice()*(this.player.playerData.shipMaxHealth-this.player.playerData.shipHealth);this.guiManager.getElement("RepairButton").label.text="Починить                    $"+t},e.prototype.tryRepairShip=function(){var t=this.player.playerData;if(t.shipHealth!==t.shipMaxHealth)if(0!==t.credits){var e=this.getHealthPointPrice(),i=Math.min(this.player.playerData.shipMaxHealth-this.player.playerData.shipHealth,u(t.credits,e)),n=i*e;t.credits-=n,t.shipHealth+=i,this.updateRepairText(),this.player.updateHealth(),this.player.updateCreditsText(),console.log("Healed "+i+" points for "+n+" ("+e+" per point)")}else console.log("No money - no honey");else console.log("Health is max")},e.prototype.getHealthPointPrice=function(){return 3},e.prototype.onInventoryClick=function(t,e){if(this.shopMode=e?di.Buy:di.Sell,this.selectedInventoryCell=t.item?t:void 0,this.selectedCellBorder.position.set(t.back.sprite.absoluteMatrix.position.asVector2()),!t.item)return this.itemDescription.setVisible(!1),this.buyOrSellButton.visible=!1,this.shipTransferButton.visible=!1,void(this.noMoneyText.visible=!1);this.itemDescription.setVisible(!0),this.buyOrSellButton.visible=!0,this.buyOrSellButton.label.text=e?"Купить":"Продать",this.itemDescription.update(t.item,e?this.getItemBuyPrice(t.item):this.getItemSellPrice(t.item));var i=e&&!this.isEnoughMoneyToBuy(t.item);this.noMoneyText.visible=i,this.buyOrSellButton.enabled=!i,!e&&this.hasEmptyShipCells()&&this.canSetupOnShip(t.item)?(this.shipTransferButton.visible=!0,this.shipTransferButton.label.text="Поставить",this.shipMode=yi.Setup):this.shipTransferButton.visible=!1},e.prototype.onShipCellClick=function(t){if(this.buyOrSellButton.visible=!1,this.noMoneyText.visible=!1,this.selectedCellBorder.position.set(t.cellSprite.sprite.absoluteMatrix.position.asVector2()),!t.item)return this.itemDescription.setVisible(!1),this.shipTransferButton.visible=!1,void(this.selectedShipCell=void 0);this.itemDescription.setVisible(!0),this.shipTransferButton.visible=!0,this.shipTransferButton.label.text="Убрать",this.shipMode=yi.Remove,this.selectedShipCell=t,this.itemDescription.update(t.item,this.getItemSellPrice(t.item))},e.prototype.hasEmptyShipCells=function(){return this.player.shipCells.some(function(t){return!t.item})},e.prototype.canSetupOnShip=function(t){return t.type===Lt.Engine||t.type===Lt.Shield||t.type===Lt.Weapon},e.prototype.getItemBuyPrice=function(t){return Math.ceil(t.cost*this.getPlayerBuyMultiplier())},e.prototype.getItemSellPrice=function(t){return Math.ceil(t.cost*this.getPlayerSellMultiplier())},e.prototype.isEnoughMoneyToBuy=function(t){return this.player.playerData.credits>=this.getItemBuyPrice(t)},e.prototype.onShipTransferButtonClick=function(){if(this.shipMode===yi.Setup){var t=this.player.shipCells.filter(function(t){return!t.item});if(0===t.length)throw new Error("Can not setup item - no emptyCells");if(this.shopMode===di.Buy)throw new Error("Can not setup item - ShopMode is Buy");if(!this.selectedInventoryCell)throw new Error("Can not setup item - not selected inventory cell");if(!this.selectedInventoryCell.item)throw new Error("Can not setup item - selected inventory cell has no item");t[0].setItem(this.selectedInventoryCell.item),this.selectedInventoryCell.setItem(),this.onInventoryClick(this.selectedInventoryCell,!1)}else{var e=this.player.inventory.cells.filter(function(t){return!t.item});if(0===e.length)throw new Error("Can not remove item - no emptyCells in inventory");if(!this.selectedShipCell)throw new Error("Can not remove item - no selected ship cell");if(!this.selectedShipCell.item)throw new Error("Can not remove item - selected ship cell has no item");e[0].setItem(this.selectedShipCell.item),this.selectedShipCell.setItem(),this.onShipCellClick(this.selectedShipCell)}this.updatePlayerData(),this.player.updateStats(),this.player.updateHealth()},e.prototype.onBuySellButtonClick=function(){if(this.shopMode===di.Buy){if(!this.selectedInventoryCell)throw new Error("Can not buy item - no selected inventory cell");if(!this.selectedInventoryCell.item)throw new Error("Can not buy item - selected inventory cell has no item");if(!this.isEnoughMoneyToBuy)throw new Error("Can not buy item - not enough money");if(!this.player.inventory.addItemToInventory(this.selectedInventoryCell.item))return;this.player.playerData.credits-=this.getItemBuyPrice(this.selectedInventoryCell.item),this.selectedInventoryCell.setItem(),this.player.updateCreditsText(),this.onInventoryClick(this.selectedInventoryCell,!0),this.updatePlayerData()}else{if(!this.selectedInventoryCell)throw new Error("Can not sell item - no selected inventory cell");if(!this.selectedInventoryCell.item)throw new Error("Can not sell item - selected inventory cell has no item");if(!this.shop.inventory.addItemToInventory(this.selectedInventoryCell.item))return;this.player.playerData.credits+=this.getItemSellPrice(this.selectedInventoryCell.item),this.selectedInventoryCell.setItem(),this.player.updateCreditsText(),this.onInventoryClick(this.selectedInventoryCell,!1),this.updatePlayerData()}},e.prototype.getPlayerBuyMultiplier=function(){return 1.3},e.prototype.getPlayerSellMultiplier=function(){return.7},e.prototype.updatePlayerData=function(){var t=this.player.playerData;t.cells=this.player.shipCells.map(function(t){return t.toShipCellData()}),t.inventory=this.player.inventory.cells.filter(function(t){return t.item}).map(function(t){return t.item}).map(function(t){return t.toItemData()}),hi.planet.shopItems=this.shop.inventory.cells.filter(function(t){return t.item}).map(function(t){return t.item}).map(function(t){return t.toItemData()})},e}(U),Ri={background:{},buttons:[{name:"StartButton",labelText:"Начать",labelColor:new F(1,1,1,1),labelScale:1,size:new f(150,40),position:new l(480,618,49),pivotPoint:new f(.5,.5),verticesColor:new F(.8,.8,.8,1),hoverVerticesColor:new F(1,1,1,1),textureRegion:{name:"button_green.png",adjustSize:!0}}]},Ii=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Vi=function(t){function e(){return t.call(this)||this}return Ii(e,t),e.prototype.load=function(){var e=this;return this.renderHelper=new ee(Ot.assets.font,Ot.assets.planetMaterial),this.guiManager=new Ft(Ot.assets.planetMaterial,this.renderHelper.spriteBatch,this.renderHelper.textBatch,Ot.assets.guiCamera),Yt.loadMenu(this.guiManager,Ri),this.guiManager.getElement("StartButton").onClick=function(){return e.sceneManager.closeModal()},this.dialogBox=new Ht(550),this.dialogBox.text.text="Добро пожаловать на борт, капитан Несоло!\n\nНеделю назад вы взялись перевезти контрабандный груз, но вынуждены были\nсбросить его при приближении патруля.\n\nЗаказчик этого не оценил, и теперь вы должны ему кругленькую сумму ($10000).\n\nСпособы заработка:\n\n - Нападать на недружественные корабли\n - Обыскивать обломки судов\n\nТрофеи можно (и нужно) продавать на планетах. Там же можно переоборудовать\nкорабль — поставить оружие и щиты мощнее.\n",this.dialogBox.text.isWrapped=!1,this.background=new It(m.width-10,m.height-10,new f(0,0)),this.background.position.set(5,5,30),this.background.setVerticesColor(0,0,0,.8),this.background.setTextureRegion(Ot.assets.planetAtlas.getRegion("blank.png"),!1),t.prototype.load.call(this)},e.prototype.unload=function(){return this.guiManager.free(),this.renderHelper.free(),t.prototype.unload.call(this)},e.prototype.render=function(){Ot.assets.guiCamera.update(),this.renderHelper.render([this,this.dialogBox]),this.guiManager.render()},e.prototype.update=function(t){this.guiManager.update(t)},e.prototype.getSpritesToRender=function(){return[this.background]},e.prototype.getTextsToRender=function(){return[]},e}(U),zi={background:{},buttons:[{name:"ExitButton",labelText:"Выйти",labelColor:new F(1,1,1,1),labelScale:1,size:new f(150,40),position:new l(840,470,1),pivotPoint:new f(.5,.5),verticesColor:new F(.8,.8,.8,1),hoverVerticesColor:new F(1,1,1,1),textureRegion:{name:"button_red.png",adjustSize:!0}},{name:"TakeAllButton",labelText:"Взять все",labelColor:new F(1,1,1,1),labelScale:1,size:new f(150,40),position:new l(380,470,1),pivotPoint:new f(.5,.5),verticesColor:new F(.8,.8,.8,1),hoverVerticesColor:new F(1,1,1,1),textureRegion:{name:"button_green.png",adjustSize:!0}},{name:"DropButton",labelText:"Выбросить",labelColor:new F(1,1,1,1),labelScale:1,size:new f(150,40),position:new l(130,470,1),pivotPoint:new f(.5,.5),verticesColor:new F(.8,.8,.8,1),hoverVerticesColor:new F(1,1,1,1),textureRegion:{name:"button_red.png",adjustSize:!0}},{name:"TakeButton",labelText:"Взять",labelColor:new F(1,1,1,1),labelScale:1,size:new f(150,40),position:new l(130,470,1),pivotPoint:new f(.5,.5),verticesColor:new F(.8,.8,.8,1),hoverVerticesColor:new F(1,1,1,1),textureRegion:{name:"button_green.png",adjustSize:!0}}]},Ni=["Глядя на улов, вы втайне молитесь богам, чтобы ваши расходы на топливо окупились.","Команда с сомнением смотрит на то, что удалось извлечь спустя несколько часов напряженной работы.",'Самое время перечитать книжку "Вещи, которые заставляют жить". Потому что такая добыча — повод для беспокойства','Кажется, следует поосторожнее называть все вылазки за добычей "прибарахлиться". Вселенная явно услышала вас и подсунула барахло.',"Жаль, что тут нет консервных банок. Если притащить их торговцу, он наверняка был бы рад (на самом деле нет)."],Li=["С такой добычей не стыдно будет показаться на планете. По крайней мере, вы утешаете себя именно так.","Неплохая добыча, но вряд ли это можно считать грандиозным успехом. Обычный хороший улов.","Выручка с продажи добычи вряд ли позволит вам закрыть ипотеку за корабль, но ближайшие пару дней можно свободно пить эрзац-пиво в приятных кантинах"],Ui=["Тщательный и скрупулезный поиск — залог успеха в таком деле, как мародерство. Вы знаете это лучше других.","Говорят, в космосе можно потерять целую планету. Так и было, пока на свет не появились вы.","Рассказывают будто когда-то вы нашли иголку в стогу сена. В это легко поверить, глядя на такую добычу.","В темные времена вас сожгли бы на костре как колдуна. Простому человеку так не везет."],ji=["Победа над легким противником"],Hi=["Победа над обычным противником"],Wi=["Победа над сложным противником"],Gi=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ki=function(t){function e(){return t.call(this)||this}return Gi(e,t),e.prototype.load=function(){var e=this;console.log("Treasure scene is loaded"),this.initGui(),this.renderHelper=new ee(Ot.assets.font,Ot.assets.planetMaterial),this.title=new Ht(120),this.itemDescription=new Ei(520,190,425,235),this.itemDescription.setVisible(!1);var i=mi.player;this.treasureInventory=new Ne(8,[],50,220,this.guiManager),this.playerInventory=new Ne(i.inventorySize,i.inventory,50,340,this.guiManager),this.treasureInventory.onClick=function(t){return e.onTreasureCellClick(t)},this.playerInventory.onClick=function(t){return e.onInventoryCellClick(t)},this.selectedCellBorder=new It;var n=Ot.assets.planetAtlas.getRegion("inventory_cell_selected.png");return this.selectedCellBorder.setTextureRegion(n),this.selectedCellBorder.setVerticesColor(.7,1,.7,1),this.selectedCellBorder.position.set(-100,-100,10),this.generateItems(),this.setTitle(),this.onTreasureCellClick(this.treasureInventory.cells[0]),t.prototype.load.call(this)},e.prototype.unload=function(){return this.renderHelper.free(),this.guiManager.free(),this.guiSpriteBatch.free(),this.guiTextBatch.free(),t.prototype.unload.call(this)},e.prototype.render=function(){Ot.assets.guiCamera.update(),this.renderHelper.render([this,this.title,this.playerInventory,this.treasureInventory,this.itemDescription]),this.guiManager.render()},e.prototype.update=function(t){this.guiManager.update(t)},e.prototype.getSpritesToRender=function(){return[this.selectedCellBorder]},e.prototype.getTextsToRender=function(){return[this.playerInventoryText,this.treasureInventoryText]},e.prototype.initGui=function(){var t=this;this.guiSpriteBatch=new Jt,this.guiTextBatch=new te(Ot.assets.font),this.guiManager=new Ft(Ot.assets.planetMaterial,this.guiSpriteBatch,this.guiTextBatch,Ot.assets.guiCamera),Yt.loadMenu(this.guiManager,zi),this.guiManager.getElement("ExitButton").onClick=function(){return t.exit()},this.guiManager.getElement("TakeAllButton").onClick=function(){return t.takeAll()},this.dropButton=this.guiManager.getElement("DropButton"),this.dropButton.onClick=function(){return t.onDropClick()},this.dropButton.visible=!1,this.takeButton=this.guiManager.getElement("TakeButton"),this.takeButton.onClick=function(){return t.onTakeClick()},this.takeButton.visible=!1,this.treasureInventoryText=new jt("Трофеи"),this.treasureInventoryText.pivotPoint.set(0,1),this.treasureInventoryText.position.set(20,185,10),this.treasureInventoryText.scale=1.3,this.playerInventoryText=new jt("Инвентарь"),this.playerInventoryText.pivotPoint.set(0,1),this.playerInventoryText.position.set(20,300,10),this.playerInventoryText.scale=1.3},e.prototype.generateItems=function(){for(var t=mi.treasure,e=Math.ceil(4*t.cost),i=[Lt.Weapon,Lt.Shield,Lt.Misc,Lt.Consumable],n=t.cost/3,r=0;r<e;++r){var o=this.getRandomArrayElement(i),s=re.generate(o,h(n+Math.random(),.1,1)),a=Ue.build(s);this.treasureInventory.addItemToInventory(a),s.rarity===Ut.Legendary?n-=.2:s.rarity===Ut.Special&&(n-=.1)}},e.prototype.setTitle=function(){var t=mi.treasure,e=this.getTotalItemsCost();switch(t.type){case ri.Chest:this.title.text.text=e<300?this.getRandomArrayElement(Ni):e<700?this.getRandomArrayElement(Li):this.getRandomArrayElement(Ui);break;case ri.Enemy:t.cost<.3?this.title.text.text=this.getRandomArrayElement(ji):t.cost<.7?this.title.text.text=this.getRandomArrayElement(Hi):this.title.text.text=this.getRandomArrayElement(Wi),this.title.text.text+="\nТакже за победу над противником вы получаете $"+t.credits;break;default:throw new Error("Unknown TreasureType - "+t.type)}},e.prototype.takeAll=function(){for(var t=0,e=this.treasureInventory.cells;t<e.length;t++){var i=e[t];if(i.item)this.playerInventory.addItemToInventory(i.item)&&i.setItem(void 0)}},e.prototype.exit=function(){this.updatePlayerData(),this.sceneManager.closeModal()},e.prototype.getRandomArrayElement=function(t){return t[Math.floor(Math.random()*t.length)]},e.prototype.getTotalItemsCost=function(){return this.treasureInventory.cells.filter(function(t){return!!t.item}).map(function(t){return t.item}).reduce(function(t,e){return t+e.cost},0)},e.prototype.updatePlayerData=function(){var t=mi.player;t.inventory=this.playerInventory.cells.filter(function(t){return t.item}).map(function(t){return t.item}).map(function(t){return t.toItemData()}),t.credits+=mi.treasure.credits},e.prototype.onTreasureCellClick=function(t){this.onBaseClick(t),this.dropButton.visible=!1,t.item?this.takeButton.visible=!0:this.takeButton.visible=!1},e.prototype.onInventoryCellClick=function(t){this.onBaseClick(t),this.takeButton.visible=!1,t.item?this.dropButton.visible=!0:this.dropButton.visible=!1},e.prototype.onBaseClick=function(t){this.selectedInventoryCell=t.item?t:void 0,this.selectedCellBorder.position.set(t.back.sprite.absoluteMatrix.position.asVector2()),t.item?(this.itemDescription.setVisible(!0),this.itemDescription.update(t.item,t.item.cost)):this.itemDescription.setVisible(!1)},e.prototype.onDropClick=function(){this.selectedInventoryCell&&this.selectedInventoryCell.item&&(this.selectedInventoryCell.setItem(void 0),this.onInventoryCellClick(this.selectedInventoryCell))},e.prototype.onTakeClick=function(){this.selectedInventoryCell&&this.selectedInventoryCell.item&&(this.playerInventory.addItemToInventory(this.selectedInventoryCell.item)&&(this.selectedInventoryCell.setItem(void 0),this.onInventoryCellClick(this.selectedInventoryCell)))},e}(U),Xi=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Qi=function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{h(n.next(t))}catch(t){o(t)}}function a(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){t.done?r(t.value):new i(function(e){e(t.value)}).then(s,a)}h((n=n.apply(t,e||[])).next())})},Yi=function(t,e){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},qi=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.sceneManager=new j,e}return Xi(e,t),e.prototype.onInit=function(){return Qi(this,void 0,void 0,function(){return Yi(this,function(t){switch(t.label){case 0:return this.renderer.setClearColorRGB(10/255,53/255,71/255,1),[4,Ot.assets.loadAll()];case 1:return t.sent(),this.sceneManager.addScene(gi,new Ci),this.sceneManager.addScene(vi,new ki),this.sceneManager.addScene(wi,new oi),this.sceneManager.addScene(xi,new Fi),this.sceneManager.addScene(bi,new Ki),this.sceneManager.addScene(_i,new Vi),this.sceneManager.addScene(Ti,new xe),this.sceneManager.switchTo(vi),[2]}})})},e.prototype.onUpdate=function(t){Ot.actionManager.update(t),Ot.tweener.update(t),this.sceneManager.update(t)},e.prototype.onRender=function(){t.prototype.onRender.call(this),this.sceneManager.render()},e.prototype.onMouseMove=function(t){this.sceneManager.onMouseMove(t)},e.prototype.onMouseDown=function(t,e){this.sceneManager.onMouseDown(t,e)},e.prototype.onMouseUp=function(t,e){this.sceneManager.onMouseUp(t,e)},e.prototype.onKeyDown=function(t){this.sceneManager.onKeyDown(t)},e.prototype.onKeyUp=function(t){this.sceneManager.onKeyUp(t)},e}(N),$i=document.getElementById("canvas-main");$i&&new qi($i).run()}]);