!function(t){var e={};function i(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);var n=function(){function t(t){this.observable=t,this.callback=function(){}}return t.prototype.unsubscribe=function(){this.observable.unsubscribe(this)},t}(),r=function(){function t(){this.subscriptions=[]}return t.prototype.subscribe=function(t){var e=new n(this);return e.callback=t,this.subscriptions.push(e),e},t.prototype.unsubscribe=function(t){var e=this.subscriptions.indexOf(t);this.subscriptions.splice(e,1)},t.prototype.next=function(t){for(var e=0,i=this.subscriptions;e<i.length;e++){i[e].callback(t)}},t}(),o={pi:3.1415,deg2rad:3.1415/180,rad2deg:180/3.1415,eps:1e-5};function s(t){return 0==(t&t-1)}function a(t,e){return Math.abs(t-e)<o.eps}function h(t,e){return(t-t%e)/e}var u,c=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i}return t.prototype.multiplyNum=function(e){return new t(this.x*e,this.y*e,this.z*e)},t.prototype.multiplyNumSelf=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.prototype.multiplyMatSelf=function(t){return this.x=t.e[0]*this.x+t.e[4]*this.y+t.e[8]*this.z+t.e[12],this.y=t.e[1]*this.x+t.e[5]*this.y+t.e[9]*this.z+t.e[13],this.z=t.e[2]*this.x+t.e[6]*this.y+t.e[10]*this.z+t.e[14],this},t.prototype.set=function(e,i,n){if(e instanceof p)this.x=e.x,this.y=e.y;else if(e instanceof t)this.x=e.x,this.y=e.y,this.z=e.z;else{if(void 0===i||void 0===n)throw new Error("Vector3.set(): 'x' is number but no 'y' and 'z' provided");this.x=e,this.y=i,this.z=n}return this},t.prototype.length=function(){return Math.sqrt(this.lengthQ())},t.prototype.lengthQ=function(){return Math.pow(this.x,2)+Math.pow(this.y,2)+Math.pow(this.z,2)},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z)},t.prototype.addToSelf=function(e,i,n){if(e instanceof p)this.x+=e.x,this.y+=e.y;else if(e instanceof t)this.x+=e.x,this.y+=e.y,this.z+=e.z;else{if(null==i||null==n)throw new Error("Vector3.addToSelf() first argument is number, but no second and third are provided");this.x+=e,this.y+=i,this.z+=n}return this},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z)},t.prototype.normal=function(){var e=this.length();return e<o.eps?new t(0,0,0):this.multiplyNum(1/e)},t.prototype.normalize=function(){var t=this.length();return t<o.eps?this.set(0,0,0):this.multiplyNumSelf(1/t),this},t.prototype.lerp=function(t,e){return t.subtract(this).multiplyNum(e).add(this)},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.prototype.cross=function(e){return new t(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},t.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.prototype.negateVector=function(){return new t(-this.x,-this.y,-this.z)},t.prototype.asVector2=function(){return new p(this.x,this.y)},t}(),l=new c(0,0,1),p=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.fromAngle=function(e){return new t(Math.cos(-e*o.deg2rad),Math.sin(e*o.deg2rad)).normalize()},t.prototype.set=function(e,i){if(e instanceof t||e instanceof c)this.x=e.x,this.y=e.y;else{if(void 0===i)throw new Error("Vector2.set(): 'x' is number, but no 'y' provided");this.x=e,this.y=i}return this},t.prototype.equalTo=function(t){return a(this.x,t.x)&&a(this.y,t.y)},t.prototype.toAngle=function(){return Math.atan2(this.y,this.x)*o.rad2deg},t.prototype.lengthQ=function(){return Math.pow(this.x,2)+Math.pow(this.y,2)},t.prototype.length=function(){return Math.sqrt(this.lengthQ())},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.addToSelf=function(e,i){if(e instanceof t||e instanceof c)this.x+=e.x,this.y+=e.y;else{if(void 0===i)throw new Error("Vector2.addToSelf(): 'x' is number but no 'y' provided");this.x+=e,this.y+=i}return this},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y)},t.prototype.subtractFromSelf=function(e,i){if(e instanceof t||e instanceof c)this.x-=e.x,this.y-=e.y;else{if(void 0===i)throw new Error("Vector2.subtractFromSelf(): 'x' is number but no 'y' provided");this.x-=e,this.y-=i}return this},t.prototype.multiplyNum=function(e){return new t(this.x*e,this.y*e)},t.prototype.multiplyNumSelf=function(t){return this.x*=t,this.y*=t,this},t.prototype.multiplyVecSelf=function(e,i){if(e instanceof t)this.x*=e.x,this.y*=e.y;else{if(null==i)throw new Error("Vector2.multiplyVecSelf(): 'x' is number but no 'y' provided");this.x*=e,this.y*=i}return this},t.prototype.normal=function(){var e=this.length();return e<o.eps?new t(0,0):this.multiplyNum(1/e)},t.prototype.normalize=function(){var t=this.length();return t<o.eps?this.set(0,0):this.multiplyNumSelf(1/t),this},t.prototype.toString=function(){return"x: "+this.x+", y:"+this.y},t}();!function(t){t[t.TouchDown=0]="TouchDown",t[t.TouchUp=1]="TouchUp",t[t.TouchMove=2]="TouchMove",t[t.KeyDown=3]="KeyDown",t[t.KeyUp=4]="KeyUp",t[t.Wheel=5]="Wheel"}(u||(u={}));var f,d,y,m=function(){return function(){this.isDown=!1,this.start=new p(0,0),this.current=new p(0,0)}}(),v=new(function(){function t(){this.touches=[new m,new m,new m,new m,new m,new m,new m,new m,new m,new m],this.mousePos=new p(0,0),this.isKeyDown=new Array(256),this.lastWheelDelta=0,this.events=new r}return t.prototype.process=function(t){var e=t.key;switch(t.inputType){case u.TouchDown:this.touches[e].isDown=!0,this.touches[e].start.set(t.x,t.y),this.touches[e].current.set(t.x,t.y);break;case u.TouchUp:this.touches[e].isDown=!1;break;case u.TouchMove:this.touches[e].current.set(t.x,t.y),this.mousePos.set(t.x,t.y);break;case u.KeyDown:this.isKeyDown[e]=!0;break;case u.KeyUp:this.isKeyDown[e]=!1;break;case u.Wheel:this.lastWheelDelta=t.w}this.events.next(t)},t}()),g=function(){function t(t,e,i,n,r){this.inputType=t,this.key=e,this.x=i,this.y=n,this.w=r,this._initialized=!1,this._initialized=!0}return t.prototype.reset=function(t,e,i,n,r){this.inputType=t,this.key=e,this.x=i,this.y=n,this.w=r,this._initialized=!0},t}();!function(t){t[t.NoInput=0]="NoInput",t[t.LeftButton=1]="LeftButton",t[t.RightButton=2]="RightButton",t[t.Cancel=3]="Cancel",t[t.MiddleButton=4]="MiddleButton",t[t.XButton1=5]="XButton1",t[t.XButton2=6]="XButton2",t[t.Back=8]="Back",t[t.Tab=9]="Tab",t[t.Clear=12]="Clear",t[t.Return=13]="Return",t[t.Shift=16]="Shift",t[t.Ctrl=17]="Ctrl",t[t.Alt=18]="Alt",t[t.Pause=19]="Pause",t[t.CapsLock=20]="CapsLock",t[t.Escape=27]="Escape",t[t.Space=32]="Space",t[t.PageUp=33]="PageUp",t[t.PageDown=34]="PageDown",t[t.End=35]="End",t[t.Home=36]="Home",t[t.Left=37]="Left",t[t.Up=38]="Up",t[t.Right=39]="Right",t[t.Down=40]="Down",t[t.PrintScreen=44]="PrintScreen",t[t.Insert=45]="Insert",t[t.Delete=46]="Delete",t[t._0=48]="_0",t[t._1=49]="_1",t[t._2=50]="_2",t[t._3=51]="_3",t[t._4=52]="_4",t[t._5=53]="_5",t[t._6=54]="_6",t[t._7=55]="_7",t[t._8=56]="_8",t[t._9=57]="_9",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.LeftWin=91]="LeftWin",t[t.RightWin=92]="RightWin",t[t.Select=93]="Select",t[t.NumPad0=96]="NumPad0",t[t.NumPad1=97]="NumPad1",t[t.NumPad2=98]="NumPad2",t[t.NumPad3=99]="NumPad3",t[t.NumPad4=100]="NumPad4",t[t.NumPad5=101]="NumPad5",t[t.NumPad6=102]="NumPad6",t[t.NumPad7=103]="NumPad7",t[t.NumPad8=104]="NumPad8",t[t.NumPad9=105]="NumPad9",t[t.NumPadMul=106]="NumPadMul",t[t.NumPadAdd=107]="NumPadAdd",t[t.NumPadSeparator=108]="NumPadSeparator",t[t.NumPadSub=109]="NumPadSub",t[t.NumPadDecimal=110]="NumPadDecimal",t[t.NumPadDiv=111]="NumPadDiv",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.F13=124]="F13",t[t.F14=125]="F14",t[t.F15=126]="F15",t[t.F16=127]="F16",t[t.F17=128]="F17",t[t.F18=129]="F18",t[t.F19=130]="F19",t[t.F20=131]="F20",t[t.F21=132]="F21",t[t.F22=133]="F22",t[t.F23=134]="F23",t[t.F24=135]="F24",t[t.NumLock=144]="NumLock",t[t.ScrollLock=145]="ScrollLock",t[t.WheelUp=151]="WheelUp",t[t.WheelDown=152]="WheelDown",t[t.Semicolon=186]="Semicolon",t[t.Equal=187]="Equal",t[t.Comma=188]="Comma",t[t.Dash=189]="Dash",t[t.Period=190]="Period",t[t.ForwardSlash=191]="ForwardSlash",t[t.GraveAccent=192]="GraveAccent",t[t.OpenBracket=219]="OpenBracket",t[t.BackSlash=220]="BackSlash",t[t.CloseBracket=221]="CloseBracket",t[t.SingleQuote=222]="SingleQuote"}(f||(f={}));var w,x,b,_,T,M,S,C,P,k=function(){function t(){}return t.registerWebGLContext=function(t){d=t},t.registerWebGLRenderer=function(t){y=t},t}();!function(t){t[t.Repeat=0]="Repeat",t[t.ClampToEdge=1]="ClampToEdge",t[t.MirrorRepeat=2]="MirrorRepeat"}(w||(w={})),function(t){t[t.Nearest=0]="Nearest",t[t.Linear=1]="Linear"}(x||(x={})),function(t){t[t.Pos2Tex2=0]="Pos2Tex2",t[t.Pos3Tex2=1]="Pos3Tex2",t[t.Pos3Tex2Nor3=2]="Pos3Tex2Nor3",t[t.Pos3Tex2Col4=3]="Pos3Tex2Col4"}(b||(b={})),function(t){t[t.Byte=0]="Byte",t[t.Short=1]="Short",t[t.Int=2]="Int"}(_||(_={})),function(t){t[t.vaCoord=0]="vaCoord",t[t.vaNormal=1]="vaNormal",t[t.vaTexCoord0=2]="vaTexCoord0",t[t.vaTexCoord1=3]="vaTexCoord1",t[t.vaColor=4]="vaColor"}(T||(T={})),function(t){t[t.None=0]="None",t[t.Alpha=1]="Alpha",t[t.Additive=2]="Additive",t[t.Multiply=3]="Multiply",t[t.Screen=4]="Screen"}(M||(M={})),function(t){t[t.None=0]="None",t[t.Back=1]="Back",t[t.Front=2]="Front"}(S||(S={})),function(t){t[t.Never=0]="Never",t[t.Less=1]="Less",t[t.Equal=2]="Equal",t[t.LessOrEqual=3]="LessOrEqual",t[t.Greater=4]="Greater",t[t.NotEqual=5]="NotEqual",t[t.GreaterOrEqual=6]="GreaterOrEqual",t[t.Always=7]="Always"}(C||(C={})),function(t){t[t.All=0]="All",t[t.Color=1]="Color",t[t.Depth=2]="Depth"}(P||(P={}));var A,E=function(){function t(e,i){if(this.format=e,this.count=i,this.buffer=d.createBuffer(),!this.buffer)throw new Error("Error while creating Index Buffer");var n=i*t.getSizeFromFormat(e);switch(e){case _.Byte:this._intArray=new Uint8Array(i);break;case _.Short:this._intArray=new Uint16Array(i);break;case _.Int:this._intArray=new Uint32Array(i);break;default:throw new Error("new IndexBuffer() - wrong index format: "+this.format)}this.bind(),d.bufferData(d.ELEMENT_ARRAY_BUFFER,n,d.STATIC_DRAW)}return t.getSizeFromFormat=function(t){switch(t){case _.Byte:return 1;case _.Short:return 2;case _.Int:return 4}},t.getWebGLFormat=function(t){switch(t){case _.Byte:return d.UNSIGNED_BYTE;case _.Short:return d.UNSIGNED_SHORT;case _.Int:return d.UNSIGNED_INT}},t.prototype.free=function(){d.deleteBuffer(this.buffer)},t.prototype.bind=function(){d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,this.buffer)},t.prototype.update=function(t,e){this.bind(),this._intArray.set(t,e),d.bufferSubData(d.ELEMENT_ARRAY_BUFFER,0,this._intArray)},t}(),D=function(){function t(){this.e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}return t.fromVectorAngle=function(e,i){var n=Math.sin(e),r=Math.cos(e),o=1-r,s=i.x*i.y,a=i.y*i.z,h=i.z*i.x,u=i.x*n,c=i.y*n,l=i.z*n,p=o*s,f=o*a,d=o*h,y=new t;return y.e=[o*i.x*i.x+r,p+l,d-c,0,p-l,o*i.y*i.y+r,f+u,0,d+c,f-u,o*i.z*i.z+r,0,0,0,0,1],y},t.prototype.multiplyMat=function(e){var i=new t,n=this,r=e;return i.e=[n.e[0]*r.e[0]+n.e[4]*r.e[1]+n.e[8]*r.e[2]+n.e[12]*r.e[3],n.e[1]*r.e[0]+n.e[5]*r.e[1]+n.e[9]*r.e[2]+n.e[13]*r.e[3],n.e[2]*r.e[0]+n.e[6]*r.e[1]+n.e[10]*r.e[2]+n.e[14]*r.e[3],n.e[3]*r.e[0]+n.e[7]*r.e[1]+n.e[11]*r.e[2]+n.e[15]*r.e[3],n.e[0]*r.e[4]+n.e[4]*r.e[5]+n.e[8]*r.e[6]+n.e[12]*r.e[7],n.e[1]*r.e[4]+n.e[5]*r.e[5]+n.e[9]*r.e[6]+n.e[13]*r.e[7],n.e[2]*r.e[4]+n.e[6]*r.e[5]+n.e[10]*r.e[6]+n.e[14]*r.e[7],n.e[3]*r.e[4]+n.e[7]*r.e[5]+n.e[11]*r.e[6]+n.e[15]*r.e[7],n.e[0]*r.e[8]+n.e[4]*r.e[9]+n.e[8]*r.e[10]+n.e[12]*r.e[11],n.e[1]*r.e[8]+n.e[5]*r.e[9]+n.e[9]*r.e[10]+n.e[13]*r.e[11],n.e[2]*r.e[8]+n.e[6]*r.e[9]+n.e[10]*r.e[10]+n.e[14]*r.e[11],n.e[3]*r.e[8]+n.e[7]*r.e[9]+n.e[11]*r.e[10]+n.e[15]*r.e[11],n.e[0]*r.e[12]+n.e[4]*r.e[13]+n.e[8]*r.e[14]+n.e[12]*r.e[15],n.e[1]*r.e[12]+n.e[5]*r.e[13]+n.e[9]*r.e[14]+n.e[13]*r.e[15],n.e[2]*r.e[12]+n.e[6]*r.e[13]+n.e[10]*r.e[14]+n.e[14]*r.e[15],n.e[3]*r.e[12]+n.e[7]*r.e[13]+n.e[11]*r.e[14]+n.e[15]*r.e[15]],i},t.prototype.multiplyMatSelf=function(t){return this.e=this.multiplyMat(t).e,this},t.prototype.multiplyVec=function(t){return new c(this.e[0]*t.x+this.e[4]*t.y+this.e[8]*t.z+this.e[12],this.e[1]*t.x+this.e[5]*t.y+this.e[9]*t.z+this.e[13],this.e[2]*t.x+this.e[6]*t.y+this.e[10]*t.z+this.e[14])},t.prototype.multiplyNum=function(e){for(var i=new t,n=0;n<16;++n)i.e[n]=this.e[n]*e;return i},t.prototype.identity=function(){this.e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},t.prototype.ortho=function(t,e,i,n,r,o){this.e=[2/(e-t),0,0,0,0,2/(n-i),0,0,0,0,-2/(o-r),0,-(e+t)/(e-t),-(n+i)/(n-i),-(o+r)/(o-r),1]},t.prototype.perspective=function(t,e,i,n){t=Math.min(179.9,Math.max(0,t));var r=i*Math.tan(t*o.deg2rad*.5),s=r*e;this.frustum(-s,s,-r,r,i,n)},t.prototype.frustum=function(t,e,i,n,r,o){this.e=[2*r/(e-t),0,0,0,0,2*r/(n-i),0,0,(e+t)/(e-t),(n+i)/(n-i),(o+r)/(r-o),-1,0,0,2*o*r/(r-o),0]},t.prototype.transpose=function(){for(var e=new t,i=0;i<4;++i)for(var n=0;n<4;++n)e.e[4*i+n]=this.e[4*n+i];return e},t.prototype.rotate=function(e,i){var n=t.fromVectorAngle(e,i);this.multiplyMatSelf(n)},Object.defineProperty(t.prototype,"position",{get:function(){return new c(this.e[12],this.e[13],this.e[14])},set:function(t){this.e[12]=t.x,this.e[13]=t.y,this.e[14]=t.z},enumerable:!0,configurable:!0}),t}(),B=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=i,this.w=n}return t.prototype.set=function(e,i,n,r){if(e instanceof t)this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w;else{if(void 0===i||void 0===n||void 0===r)throw new Error("Vector.set() - x is number, but no y, z, w provided");this.x=e,this.y=i,this.z=n,this.w=r}return this},t.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]},t}(),O=function(){function t(){this.viewProjection=new D,this.model=new D,this.modelViewProjection=new D,this.color=new B(1,1,1,1),this.calculateMVP()}return t.prototype.calculateMVP=function(){this.modelViewProjection=this.viewProjection.multiplyMat(this.model)},t}(),R=function(){function t(t,e){if(this.format=t,this.count=e,this.buffer=d.createBuffer(),this.buffer){this.bind();var i=e*this.getSizeFromFormat(this.format);d.bufferData(d.ARRAY_BUFFER,i,d.STATIC_DRAW),this._floatArray=new Float32Array(e*this.getFloatCountFromFormat(this.format))}else console.log("Error while creating Vertex Buffer")}return t.prototype.bind=function(){d.bindBuffer(d.ARRAY_BUFFER,this.buffer);var t=this.getSizeFromFormat(this.format);switch(this.format){case b.Pos3Tex2:d.enableVertexAttribArray(T.vaCoord),d.enableVertexAttribArray(T.vaTexCoord0),d.vertexAttribPointer(T.vaCoord,3,d.FLOAT,!1,t,0),d.vertexAttribPointer(T.vaTexCoord0,2,d.FLOAT,!1,t,12);break;case b.Pos2Tex2:d.enableVertexAttribArray(T.vaCoord),d.enableVertexAttribArray(T.vaTexCoord0),d.vertexAttribPointer(T.vaCoord,2,d.FLOAT,!1,t,0),d.vertexAttribPointer(T.vaTexCoord0,2,d.FLOAT,!1,t,8);break;case b.Pos3Tex2Nor3:d.enableVertexAttribArray(T.vaCoord),d.enableVertexAttribArray(T.vaTexCoord0),d.enableVertexAttribArray(T.vaNormal),d.vertexAttribPointer(T.vaCoord,3,d.FLOAT,!1,t,0),d.vertexAttribPointer(T.vaTexCoord0,2,d.FLOAT,!1,t,12),d.vertexAttribPointer(T.vaNormal,3,d.FLOAT,!1,t,20);break;case b.Pos3Tex2Col4:d.enableVertexAttribArray(T.vaCoord),d.enableVertexAttribArray(T.vaTexCoord0),d.enableVertexAttribArray(T.vaColor),d.vertexAttribPointer(T.vaCoord,3,d.FLOAT,!1,t,0),d.vertexAttribPointer(T.vaTexCoord0,2,d.FLOAT,!1,t,12),d.vertexAttribPointer(T.vaColor,4,d.FLOAT,!1,t,20)}},t.prototype.free=function(){d.deleteBuffer(this.buffer)},t.prototype.update=function(t,e){this.bind(),this._floatArray.set(t,e),d.bufferSubData(d.ARRAY_BUFFER,0,this._floatArray)},t.prototype.getSizeFromFormat=function(t){return 4*this.getFloatCountFromFormat(t)},t.prototype.getFloatCountFromFormat=function(t){switch(t){case b.Pos3Tex2:return 5;case b.Pos2Tex2:return 4;case b.Pos3Tex2Nor3:return 8;case b.Pos3Tex2Col4:return 9}},t}(),F=8,I=function(){function t(t){this.canvasElement=t,this.renderParams=new O,this._blendingMode=M.None,this._depthWrite=!1,this._depthTest=!1,this._depthFunc=C.Never,this._textureSampler=new Array(F),this._statTextureBind=0,this._statTriCount=0,this._statDIPCount=0,this.onMouseMove=function(t){},this.onMouseDown=function(t,e){},this.onMouseUp=function(t,e){},this.onKeyDown=function(t){},this.onKeyUp=function(t){};var e=t.getContext("webgl")||t.getContext("experimental-webgl");e?(k.registerWebGLContext(e),k.registerWebGLRenderer(this),this.initWebGL(),this.createScreenQuad(),this.initEvents(),t.focus()):console.log("GL initialize failed")}return Object.defineProperty(t.prototype,"textureBinds",{get:function(){return this._statTextureBind},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"triCount",{get:function(){return this._statTriCount},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dipCount",{get:function(){return this._statDIPCount},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),t.prototype.free=function(){this._screenQuadVB.free(),this._screenQuadIB.free()},t.prototype.resize=function(t,e){this.setViewPort(0,0,t,e)},t.prototype.resetStates=function(){this.setCullMode(S.Back),this.setBlendingMode(M.Alpha),this.setDepthFunc(C.LessOrEqual),this.setDepthWrite(!0),this.setDepthTest(!0),this._activeSampler=-1;for(var t=0;t<F;++t)this._textureSampler[t]=null;this._shader=null,this._vertexBuffer=null,this._indexBuffer=null,this._frameBuffer=null,this.renderParams.color.set(1,1,1,1),this.renderParams.viewProjection.identity(),this.renderParams.model.identity()},t.prototype.resetStatistics=function(){this._statDIPCount=0,this._statTextureBind=0,this._statTriCount=0},t.prototype.clear=function(t){switch(t){case P.All:d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT);break;case P.Color:d.clear(d.COLOR_BUFFER_BIT);break;case P.Depth:d.clear(d.DEPTH_BUFFER_BIT)}},t.prototype.setClearColor=function(t){d.clearColor(t.x,t.y,t.z,t.w)},t.prototype.setClearColorRGB=function(t,e,i,n){d.clearColor(t,e,i,n)},t.prototype.setViewPort=function(t,e,i,n){this._width=i,this._height=n,d.viewport(t,e,i,n)},t.prototype.setCullMode=function(t){if(t!==this._cullMode){switch(t){case S.None:d.disable(d.CULL_FACE);break;case S.Front:d.cullFace(d.FRONT);break;case S.Back:d.cullFace(d.BACK)}this._cullMode===S.None&&d.enable(d.CULL_FACE),this._cullMode=t}},t.prototype.setBlendingMode=function(t){if(t!==this._blendingMode){switch(t){case M.None:d.disable(d.BLEND);break;case M.Alpha:d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA);break;case M.Additive:d.blendFunc(d.ONE,d.ONE);break;case M.Multiply:d.blendFunc(d.DST_COLOR,d.ZERO);break;case M.Screen:d.blendFunc(d.ONE,d.ONE_MINUS_SRC_COLOR)}this._blendingMode===M.None&&d.enable(d.BLEND),this._blendingMode=t}},t.prototype.setDepthWrite=function(t){t!==this._depthWrite&&(d.depthMask(t),this._depthWrite=t)},t.prototype.setDepthTest=function(t){t!==this._depthTest&&(t?d.enable(d.DEPTH_TEST):d.disable(d.DEPTH_TEST),this._depthTest=t)},t.prototype.setDepthFunc=function(t){t!==this._depthFunc&&(d.depthFunc(this.getWebGLComparison(t)),this._depthFunc=t)},t.prototype.setShader=function(t){t!==this._shader&&(d.useProgram(t.program),this._shader=t)},t.prototype.setTexture=function(t,e){this._textureSampler[e]!==t&&(this._activeSampler!==e&&(d.activeTexture(d.TEXTURE0+e),this._activeSampler=e),d.bindTexture(d.TEXTURE_2D,null===t?null:t.texture),this._textureSampler[e]=t,++this._statTextureBind)},t.prototype.setVertexBuffer=function(t){t?t!==this._vertexBuffer&&(t.bind(),this._vertexBuffer=t):d.bindBuffer(d.ARRAY_BUFFER,null)},t.prototype.setIndexBuffer=function(t){t?t!==this._indexBuffer&&(t.bind(),this._indexBuffer=t):d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null)},t.prototype.drawTriangles=function(t,e,i,n){this.setVertexBuffer(t),this.setIndexBuffer(e),d.drawElements(d.TRIANGLES,n,E.getWebGLFormat(e.format),i*E.getSizeFromFormat(e.format)),++this._statDIPCount,this._statTriCount+=Math.floor(n/3)},t.prototype.drawScreenQuad=function(t){this.renderParams.viewProjection.ortho(0,1,1,0,-1,1),this.renderParams.modelViewProjection=this.renderParams.viewProjection,t.bind(),this.clear(P.All),this.drawTriangles(this._screenQuadVB,this._screenQuadIB,0,6)},t.prototype.initWebGL=function(){var t="\n      Graphics information:\n      Vendor: "+d.getParameter(d.VENDOR)+"\n      Renderer: "+d.getParameter(d.RENDERER)+"\n      OpenGL: "+d.getParameter(d.VERSION)+"\n      GLSL: "+d.getParameter(d.SHADING_LANGUAGE_VERSION)+"\n      ";console.log(t),d.viewport(0,0,this.canvasElement.width,this.canvasElement.height)},t.prototype.initEvents=function(){var t=this,e=new p(this.canvasElement.getBoundingClientRect().left,this.canvasElement.getBoundingClientRect().top);new p(this.canvasElement.width,this.canvasElement.height);this.canvasElement.onmousemove=function(i){var n=t.getInputEventFromMouseEvent(i);v.process(n),t.onMouseMove(new p(i.pageX-e.x,i.pageY-e.y))},this.canvasElement.onmousedown=function(i){i.preventDefault(),t.canvasElement.focus();var n=t.getInputEventFromMouseEvent(i);v.process(n),t.onMouseDown(new p(i.pageX-e.x,i.pageY-e.y),n.key)},this.canvasElement.oncontextmenu=function(t){t.preventDefault()},this.canvasElement.onmouseup=function(i){var n=t.getInputEventFromMouseEvent(i);v.process(n),t.onMouseUp(new p(i.pageX-e.x,i.pageY-e.y),n.key)},this.canvasElement.onwheel=function(e){e.preventDefault();var i=t.getInputEventFromMouseEvent(e);v.process(i)},this.canvasElement.onkeydown=function(e){e.preventDefault();var i=t.getInputEventFromKeyEvent(e);v.process(i),t.onKeyDown(i.key)},this.canvasElement.onkeyup=function(e){e.preventDefault();var i=t.getInputEventFromKeyEvent(e);v.process(i),t.onKeyUp(i.key)}},t.prototype.createScreenQuad=function(){this._screenQuadVB=new R(b.Pos3Tex2Col4,4),this._screenQuadIB=new E(_.Byte,6),this._screenQuadVB.update([1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,0,0,1,0,1,1,1,1,1,0,1,1,0,0,1,1,1,1],0),this._screenQuadIB.update([0,1,2,2,3,0],0)},t.prototype.getWebGLComparison=function(t){switch(t){case C.Never:return d.NEVER;case C.Less:return d.LESS;case C.Equal:return d.EQUAL;case C.LessOrEqual:return d.LEQUAL;case C.Greater:return d.GREATER;case C.NotEqual:return d.NOTEQUAL;case C.GreaterOrEqual:return d.GEQUAL;case C.Always:return d.ALWAYS}},t.prototype.getInputEventFromMouseEvent=function(t){var e;switch(t.button){case 0:e=f.LeftButton;break;case 1:e=f.MiddleButton;break;case 2:e=f.RightButton;break;default:e=f.NoInput}var i=t.pageX-this.canvasElement.getBoundingClientRect().left,n=t.pageY-this.canvasElement.getBoundingClientRect().top,r=u.TouchMove,o=0;switch(t.type){case"mousedown":r=u.TouchDown;break;case"mouseup":r=u.TouchUp;break;case"mousemove":r=u.TouchMove;break;case"wheel":r=u.Wheel,o=t.deltaY}return new g(r,e,i,n,o)},t.prototype.getInputEventFromKeyEvent=function(t){var e=u.TouchMove;switch(t.type){case"keydown":e=u.KeyDown;break;case"keyup":e=u.KeyUp}var i=t.keyCode;return new g(e,i,0,0,0)},t}(),V=function(){function t(t){var e=this;this.deltaTime=0,this.lastTime=0,this.currentTime=0,this.pauseAll=!1,this.renderer=new I(t),this.renderer.onMouseMove=function(t){return e.onMouseMove(t)},this.renderer.onMouseDown=function(t,i){return e.onMouseDown(t,i)},this.renderer.onMouseUp=function(t,i){return e.onMouseUp(t,i)},this.renderer.onKeyDown=function(t){return e.onKeyDown(t)},this.renderer.onKeyUp=function(t){return e.onKeyUp(t)},this.renderer.setViewPort(0,0,t.width,t.height)}return t.prototype.run=function(){var t=this;this.onInit();var e=function(i){t.lastTime=t.currentTime,t.currentTime=i/1e3,t.deltaTime=Math.min(t.currentTime-t.lastTime,.1),t.pauseAll||(t.onUpdate(t.deltaTime),t.onRender()),window.requestAnimationFrame(e)};window.requestAnimationFrame(e)},t.prototype.onRender=function(){this.renderer.clear(P.All),this.renderer.resetStates(),this.renderer.resetStatistics()},t}();!function(t){t[t.Hidden=0]="Hidden",t[t.Active=1]="Active",t[t.Paused=2]="Paused"}(A||(A={}));var N,z=function(){function t(){this.state=A.Hidden}return t.prototype.load=function(){var t=this;return new Promise(function(e,i){t.state=A.Active,e()})},t.prototype.unload=function(){var t=this;return new Promise(function(e,i){t.state=A.Hidden,e()})},t.prototype.setPause=function(t){this.state!==A.Hidden&&(this.state=t?A.Paused:A.Active)},t.prototype.onMouseMove=function(t){},t.prototype.onMouseDown=function(t,e){},t.prototype.onMouseUp=function(t,e){},t.prototype.onKeyDown=function(t){},t.prototype.onKeyUp=function(t){},t}(),L=function(){function t(){this.current=null,this.modal=null,this.scenes={}}return t.prototype.addScene=function(t,e){if(this.scenes[t])throw new Error("Scene with name '"+t+"' already exists");this.scenes[t]=e,e.sceneManager=this},t.prototype.switchTo=function(t){var e=this;this.current?this.current.unload().then(function(){e.current=e.scenes[t],e.current.load()}):(this.current=this.scenes[t],this.current.load())},t.prototype.showModal=function(t){this.current&&this.current.setPause(!0),this.modal=this.scenes[t],this.modal.load()},t.prototype.closeModal=function(){var t=this;if(!this.modal)throw new Error("Try to close modal but no modal found");this.modal.unload().then(function(){t.modal=null,t.current&&t.current.setPause(!1)})},t.prototype.update=function(t){for(var e in this.scenes)this.scenes[e].state===A.Active&&this.scenes[e].update(t)},t.prototype.render=function(){for(var t in this.scenes)this.scenes[t].state!==A.Hidden&&this.scenes[t].render()},t.prototype.onMouseMove=function(t){for(var e in this.scenes)this.scenes[e].state===A.Active&&this.scenes[e].onMouseMove(t)},t.prototype.onMouseDown=function(t,e){for(var i in this.scenes)this.scenes[i].state===A.Active&&this.scenes[i].onMouseDown(t,e)},t.prototype.onMouseUp=function(t,e){for(var i in this.scenes)this.scenes[i].state===A.Active&&this.scenes[i].onMouseUp(t,e)},t.prototype.onKeyDown=function(t){for(var e in this.scenes)this.scenes[e].state===A.Active&&this.scenes[e].onKeyDown(t)},t.prototype.onKeyUp=function(t){for(var e in this.scenes)this.scenes[e].state===A.Active&&this.scenes[e].onKeyUp(t)},t}(),U=30,j=function(){function t(t,e){this.newItem=t,this.poolObjects=new Array(e||U);for(var i=0;i<this.poolObjects.length;++i)this.poolObjects[i]=this.newItem(),this.poolObjects[i].onDeactivate()}return t.prototype.get=function(){for(var t=0,e=this.poolObjects;t<e.length;t++){var i=e[t];if(!i.active)return i.active=!0,i.onActivate(),i}var n=this.newItem();return n.active=!0,n.onActivate(),this.poolObjects.push(n),n},t.prototype.return=function(t){t.active=!1,t.onDeactivate()},t}();!function(t){t[t.Simple=0]="Simple",t[t.Continuous=1]="Continuous"}(N||(N={}));var H,W=function(){function t(t){this._actionManager=t,this.active=!1,this.paused=!1,this.actionType=N.Simple,this.pauseOnStart=0,this.time=0,this.duration=0,this.nextActions=[],this.action=function(){return!1}}return t.prototype.onActivate=function(){this.active=!0,this.paused=!1,this.time=0,this.duration=0,this.nextActions=[]},t.prototype.onDeactivate=function(){this.active=!1},t.prototype.then=function(t,e,i){return void 0===e&&(e=0),this._actionManager.addAfter(this,t,e,i)},t.prototype.update=function(t){if(this.active&&!this.paused&&(this.time+=t,!(this.time<this.pauseOnStart))){if(this.actionType===N.Simple)return this.action(),this.onDeactivate(),void this.playNextActions();(this.action(t,this.time)||this.duration&&this.time>=this.duration+this.pauseOnStart)&&(this.onDeactivate(),this.playNextActions())}},t.prototype.playNextActions=function(){for(var t=0,e=this.nextActions;t<e.length;t++){e[t].paused=!1}},t}(),G=function(){function t(){var t=this;this._pool=new j(function(){return new W(t)},10)}return t.prototype.add=function(t,e,i){void 0===e&&(e=0);var n=this._pool.get();return void 0!==i&&(n.duration=i),n.pauseOnStart=e,n.actionType=this.isSimpleAction(t)?N.Simple:N.Continuous,n.action=t,n},t.prototype.addAfter=function(t,e,i,n){void 0===i&&(i=0);var r=this.add(e,i,n);return r.paused=!0,t.nextActions.push(r),r},t.prototype.update=function(t){for(var e=0,i=this._pool.poolObjects;e<i.length;e++){i[e].update(t)}},t.prototype.isSimpleAction=function(t){return 0===t.length},t}(),K=function(t,e,i){return 1===i?t+e:e*(1-Math.pow(2,-15*i))+t},X=function(t,e,i){return 1===i?t+e:0===e||0===i?t:e*Math.pow(2,-10*i)*Math.sin(6.28*(i-.0625)/.25)+e+t},Q=function(t,e,i){return 1===i?t+e:t+e*i};!function(t){t[t.ElasticEaseIn=0]="ElasticEaseIn",t[t.ElasticEaseOut=1]="ElasticEaseOut",t[t.ExpoEaseIn=2]="ExpoEaseIn",t[t.Bounce=3]="Bounce",t[t.Simple=4]="Simple"}(H||(H={}));var Y,q,$=function(){function t(){this.active=!1,this.time=0,this.pauseOnStart=0,this.duration=0,this.start=0,this.finish=0,this.current=0,this.setValue=function(t){return t},this.easingFunc=function(t,e,i){return t}}return t.prototype.onActivate=function(){this.active=!0},t.prototype.onDeactivate=function(){this.active=!1},t.prototype.refresh=function(t,e,i,n,r,o){void 0===o&&(o=0),this.setValue=t,this.easingFunc=this.getEasingFunc(e),this.start=i,i instanceof p||i instanceof c||i instanceof B?this.current.set(i):this.current=this.start,this.finish=n,this.duration=r,this.pauseOnStart=o,this.time=0,this.onActivate()},t.prototype.getUnitValue=function(){return this.time<=this.pauseOnStart?0:this.time>=this.duration+this.pauseOnStart?1:(this.time-this.pauseOnStart)/this.duration},t.prototype.update=function(t){this.active&&(this.time+=t,this.start instanceof p&&this.finish instanceof p?this.current.set(this.easingFunc(this.start.x,this.finish.x-this.start.x,this.getUnitValue()),this.easingFunc(this.start.y,this.finish.y-this.start.y,this.getUnitValue())):this.start instanceof c&&this.finish instanceof c?this.current.set(this.easingFunc(this.start.x,this.finish.x-this.start.x,this.getUnitValue()),this.easingFunc(this.start.y,this.finish.y-this.start.y,this.getUnitValue()),this.easingFunc(this.start.z,this.finish.z-this.start.z,this.getUnitValue())):this.start instanceof B&&this.finish instanceof B?this.current.set(this.easingFunc(this.start.x,this.finish.x-this.start.x,this.getUnitValue()),this.easingFunc(this.start.y,this.finish.y-this.start.y,this.getUnitValue()),this.easingFunc(this.start.z,this.finish.z-this.start.z,this.getUnitValue()),this.easingFunc(this.start.w,this.finish.w-this.start.w,this.getUnitValue())):"number"==typeof this.start&&"number"==typeof this.finish&&(this.current=this.easingFunc(this.start,this.finish-this.start,this.getUnitValue())),this.setValue(this.current),this.time-this.pauseOnStart>=this.duration&&(this.time=this.duration+this.pauseOnStart,this.onDeactivate()))},t.prototype.getEasingFunc=function(t){switch(t){case H.ElasticEaseIn:case H.ElasticEaseOut:return X;case H.ExpoEaseIn:return K;case H.Bounce:return X;case H.Simple:return Q}},t}(),J=function(){function t(){this._pool=new j(function(){return new $},10)}return t.prototype.update=function(t){for(var e=0,i=this._pool.poolObjects;e<i.length;e++){i[e].update(t)}},t.prototype.addTween=function(t,e,i,n,r,o){void 0===o&&(o=0),this._pool.get().refresh(t,e,i,n,r,o)},t}(),Z=function(){function t(){}return t.getElementDataOrEmpty=function(t){var e=document.getElementById(t);return e?e.innerHTML:""},t.getTextFromUrl=function(t){return this.getResponseFromUrl(t)},t.getJSONFromUrl=function(t){return this.getTextFromUrl(t).then(function(t){return JSON.parse(t)})},t.getResponseFromUrl=function(t,e){return new Promise(function(i,n){var r=new XMLHttpRequest;r.open("get",t),void 0!==e&&(r.responseType=e),r.onload=function(){r.status>=200&&r.status<300?i(r.response):n({status:r.status,statusText:r.statusText})},r.onerror=function(){n({status:r.status,statusText:r.statusText})},r.send()})},t}();!function(t){t[t.Vertex=0]="Vertex",t[t.Fragment=1]="Fragment"}(Y||(Y={})),function(t){t[t.Vec1=0]="Vec1",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Mat4=4]="Mat4",t[t.Sampler=5]="Sampler",t[t.Int=6]="Int"}(q||(q={}));var tt,et,it=function(){return function(t,e,i,n,r){void 0===r&&(r=function(){return null}),this.type=t,this.name=e,this.count=i,this.index=n,this.data=r}}(),nt=function(){function t(){this.shaders=[],this.uniforms=[],this.program=d.createProgram(),this.program||console.error("ShaderProgram create failed")}return t.unbind=function(){d.useProgram(null)},t.prototype.free=function(){d.deleteProgram(this.program),this.shaders.forEach(function(t){d.deleteShader(t)})},t.prototype.bind=function(){d.useProgram(this.program);for(var t=0;t<this.uniforms.length;++t)this.uniforms[t].data&&this.setUniform(t)},t.prototype.attach=function(t,e){var i=this.getWebGLShaderType(t),n=d.createShader(i);if(n)if(this.shaders.push(n),d.shaderSource(n,e),d.compileShader(n),d.getShaderParameter(n,d.COMPILE_STATUS)){if(t===Y.Vertex){var r=Object.keys(T).filter(function(t){return"number"==typeof T[t]});for(var o in r)d.bindAttribLocation(this.program,parseInt(o),T[o])}d.attachShader(this.program,n)}else{console.log("ShaderProgram.attach() failed - can't compile "+t+" shader\n       InfoLog:");var s=d.getShaderInfoLog(n);console.log(s)}else console.log("ShaderProgram.attach() failed - can't create shader with type "+i+" ("+t+")")},t.prototype.link=function(){var t=this;if(d.linkProgram(this.program),!d.getProgramParameter(this.program,d.LINK_STATUS)){console.log("ShaderProgram.link() failed at link\n        InfoLog:");var e=d.getProgramInfoLog(this.program);console.log(e)}if(d.validateProgram(this.program),!d.getProgramParameter(this.program,d.VALIDATE_STATUS)){console.log("ShaderProgram.link() failed at validate\n        InfoLog:");e=d.getProgramInfoLog(this.program);console.log(e)}this.addUniform(q.Mat4,1,"uModelViewProj",function(){return y.renderParams.modelViewProjection.e}),this.addUniform(q.Vec4,1,"uColor",function(){return y.renderParams.color.asArray()}),this.shaders.forEach(function(e){return d.detachShader(t.program,e)})},t.prototype.addUniform=function(t,e,i,n){var r=d.getUniformLocation(this.program,i);if(!r)return console.log("ShaderProgram.addUniform failed - gl.getUniformLocation for "+i+" returned null (not found)"),null;var o=new it(t,i,e,r,n);return this.uniforms.push(o)},t.prototype.getUniformIndexByName=function(t){return this.uniforms.filter(function(e){return e.name===t})[0].index||null},t.prototype.setUniform=function(t,e){var i=this.uniforms[t];switch(null!=e&&(i.data=e),i.type){case q.Vec1:d.uniform1fv(i.index,i.data());break;case q.Vec2:d.uniform2fv(i.index,i.data());break;case q.Vec3:d.uniform3fv(i.index,i.data());break;case q.Vec4:d.uniform4fv(i.index,i.data());break;case q.Mat4:d.uniformMatrix4fv(i.index,!1,i.data());break;case q.Sampler:case q.Int:d.uniform1iv(i.index,i.data())}},t.prototype.updateUniformValue=function(t,e){for(var i=-1,n=0;n<this.uniforms.length;++n)if(this.uniforms[n].name===t){i=n;break}-1!==i?this.uniforms[i].data=e:console.error("Uniform of name '"+t+"' was not found")},t.prototype.getWebGLShaderType=function(t){switch(t){case Y.Vertex:return d.VERTEX_SHADER;case Y.Fragment:return d.FRAGMENT_SHADER;default:return console.log("Unknown ShaderType: "+t+" at ShaderProgram.getWebGLShaderType()"),0}},t}(),rt=function(){return function(t,e,i){this.texture=t,this.uniformName=e,this.shaderInternalIndex=i}}(),ot=function(){function t(){this.textures=[],this.color=new B(1,1,1,1),this.blend=M.Alpha,this.depthWrite=!0,this.depthTest=!0,this.depthTestFunc=C.Less,this.cull=S.Back}return t.prototype.free=function(){},t.prototype.addTexture=function(t,e){if(this.shader){var i=this.textures.length,n=this.shader.addUniform(q.Sampler,1,e,function(){return[i]});null!==n?this.textures.push(new rt(t,e,n)):console.error("Material.addTexture() failed - can't determine shader index for '"+e+"'")}else console.error("Material.addTexture() failed - no shader at material")},t.prototype.bind=function(){y.setBlendingMode(this.blend),y.setCullMode(this.cull),y.setDepthWrite(this.depthWrite),y.setDepthTest(this.depthTest),y.setDepthFunc(this.depthTestFunc),y.renderParams.color=this.color,this.textures.forEach(function(t,e){t.texture.bind(e)}),this.shader&&this.shader.bind()},t.prototype.unbind=function(){nt.unbind()},t}(),st=function(){function t(){this.positions=[new c,new c,new c,new c],this.texCoords=[new p,new p,new p,new p],this.colors=[new B(1,1,1,1),new B(1,1,1,1),new B(1,1,1,1),new B(1,1,1,1)]}return t.prototype.toArray=function(){return[this.positions[0].x,this.positions[0].y,this.positions[0].z,this.texCoords[0].x,this.texCoords[0].y,this.colors[0].x,this.colors[0].y,this.colors[0].z,this.colors[0].w,this.positions[1].x,this.positions[1].y,this.positions[1].z,this.texCoords[1].x,this.texCoords[1].y,this.colors[1].x,this.colors[1].y,this.colors[1].z,this.colors[1].w,this.positions[2].x,this.positions[2].y,this.positions[2].z,this.texCoords[2].x,this.texCoords[2].y,this.colors[2].x,this.colors[2].y,this.colors[2].z,this.colors[2].w,this.positions[3].x,this.positions[3].y,this.positions[3].z,this.texCoords[3].x,this.texCoords[3].y,this.colors[3].x,this.colors[3].y,this.colors[3].z,this.colors[3].w]},t}(),at=function(){function t(){this.fontData={},this.material=new ot,this.maxSymbolHeight=0}return t.prototype.getSymbolQuad=function(t,e){var i=new st,n=this.fontData[t];return n?(i.positions[0].set(n.width,n.startY+n.height,0).multiplyNumSelf(e),i.positions[1].set(n.width,n.startY,0).multiplyNumSelf(e),i.positions[2].set(0,n.startY,0).multiplyNumSelf(e),i.positions[3].set(0,n.startY+n.height,0).multiplyNumSelf(e),i.texCoords[0].set(n.tx+n.tw,n.ty+n.th),i.texCoords[1].set(n.tx+n.tw,n.ty),i.texCoords[2].set(n.tx,n.ty),i.texCoords[3].set(n.tx,n.ty+n.th),i):i},t.prototype.hasFontData=function(t){return!!this.fontData[t]},t.prototype.getTextLength=function(t,e){void 0===e&&(e=!0);for(var i,n=0,r=0,o=t;r<o.length;r++){var s=o[r];n+=(i=this.fontData[s])?i.width:0}return e&&(n+=this.fontData[" "].width),n},t}(),ht=function(){function t(){}return t.prototype.load=function(t,e,i,n,r){return new Promise(function(o,s){var a=new at;Z.getResponseFromUrl(t.fontFileSrc,"json").then(function(s){for(var h=0,u=s;h<u.length;h++){var c=u[h];a.fontData[c.symbol]=c,c.height>a.maxSymbolHeight&&(a.maxSymbolHeight=c.height)}t.material?(a.material=t.material,o(a)):t.materialData&&e.load(t.materialData,i,n,r).then(function(t){return a.material=t}).then(function(){return o(a)})})})},t}(),ut=function(){function t(){}return t.prototype.load=function(t,e,i,n){return new Promise(function(r,o){if(!t.shaderProgram&&!t.shaderProgramData)throw new Error("Can't create material - no shader or shader data provided");var s=new ot;s.blend=t.blend,s.color=t.color,s.cull=t.cull,s.depthTest=t.depthTest,s.depthTestFunc=t.depthTestFunc,s.depthWrite=t.depthWrite,(t.shaderProgram?new Promise(function(e,i){return e(t.shaderProgram)}):e.load(t.shaderProgramData)).then(function(t){return s.shader=t}).then(function(){for(var e=[],o=function(t){if(t.texture)s.addTexture(t.texture,t.uniformName);else if(t.textureAtlas)s.addTexture(t.textureAtlas,t.uniformName);else if(t.textureData){var r=i.load(t.textureData).then(function(e){return s.addTexture(e,t.uniformName)});e.push(r)}else{if(!t.textureAtlasData)throw new Error("Can't add texture with uniformName '"+t.uniformName+"'\n                 to material - no texture or texture data provided");r=n.load(t.textureAtlasData).then(function(e){return s.addTexture(e,t.uniformName)});e.push(r)}},a=0,h=t.textures;a<h.length;a++){o(h[a])}Promise.all(e).then(function(){return r(s)})})})},t}(),ct=function(){function t(){}return t.prototype.load=function(t){return new Promise(function(e,i){var n=new nt;n.attach(Y.Vertex,t.vertexShaderText),n.attach(Y.Fragment,t.fragmentShaderText),n.link(),e(n)})},t}(),lt=function(){function t(){this._audioContext=new AudioContext}return t.prototype.load=function(t){var e=this;return Z.getResponseFromUrl(t.soundFileSrc,"arraybuffer").then(function(t){return e._audioContext.decodeAudioData(t)})},t}(),pt=function(){function t(){if(this.width=1,this.height=1,this.texture=d.createTexture(),null!==this.texture){d.bindTexture(d.TEXTURE_2D,this.texture);var t=new Uint8Array([255,255,255,255]);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,1,1,0,d.RGBA,d.UNSIGNED_BYTE,t)}else console.log("Texture create failed - null returned")}return t.unbind=function(){y.setTexture(null,0)},t.prototype.free=function(){d.deleteTexture(this.texture)},t.prototype.setWrap=function(t,e){d.bindTexture(d.TEXTURE_2D,this.texture),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,this.getWebGLWrap(t)),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,this.getWebGLWrap(e))},t.prototype.setFilter=function(t){d.bindTexture(d.TEXTURE_2D,this.texture),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,this.getWebGLFilter(t)),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,this.getWebGLFilter(t))},t.prototype.bind=function(t){void 0===t&&(t=0),y.setTexture(this,t)},t.prototype.loadFromImage=function(t){this.width=t.width,this.height=t.height,d.bindTexture(d.TEXTURE_2D,this.texture),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,t),s(t.width)&&s(t.height)?d.generateMipmap(d.TEXTURE_2D):(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR))},t.prototype.trySetAnisotropic=function(t){var e=d.getExtension("EXT_texture_filter_anisotropic")||d.getExtension("MOZ_EXT_texture_filter_anisotropic")||d.getExtension("WEBKIT_EXT_texture_filter_anisotropic");if(e){var i=d.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT),n=Math.min(t,i);d.texParameterf(d.TEXTURE_2D,e.TEXTURE_MAX_ANISOTROPY_EXT,n)}},t.prototype.getWebGLWrap=function(t){switch(t){case w.Repeat:return d.REPEAT;case w.MirrorRepeat:return d.MIRRORED_REPEAT;default:case w.ClampToEdge:return d.CLAMP_TO_EDGE}},t.prototype.getWebGLFilter=function(t){switch(t){case x.Linear:return d.LINEAR;default:case x.Nearest:return d.NEAREST}},t}(),ft=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),dt=(function(){}(),/(.*?)\t(\d*?)\t(\d*?)\t(\d*?)\t(\d*?)\t(\d*?)\t(\d*?)\t(\d*?)\t(\d*?)\t([r]?)/),yt=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._regions=[],e}return ft(e,t),e.prototype.free=function(){t.prototype.free.call(this)},e.prototype.getRegion=function(t){var e=this._regions.filter(function(e){return e.name===t});return 0===e.length?console.error("Can't find region '"+t+"'"):e.length>1&&console.error("Too many regions ("+e.length+") with name '"+t+"'"),e[0]},e.prototype.loadRegionInfo=function(t){for(var e=0,i=t.split("\n").slice(1);e<i.length;e++){var n=i[e];if(n&&0!==n.length){var r=dt.exec(n);r?this._regions.push({texture:this,name:r[1],tx:parseInt(r[2])/this.width,ty:parseInt(r[3])/this.height,tw:parseInt(r[4])/this.width,th:parseInt(r[5])/this.height,rotated:r.length>10&&"r"===r[10]}):console.error("TextureAtlas - can't parse line '"+n+"'")}}},e}(pt),mt=function(){function t(){}return t.prototype.load=function(t){return new Promise(function(e,i){var n=new yt,r=new Image;r.onload=function(o){n.loadFromImage(r),n.setFilter(t.filter),t.anisotropic>0&&n.trySetAnisotropic(t.anisotropic),console.log("Texture '"+t.imageFileSrc+"' loaded, width: "+r.width+", height: "+r.height),Z.getTextFromUrl(t.atlasFileSrc).then(function(t){n.loadRegionInfo(t),e(n)}).catch(function(t){return i(t)})},r.onerror=function(t){return i(t)},r.src=t.imageFileSrc})},t}(),vt=function(){function t(){}return t.prototype.load=function(t){return new Promise(function(e,i){var n=new pt,r=new Image;r.onload=function(i){n.loadFromImage(r),n.setFilter(t.filter),t.anisotropic>0&&n.trySetAnisotropic(t.anisotropic),console.log("Texture '"+t.imageFileSrc+"' loaded, width: "+r.width+", height: "+r.height),e(n)},r.onerror=function(t){return i(t)},r.src=t.imageFileSrc})},t}(),gt=function(){function t(){this._textureLoader=new vt,this._textureAtlasLoader=new mt,this._shaderLoader=new ct,this._materialLoader=new ut,this._soundLoader=new lt,this._fontLoader=new ht}return t.prototype.loadTexture=function(t){return this._textureLoader.load(t)},t.prototype.loadTextureAtlas=function(t){return this._textureAtlasLoader.load(t)},t.prototype.loadShaderProgram=function(t){return this._shaderLoader.load(t)},t.prototype.loadMaterial=function(t){return this._materialLoader.load(t,this._shaderLoader,this._textureLoader,this._textureAtlasLoader)},t.prototype.loadSound=function(t){return this._soundLoader.load(t)},t.prototype.loadFont=function(t){return this._fontLoader.load(t,this._materialLoader,this._shaderLoader,this._textureLoader,this._textureAtlasLoader)},t}(),wt=function(){function t(){this.matrix=new D,this.position=new c(0,0,0),this.visible=!0,this._dir=new c(0,0,0),this._right=new c(0,0,0),this._up=new c(0,0,0),this._parent=null,this._absoluteMatrix=new D,this.matrix.identity(),this.parent=null,this.updateVectorsFromMatrix()}return Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},set:function(t){this._parent!==t&&(this._parent=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"up",{get:function(){return this._up},set:function(t){if(t!==this._up){t.normalize();var e=t.cross(this._dir).negate().normalize(),i=e.cross(this._up).normalize();this.updateModelMatrix(i,t,e)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"direction",{get:function(){return this._dir},set:function(t){if(t!==this._dir){t.normalize();var e=this._up.cross(t).negate().normalize(),i=t.cross(e).normalize();this.updateModelMatrix(t,i,e)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._right},set:function(t){if(t!==this._right){t.normalize();var e=t.cross(this._up).normalize(),i=e.cross(t).normalize();this.updateModelMatrix(e,i,t)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"absoluteMatrix",{get:function(){return this.matrix.position=this.position,this._absoluteMatrix=null===this._parent?this.matrix:this._parent.absoluteMatrix.multiplyMat(this.matrix),this._absoluteMatrix},set:function(t){this._absoluteMatrix=t},enumerable:!0,configurable:!0}),t.prototype.free=function(){},t.prototype.renderSelf=function(){y.renderParams.model=this.absoluteMatrix,y.renderParams.calculateMVP(),this.updateVectorsFromMatrix(),this.visible&&this.doRender()},t.prototype.updateModelMatrix=function(t,e,i){this.matrix.e=[i.x,e.x,t.x,0,i.y,e.y,t.y,0,i.z,e.z,t.z,0,this.position.dot(i),this.position.dot(e),this.position.dot(t)],this._dir=t,this._up=e,this._right=i},t.prototype.updateVectorsFromMatrix=function(){this._right.set(this.matrix.e[0],this.matrix.e[4],this.matrix.e[8]),this._up.set(this.matrix.e[1],this.matrix.e[5],this.matrix.e[9]),this._dir.set(this.matrix.e[2],this.matrix.e[6],this.matrix.e[10])},t.prototype.doRender=function(){},t}(),xt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(t){t[t.Ortho=0]="Ortho",t[t.Perspective=1]="Perspective"}(tt||(tt={})),function(t){t[t.TopLeft=0]="TopLeft",t[t.Center=1]="Center",t[t.BottomRight=2]="BottomRight"}(et||(et={}));var bt,_t=function(t){function e(){var e=t.call(this)||this;return e.projectionMatrix=new D,e._scale=1,e.setProjectionParamsFull(0,0,y.width,y.height,45,.01,100,tt.Ortho,et.TopLeft),e.setViewParams(new c(0,0,100),new c(0,0,0),new c(0,1,0)),e}return xt(e,t),Object.defineProperty(e.prototype,"scale",{get:function(){return this._scale},set:function(t){t!==this._scale&&(this._scale=t,this.rebuildProjectionMatrix())},enumerable:!0,configurable:!0}),e.prototype.setProjectionParams=function(t,e,i,n){i=i<0?1:i,n=n<0?1:n,this._x=t,this._y=e,this._width=i,this._height=n,this.rebuildProjectionMatrix()},e.prototype.setProjectionParamsFull=function(t,e,i,n,r,o,s,a,h){this._fov=r,this._zNear=o,this._zFar=s,this._projectionMode=a,this._pivotMode=h,this.setProjectionParams(t,e,i,n)},e.prototype.setViewParams=function(t,e,i){this.matrix.identity(),this._up=i.normal(),this._dir=e.subtract(t).normal(),this._right=this._dir.cross(this._up).normal(),this._up=this._right.cross(this._dir).normal(),this.position=t,this._dir.negate(),this.matrix.e=[this._right.x,this._right.y,this._right.z,this._right.negateVector().dot(this.position),this._up.x,this._up.y,this._up.z,this._up.negateVector().dot(this.position),this._dir.x,this._dir.y,this._dir.z,this._dir.negateVector().dot(this.position),0,0,0,1],this.matrix=this.matrix.transpose(),this.updateVectorsFromMatrix()},e.prototype.translate=function(t,e,i){var n=this._up.multiplyNum(t).add(this._right.multiplyNum(e)).add(this._dir.multiplyNum(i));this.position.addToSelf(n)},e.prototype.rotate=function(t,e){this.matrix.rotate(t,e),this.updateVectorsFromMatrix()},e.prototype.screenToWorld=function(t){if(this._projectionMode===tt.Perspective)return console.error("Camera.ScreenToWorld() with perpective camera is not implemented"),new c(0,0,0);var e=(new p).set(this.position).addToSelf(t.multiplyNum(1/this._scale)),i=new p(0,0);switch(this._pivotMode){case et.Center:i.set(this._width/(2*this._scale),this._height/(2*this._scale));break;case et.BottomRight:i.set(this._width/this._scale,this._height/this._scale)}return e.subtractFromSelf(i),new c(e.x,e.y,0)},e.prototype.renderSelf=function(){},e.prototype.update=function(){this.matrix.position=new c(0,0,0),this.matrix.position=this.matrix.multiplyVec(this.position.negateVector()),y.renderParams.viewProjection=this.projectionMatrix.multiplyMat(this.matrix),y.renderParams.modelViewProjection=y.renderParams.viewProjection,this.updateVectorsFromMatrix(),y.width===this._width&&y.height===this._height||this.setProjectionParams(0,0,y.width,y.height)},e.prototype.rebuildProjectionMatrix=function(){switch(this.projectionMatrix.identity(),this._projectionMode){case tt.Perspective:this.projectionMatrix.perspective(this._fov,this._width/this._height,this._zNear,this._zFar);break;case tt.Ortho:var t=2*this._scale;switch(this._pivotMode){case et.TopLeft:this.projectionMatrix.ortho(0,this._width/this._scale,this._height/this._scale,0,this._zNear,this._zFar);break;case et.Center:this.projectionMatrix.ortho(-this._width/t,this._width/t,this._height/t,-this._height/t,this._zNear,this._zFar);break;case et.BottomRight:this.projectionMatrix.ortho(-this._width/t,0,0,-this._height/t,this._zNear,this._zFar)}}},e}(wt),Tt={textures:[{uniformName:"uDiffuse"}],color:new B(1,1,1,1),blend:M.Alpha,depthWrite:!0,depthTest:!0,depthTestFunc:C.Less,cull:S.Back},Mt={vertexShaderText:"\n  attribute vec3 vaCoord;\n  attribute vec2 vaTexCoord0;\n  attribute vec4 vaColor;\n  varying vec2 texCoord0;\n  varying vec4 vColor;\n  uniform mat4 uModelViewProj;\n\n  void main(void)\n  {\n    texCoord0 = vaTexCoord0;\n    vColor = vaColor;\n    gl_Position = uModelViewProj * vec4(vaCoord, 1.0);\n  }\n  ",fragmentShaderText:"\n  varying highp vec2 texCoord0;\n  varying highp vec4 vColor;\n  uniform sampler2D uDiffuse;\n  uniform highp vec4 uColor;\n\n  void main(void)\n  {\n    gl_FragColor = uColor * vColor * texture2D( uDiffuse, texCoord0 );\n    if (gl_FragColor.a < 0.001)\n      discard;\n  }\n  "},St={fontFileSrc:"assets/font.json",materialData:{textures:[{uniformName:"uDiffuse",textureData:{anisotropic:0,filter:x.Linear,imageFileSrc:"assets/font.png"}}],color:new B(1,1,1,1),blend:M.Alpha,depthWrite:!0,depthTest:!0,depthTestFunc:C.Less,cull:S.Back}},Ct={imageFileSrc:"assets/atlas.png",atlasFileSrc:"assets/atlas.atlas",filter:x.Nearest,anisotropic:0},Pt={imageFileSrc:"assets/planet.png",atlasFileSrc:"assets/planet.atlas",filter:x.Nearest,anisotropic:0},kt=function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{h(n.next(t))}catch(t){o(t)}}function a(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){t.done?r(t.value):new i(function(e){e(t.value)}).then(s,a)}h((n=n.apply(t,e||[])).next())})},At=function(t,e){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},Et=function(){function t(){this.loaders=new gt}return t.prototype.loadAll=function(){return kt(this,void 0,void 0,function(){var t,e,i,n,r,o,s;return At(this,function(a){switch(a.label){case 0:return this.gameCamera=new _t,this.guiCamera=new _t,t=this,[4,this.loaders.loadShaderProgram(Mt)];case 1:return t.shader=a.sent(),Tt.shaderProgram=this.shader,Tt.textures[0].texture=new pt,St.materialData.shaderProgram=this.shader,e=this,[4,this.loaders.loadMaterial(Tt)];case 2:return e.blankMaterial=a.sent(),i=this,[4,this.loaders.loadFont(St)];case 3:return i.font=a.sent(),n=this,[4,this.loaders.loadTextureAtlas(Ct)];case 4:return n.solarAtlas=a.sent(),Tt.textures[0].texture=void 0,Tt.textures[0].textureAtlas=this.solarAtlas,r=this,[4,this.loaders.loadMaterial(Tt)];case 5:return r.solarMaterial=a.sent(),o=this,[4,this.loaders.loadTextureAtlas(Pt)];case 6:return o.planetAtlas=a.sent(),Tt.textures[0].textureAtlas=this.planetAtlas,s=this,[4,this.loaders.loadMaterial(Tt)];case 7:return s.planetMaterial=a.sent(),[2,Promise.resolve()]}})})},t}(),Dt={actionManager:new G,tweener:new J,assets:new Et},Bt=function(){function t(t,e,i,n){var r=this;this.material=t,this.spriteBatch=e,this.textBatch=i,this.camera=n,this.enabled=!0,this.elements={},this.inputEventsSubscription=v.events.subscribe(function(t){return r.processInput(t)})}return t.prototype.free=function(){this.inputEventsSubscription.unsubscribe()},t.prototype.update=function(t){if(this.enabled)for(var e in this.elements){var i=this.elements[e];i.enabled&&i.update(t)}},t.prototype.render=function(){if(this.enabled){for(var t in this.material.bind(),this.spriteBatch.start(),this.textBatch.start(),this.elements){var e=this.elements[t];e.visible&&e.render(this.spriteBatch,this.textBatch)}this.spriteBatch.finish(),this.textBatch.finish()}},t.prototype.processInput=function(t){if(this.enabled)for(var e in this.elements){var i=this.elements[e];if(i.enabled)(!(-1!==[u.KeyDown,u.KeyUp,u.Wheel].indexOf(t.inputType))||i.focused)&&i.processInput(t)}},t.prototype.addElement=function(t){if(void 0!==this.elements[t.name])throw new Error("Element with name '"+t.name+"' already exists in GuiManager");this.elements[t.name]=t},t.prototype.removeElement=function(t){delete this.elements[t.name]},t.prototype.getElement=function(t){return this.elements[t]},t}(),Ot=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Rt=function(t){function e(e,i,n){var r=t.call(this)||this;return r.vertices=new Array(36),r._rotation=0,r._textureRegion=null,r._width=e||1,r._height=i||1,r._pivotPoint=n||new p(.5,.5),r.setDefaultVertices(),r.setDefaultTexCoords(),r.setVerticesColor(new B(1,1,1,1)),r}return Ot(e,t),e.getVerticesSize=function(){return 36},e.prototype.free=function(){t.prototype.free.call(this)},Object.defineProperty(e.prototype,"rotation",{get:function(){return this._rotation},set:function(t){a(this._rotation,t)||(this.matrix.identity(),this.matrix.rotate(t*o.deg2rad,l),this._rotation=t,this._rotation>360?this._rotation-=360:this._rotation<-360&&(this._rotation+=360))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(t){a(this._width,t)||(this._width=t,this.setDefaultVertices())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},set:function(t){a(this._height,t)||(this._height=t,this.setDefaultVertices())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pivotPoint",{get:function(){return this._pivotPoint},set:function(t){this._pivotPoint.equalTo(t)||(this._pivotPoint.set(t.x,t.y),this.setDefaultVertices())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return new p(this.width,this.height)},enumerable:!0,configurable:!0}),e.prototype.setDefaultVertices=function(){this.vertices[0]=(1-this.pivotPoint.x)*this._width,this.vertices[1]=(1-this.pivotPoint.y)*this._height,this.vertices[2]=0,this.vertices[9]=(1-this.pivotPoint.x)*this._width,this.vertices[10]=(0-this.pivotPoint.y)*this._height,this.vertices[11]=0,this.vertices[18]=(0-this.pivotPoint.x)*this._width,this.vertices[19]=(0-this.pivotPoint.y)*this._height,this.vertices[20]=0,this.vertices[27]=(0-this.pivotPoint.x)*this._width,this.vertices[28]=(1-this.pivotPoint.y)*this._height,this.vertices[29]=0},e.prototype.setDefaultTexCoords=function(){this.vertices[3]=1,this.vertices[4]=1,this.vertices[12]=1,this.vertices[13]=0,this.vertices[21]=0,this.vertices[22]=0,this.vertices[30]=0,this.vertices[31]=1},e.prototype.setFlippedTexCoords=function(){this.vertices[3]=1,this.vertices[4]=0,this.vertices[12]=1,this.vertices[13]=1,this.vertices[21]=0,this.vertices[22]=1,this.vertices[30]=0,this.vertices[31]=0},e.prototype.flipVerticallyCurrentTexCoords=function(){var t=0;t=this.vertices[30],this.vertices[30]=this.vertices[3],this.vertices[3]=t,t=this.vertices[12],this.vertices[12]=this.vertices[21],this.vertices[21]=t},e.prototype.flipHorizontallyCurrentTexCoords=function(){var t=0;t=this.vertices[4],this.vertices[4]=this.vertices[13],this.vertices[13]=t,t=this.vertices[22],this.vertices[22]=this.vertices[31],this.vertices[31]=t},e.prototype.setVerticesColor=function(t,e,i,n){if(t instanceof B)this.setVerticesColor(t.x,t.y,t.z,t.w);else{if(null==e||null==i||null==n)throw new Error("Not all args passed");for(var r=5;r<33;r+=9)this.vertices[r+0]=t,this.vertices[r+1]=e,this.vertices[r+2]=i,this.vertices[r+3]=n}},e.prototype.setVerticesAlpha=function(t){this.vertices[8]=t,this.vertices[17]=t,this.vertices[26]=t,this.vertices[35]=t},e.prototype.setSize=function(t,e){a(this._width,t)&&a(this._height,e)||(this._width=t,this._height=e,this.setDefaultVertices())},e.prototype.setSizeFromVector2=function(t){this.setSize(t.x,t.y)},e.prototype.multSize=function(t){this.setSize(this._width*t,this._height*t)},e.prototype.setTextureRegion=function(t,e){void 0===e&&(e=!0),this._textureRegion=t,t.rotated?(this.vertices[3]=t.tx,this.vertices[4]=t.ty+t.th,this.vertices[12]=t.tx+t.tw,this.vertices[13]=t.ty+t.th,this.vertices[21]=t.tx+t.tw,this.vertices[22]=t.ty,this.vertices[30]=t.tx,this.vertices[31]=t.ty,e&&this.setSize(t.th*t.texture.height,t.tw*t.texture.width)):(this.vertices[3]=t.tx+t.tw,this.vertices[4]=t.ty+t.th,this.vertices[12]=t.tx+t.tw,this.vertices[13]=t.ty,this.vertices[21]=t.tx,this.vertices[22]=t.ty,this.vertices[30]=t.tx,this.vertices[31]=t.ty+t.th,e&&this.setSize(t.tw*t.texture.width,t.th*t.texture.height))},e.prototype.setTextureCoords=function(t){this.vertices[3]=t[0],this.vertices[4]=t[1],this.vertices[12]=t[2],this.vertices[13]=t[3],this.vertices[21]=t[4],this.vertices[22]=t[5],this.vertices[30]=t[6],this.vertices[31]=t[7]},e.prototype.getTextureRegion=function(){return this._textureRegion},e.prototype.getVerticesWithAbsoluteMatrix=function(){for(var t=this.absoluteMatrix,e=[new c(this.vertices[0],this.vertices[1],this.vertices[2]),new c(this.vertices[9],this.vertices[10],this.vertices[11]),new c(this.vertices[18],this.vertices[19],this.vertices[20]),new c(this.vertices[27],this.vertices[28],this.vertices[29])],i=0;i<e.length;++i)e[i]=t.multiplyVec(e[i]);var n=this.vertices.slice();return n[0]=e[0].x,n[1]=e[0].y,n[2]=e[0].z,n[9]=e[1].x,n[10]=e[1].y,n[11]=e[1].z,n[18]=e[2].x,n[19]=e[2].y,n[20]=e[2].z,n[27]=e[3].x,n[28]=e[3].y,n[29]=e[3].z,n},e.prototype.renderSelf=function(){},e}(wt),Ft=[0,1,2,2,3,0],It=Rt.getVerticesSize(),Vt=function(){function t(){this._count=0,this._changed=!1,this._vertexData=new Array(65536),this._indexData=new Array(65536),this._vertexBuffer=new R(b.Pos3Tex2Col4,65536),this._indexBuffer=new E(_.Short,65536)}return t.prototype.free=function(){this._vertexBuffer.free(),this._indexBuffer.free()},t.prototype.start=function(){this._count=0},t.prototype.finish=function(){0!==this._count&&(this._changed&&(this._vertexBuffer.update(this._vertexData,0),this._indexBuffer.update(this._indexData,0)),y.renderParams.modelViewProjection=y.renderParams.viewProjection,y.drawTriangles(this._vertexBuffer,this._indexBuffer,0,6*this._count))},t.prototype.drawSingle=function(t){if(t.visible){for(var e=t.getVerticesWithAbsoluteMatrix(),i=0;i<It;++i)this._vertexData[this._count*It+i]=e[i];for(i=0;i<6;++i)this._indexData[6*this._count+i]=Ft[i]+4*this._count;++this._count,this._changed=!0}},t.prototype.drawArray=function(t){var e=this;t.forEach(function(t){return e.drawSingle(t)})},t}(),Nt=[0,1,2,2,3,0],zt=function(){function t(t){this.font=t,this._count=0,this._changed=!1,this._vertexData=new Array(65536),this._indexData=new Array(65536),this._textOrigin=new p,this._start=new p,this._vertexBuffer=new R(b.Pos3Tex2Col4,65536),this._indexBuffer=new E(_.Short,65536)}return t.prototype.free=function(){this._vertexBuffer.free(),this._indexBuffer.free()},t.prototype.start=function(){this._count=0},t.prototype.finish=function(){0!==this._count&&(this._changed&&(this._vertexBuffer.update(this._vertexData,0),this._indexBuffer.update(this._indexData,0)),this.font.material.bind(),y.renderParams.modelViewProjection=y.renderParams.viewProjection,y.drawTriangles(this._vertexBuffer,this._indexBuffer,0,6*this._count))},t.prototype.drawSingle=function(t){if(t.visible&&""!==t.text){t.maxTextWidth>0&&t.isWrapped&&this.wrapText(t),t.shadowEnabled&&this.drawShadow(t),this.calculateTextOrigin(t),this._start.set(this._textOrigin);for(var e=0,i=t.text;e<i.length;e++){var n=i[e];if("\n"!==n){if(this.font.hasFontData(n)){for(var r=this.font.getSymbolQuad(n,t.scale),o=r.positions[0].x,s=0;s<4;++s)r.positions[s].addToSelf(this._start),r.positions[s].multiplyMatSelf(t.absoluteMatrix),r.colors[s].set(t.color);for(var a=r.toArray(),h=0;h<36;++h)this._vertexData[36*this._count+h]=a[h];for(h=0;h<6;++h)this._indexData[6*this._count+h]=Nt[h]+4*this._count;this._start.x+=o+t.letterSpacing,++this._count,this._changed=!0}}else this._start.x=this._textOrigin.x,this._start.y+=t.scale*(t.lineSpacing+this.font.maxSymbolHeight)}}},t.prototype.drawArray=function(t){var e=this;t.forEach(function(t){return e.drawSingle(t)})},t.prototype.wrapText=function(t){for(var e=[],i=t.text.replace(/\s+/gm," ").split(/\s/gm),n=t.maxTextWidth,r=0,o=i;r<o.length;r++){var s=o[r],a=this.font.getTextLength(s,!0)*t.scale;a<n?(e.push(s+" "),n-=a):(e.push("\n"),e.push(s+" "),n=t.maxTextWidth-a)}t.isWrapped=!0,t.text=e.join("")},t.prototype.drawShadow=function(t){var e=(new c).set(t.position),i=(new B).set(t.color);t.position.addToSelf(t.shadowOffset),t.position.z-=1,t.color.set(t.shadowColor),t.shadowEnabled=!1,this.drawSingle(t),t.position.set(e),t.color.set(i),t.shadowEnabled=!0},t.prototype.calculateTextOrigin=function(t){for(var e=0,i=new p,n=0,r=t.text;n<r.length;n++){var o=r[n];if("\n"!==o){if(this.font.hasFontData(o)){var s=this.font.fontData[o];i.y<1&&s.height>0&&(i.y=this.font.maxSymbolHeight+t.lineSpacing),e+=s.width+t.letterSpacing}}else i.y+=this.font.maxSymbolHeight+t.lineSpacing,e>i.x&&(i.x=e),e=0}i.x=Math.max(i.x,e),i.multiplyNumSelf(t.scale),this._textOrigin.set(i).multiplyNumSelf(-1).multiplyVecSelf(t.pivotPoint)},t}(),Lt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(bt||(bt={}));var Ut,jt,Ht,Wt=function(t){function e(e){void 0===e&&(e="");var i=t.call(this)||this;return i.text=e,i.lineSpacing=2,i.letterSpacing=0,i.color=new B(1,1,1,1),i.scale=1,i.shadowEnabled=!1,i.shadowOffset=new p(0,0),i.shadowColor=new B(0,0,0,.5),i.pivotPoint=new p(0,0),i.horizontalAlignment=bt.Left,i._maxTextWidth=0,i._isWrapped=!0,i}return Lt(e,t),e.prototype.free=function(){t.prototype.free.call(this)},Object.defineProperty(e.prototype,"maxTextWidth",{get:function(){return this._maxTextWidth},set:function(t){a(this._maxTextWidth,t)||(this._maxTextWidth=t,this._isWrapped=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isWrapped",{get:function(){return this._isWrapped},set:function(t){this._isWrapped=t},enumerable:!0,configurable:!0}),e.prototype.renderSelf=function(){},e}(wt),Gt=function(){function t(){var t=Dt.assets.planetAtlas.getRegion("blank.png");this.background=new Rt(y.width-20,120,new p(.5,.5)),this.background.position.set(y.width/2,this.background.height/2+10,10),this.background.setVerticesColor(1,1,1,.3),this.background.setTextureRegion(t,!1),this.text=new Wt,this.text.pivotPoint.set(.5,.5),this.text.parent=this.background,this.text.color.set(.2,.2,.2,1),this.text.maxTextWidth=this.background.width-10,this.text.isWrapped=!0,this.text.position.set(0,0,15)}return t.prototype.getSpritesToRender=function(){return[this.background]},t.prototype.getTextsToRender=function(){return[this.text]},t}(),Kt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Xt=function(){function t(){this.velocity=new p}return t.prototype.onActivate=function(){this.pause=0,this.t=0,this.lifeTime=0,this.velocity.set(0,0)},t.prototype.onDeactivate=function(){},t}(),Qt=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.sprite=new Rt,e}return Kt(e,t),e.prototype.onActivate=function(){t.prototype.onActivate.call(this),this.sprite.visible=!0,this.sprite.rotation=0,this.sprite.setVerticesColor(1,1,1,1)},e.prototype.onDeactivate=function(){t.prototype.onDeactivate.call(this),this.sprite.visible=!1},e.prototype.updateParams=function(t){this.sprite.position.addToSelf(this.velocity.multiplyNum(t));var e=(this.lifeTime-this.t)/this.lifeTime;this.sprite.setVerticesAlpha(e),this.velocity.multiplyNumSelf(1-.08*Math.random())},e.prototype.getSpritesToRender=function(){return[this.sprite]},e.prototype.getTextsToRender=function(){return[]},e}(Xt),Yt=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.text=new Wt,e}return Kt(e,t),e.prototype.onActivate=function(){t.prototype.onActivate.call(this),this.text.visible=!0,this.text.color.set(1,1,1,1)},e.prototype.onDeactivate=function(){t.prototype.onDeactivate.call(this),this.text.visible=!1},e.prototype.updateParams=function(t){this.text.position.addToSelf(this.velocity.multiplyNum(t));var e=(this.lifeTime-this.t)/this.lifeTime;this.text.color.w=e,this.text.shadowEnabled&&(this.text.shadowColor.w=e),this.velocity.multiplyNumSelf(1-.08*Math.random())},e.prototype.getSpritesToRender=function(){return[]},e.prototype.getTextsToRender=function(){return[this.text]},e}(Xt),qt=function(t){function e(e,i,n){var r=t.call(this,i,n)||this;return r.renderHelper=e,r.visible=!0,r}return Kt(e,t),e.prototype.update=function(t){var e=this;this.visible&&this.poolObjects.forEach(function(i){i.active&&(i.pause>0?i.pause-=t:(i.t+=t,i.t>=i.lifeTime?e.return(i):i.updateParams(t)))})},e.prototype.render=function(){this.renderHelper.render(this.poolObjects.filter(function(t){return t.pause<=0}))},e}(j),$t=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Kt(e,t),e}(qt),Jt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Kt(e,t),e}(qt),Zt=function(){function t(){}return t.createSmallParticle=function(){var t=new Qt;t.sprite.position.set(0,0,50);var e=Dt.assets.solarAtlas.getRegion("circle.png");return t.sprite.setTextureRegion(e,!1),t},t.createTextParticle=function(){var t=new Yt;return t.text.position.set(0,0,50),t},t.emitHit=function(t,e){for(var i=0;i<32;++i){var n=t.get(),r=5+5*Math.random();n.sprite.setSize(r,r),n.sprite.setDefaultVertices(),n.sprite.position.set(e).addToSelf(new p(5-10*Math.random(),5-10*Math.random())),n.sprite.rotation=360*Math.random(),n.sprite.setVerticesColor(.9+.1*Math.random(),.2+.1*Math.random(),0+.1*Math.random(),1),n.pause=.1*Math.random(),n.lifeTime=1+.6*Math.random(),n.velocity=p.fromAngle(360*Math.random()).multiplyNumSelf(60+140*Math.random())}},t.emitHitWithShield=function(t,e){for(var i=0;i<32;++i){var n=t.get(),r=5+5*Math.random();n.sprite.setSize(r,r),n.sprite.setDefaultVertices(),n.sprite.position.set(e).addToSelf(new p(5-10*Math.random(),5-10*Math.random())),n.sprite.rotation=360*Math.random(),i<16?n.sprite.setVerticesColor(1,.8,.2,1):n.sprite.setVerticesColor(.1,.2,1,1),n.pause=.1*Math.random(),n.lifeTime=.6+Math.random(),n.velocity=p.fromAngle(360*Math.random()).multiplyNumSelf(60+140*Math.random())}},t.emitCellBoom=function(t,e){for(var i=0;i<64;++i){var n=t.get(),r=1+10*Math.random();n.sprite.setSize(r,r),n.sprite.setDefaultVertices(),n.sprite.position.set(e).addToSelf(new p(5-10*Math.random(),5-10*Math.random())),n.sprite.rotation=360*Math.random(),n.sprite.setVerticesColor(1,.1,.1,1),n.pause=.2*Math.random(),n.lifeTime=2+Math.random(),n.velocity=p.fromAngle(360*Math.random()).multiplyNumSelf(140+100*Math.random())}},t.emitDamageCount=function(t,e,i,n,r){var o=t.get();o.text.text=i.toString(),o.text.color.set(n),o.text.position.set(e),o.text.shadowEnabled=!0,o.text.shadowOffset.set(1,1),o.text.shadowColor.set(0,0,0,1),o.text.scale=r,o.lifeTime=1.6,o.pause=0,o.velocity=p.fromAngle(60*Math.random()-120).multiplyNumSelf(140+100*Math.random())},t}(),te=new(function(){return function(){}}()),ee=function(){function t(t,e){var i=Dt.assets.planetAtlas.getRegion("health_bar_back.png"),n=Dt.assets.planetAtlas.getRegion("health_bar.png");this.back=new Rt(1,1,new p(0,0)),this.back.position.set(t,e,2),this.back.setTextureRegion(i,!0),this.current=new Rt(1,1,new p(0,0)),this.current.parent=this.back,this.current.position.set(5,5,this.back.position.z+1),this.current.setTextureRegion(n,!0),this.text=new Wt,this.text.position.set(0,0,this.back.position.z+2),this.text.pivotPoint.set(.5,0),this.text.parent=this.current,this.text.color.set(1,1,1,1),this.originalWidth=this.current.width}return t.prototype.updateHealth=function(t,e){var i=this.originalWidth*(t/e);this.current.width=i,this.text.text=t.toString(),this.text.visible=t>0,this.text.position.x=i/2},t}(),ie=function(){return function(t,e,i,n,r){this.caption=new Wt(t),this.caption.position.set(i,n,1),this.caption.color.set(1,1,1,1),this.value=new Wt(e),this.value.parent=this.caption,this.value.position.set(r,0,1),this.value.color.set(1,1,1,1),this.value.letterSpacing=1.5}}();!function(t){t[t.Heal=0]="Heal",t[t.MoreAttackCount=1]="MoreAttackCount",t[t.MoreProtectCount=2]="MoreProtectCount",t[t.IncreaseCriticalChance=3]="IncreaseCriticalChance"}(Ut||(Ut={})),function(t){t[t.Weapon=0]="Weapon",t[t.Shield=1]="Shield",t[t.Engine=2]="Engine",t[t.Misc=3]="Misc",t[t.Consumable=4]="Consumable"}(jt||(jt={})),function(t){t[t.Usual=0]="Usual",t[t.Special=1]="Special",t[t.Legendary=2]="Legendary"}(Ht||(Ht={}));var ne,re=function(){function t(){}return t.attackDamageMinMaxSummary=function(t){for(var e=0,i=0,n=0,r=this.get(t,jt.Weapon);n<r.length;n++){var o=r[n];if(!o.weapon)throw new Error("Type is weapon, but no weapon data provided");e+=o.weapon.damageMin,i+=o.weapon.damageMax}return e+"–"+i},t.attackCount=function(t){for(var e=0,i=0,n=this.get(t,jt.Weapon);i<n.length;i++){var r=n[i];if(!r.weapon)throw new Error("Type is weapon, but no weapon data provided");++e,r.weapon.addAttack&&(e+=r.weapon.addAttack)}return e},t.protectCount=function(t){for(var e=0,i=0,n=this.get(t,jt.Shield);i<n.length;i++){var r=n[i];if(!r.shield)throw new Error("Type is shield, but no shield data provided");++e,r.shield.addProtect&&(e+=r.shield.addProtect)}return e},t.protectSummary=function(t){for(var e=[],i=0,n=this.get(t,jt.Shield);i<n.length;i++){var r=n[i];if(!r.shield)throw new Error("Type is shield, but no shield data provided");e.push(1+(r.shield.addProtect||0)+" x "+r.shield.shieldMultiplier)}return e.join("\n")||"—"},t.criticalChanceSummary=function(t){var e=this.criticalChance(t);return Math.floor(100*e)+" %"},t.criticalMultiplierSummary=function(t){return 100*this.criticalMultiplier(t)+" %"},t.calculateDamages=function(t){for(var e=[],i=0,n=this.get(t,jt.Weapon);i<n.length;i++){var r=n[i];if(!r.weapon)throw new Error("Type is weapon, but no weapon data provided");var o=r.weapon.damageMin+Math.random()*(r.weapon.damageMax-r.weapon.damageMin),s=!1;Math.random()<=this.criticalChance(t)&&(o*=t.criticalMultiplier,s=!0),e.push({damage:o,isCritical:s,shieldPiercing:r.weapon.shieldPiercing||0})}return e},t.criticalChance=function(t){for(var e=this.get(t,jt.Weapon),i=t.criticalChance,n=0,r=e;n<r.length;n++){var o=r[n];if(!o.weapon)throw new Error("Type is weapon, but no weapon data provided");i+=o.weapon.criticalChanceMultiplier||0}return i},t.criticalMultiplier=function(t){return t.criticalMultiplier},t.calculateProtections=function(t){for(var e=[],i=0,n=this.get(t,jt.Shield);i<n.length;i++){var r=n[i];if(!r.shield)throw new Error("Type is shield, but no shield data provided");var o=r.shield.shieldMultiplier;e.push({protectionMultiplier:o})}return e},t.get=function(t,e){return t.cells.filter(function(t){return!!t.item&&t.item.type===e}).map(function(t){return t.item})},t}(),oe=(function(){}(),function(){}(),function(){function t(t,e){void 0===t&&(t=new p),void 0===e&&(e=new p),this.center=t,this.halfSize=new p(e.x/2,e.y/2)}return t.prototype.overlaps=function(e){return e instanceof t?!(Math.abs(this.center.x-e.center.x)>this.halfSize.x+e.halfSize.x)&&!(Math.abs(this.center.y-e.center.y)>this.halfSize.y+e.halfSize.y):e.overlaps(this)},t.prototype.hit=function(t){return!(Math.abs(this.center.x-t.x)>this.halfSize.x)&&!(Math.abs(this.center.y-t.y)>this.halfSize.y)},t}()),se=function(){},ae=function(){function t(){this.name="Element_"+t.defaultNameIncrementNumber++,this.focused=!1,this.enabled=!0,this.visible=!0,this.onClick=se,this.onTouchDown=se,this.onTouchUp=se,this.onTouchMove=se,this.onMouseOver=se,this.onMouseOut=se,this.onEnable=se,this.onFocus=se,this.zIndex=0,this.hitBox=new oe,this._isMouseOver=!1}return t.prototype.processInput=function(t){var e=!1;switch(t.inputType){case u.TouchDown:e=this.hitBox.hit(new p(t.x,t.y)),this.focused=e,e&&this.onTouchDown(this,t);break;case u.TouchUp:if(!(e=this.hitBox.hit(new p(t.x,t.y))))break;this.onTouchUp(this,t),this.focused&&this.onClick(this,t);break;case u.TouchMove:if(e=this.hitBox.hit(new p(t.x,t.y))){if(this.onTouchMove(this,t),this._isMouseOver)break;this._isMouseOver=!0,this.onMouseOver(this,t)}else{if(!this._isMouseOver)break;this._isMouseOver=!1,this.onMouseOut(this,t)}}},t.defaultNameIncrementNumber=0,t}(),he=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),ue=function(t){function e(){var e=t.call(this)||this;return e.hitBox=new oe,e.sprite=new Rt,e.label=new Wt("Button"),e.label.pivotPoint.set(.5,.5),e.label.parent=e.sprite,e}return he(e,t),e.prototype.render=function(t,e){t.drawSingle(this.sprite),this.label.position.z=this.sprite.position.z+1,e.drawSingle(this.label)},e.prototype.update=function(t){},e.prototype.updateHitBox=function(){this.hitBox.center.set(.5,.5).subtractFromSelf(this.sprite.pivotPoint).multiplyVecSelf(this.sprite.width,this.sprite.height).addToSelf(this.sprite.absoluteMatrix.position),this.hitBox.halfSize.set(this.sprite.width/2,this.sprite.height/2)},e}(ae),ce=function(){function t(t,e,i,n){var r=this;if(null==t.consumable)throw new Error("Item type is consumable but no consumable data found");this.count=t.consumable.count;var o=Dt.assets.planetAtlas.getRegion("blank.png");this.background=new ue,this.background.sprite.setSize(70,70),this.background.sprite.position.set(e,i,2),this.background.sprite.setVerticesColor(1,1,1,.3),this.background.sprite.setTextureRegion(o,!1),this.background.onMouseOver=function(){return r.background.sprite.setVerticesAlpha(.7)},this.background.onMouseOut=function(){return r.background.sprite.setVerticesAlpha(.3)},this.countText=new Wt,this.countText.pivotPoint.set(1,1),this.countText.position.set(this.background.sprite.width/2-5,this.background.sprite.height/2-5,4),this.countText.color.set(1,1,1,1),this.countText.shadowEnabled=!0,this.countText.shadowColor.set(0,0,0,1),this.countText.shadowOffset.set(1,2),this.countText.parent=this.background.sprite,this.updateCountText(),this.effectText=new Wt,this.effectText.pivotPoint.set(.5,.5),this.effectText.position.set(0,-12,3),this.effectText.color.set(1,1,1,1),this.effectText.shadowEnabled=!0,this.effectText.shadowColor.set(0,0,0,1),this.effectText.shadowOffset.set(1,2),this.effectText.parent=this.background.sprite,n.addElement(this.background)}return t.prototype.isMouseOver=function(t){return this.background.hitBox.hit(t)},t.prototype.canUse=function(t,e){return this.count>0},t.prototype.use=function(t,e){this.internalUse(t,e),--this.count,this.updateCountText()},t.prototype.updateCountText=function(){this.countText.text=this.count.toString()},t}(),le=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),pe=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n,r)||this;return o.name="+1 Атака",o.removeAfterNumberOfTurns=0,o.background.sprite.setVerticesColor(.7,.1,.1,.3),o.effectText.text="+А",o}return le(e,t),e.prototype.internalUse=function(t,e){++t.attacksLeft},e.prototype.removeEffect=function(t,e){},e}(ce),fe=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),de=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n,r)||this;return o.name="Повысить вероятность крит. урона",o.removeAfterNumberOfTurns=1,o.background.sprite.setVerticesColor(.7,.7,.1,.3),o.effectText.text="+К",o}return fe(e,t),e.prototype.internalUse=function(t,e){t.playerData.criticalChance+=.3},e.prototype.removeEffect=function(t,e){t.playerData.criticalChance-=.3},e}(ce),ye=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),me=function(){function t(t,e,i,n,r){var o=this;this.cells=[],this.onClick=function(t){};for(var s=function(t){var s=i+t%8*59,u=n+59*h(t,8),c=e.length>t?e[t]:void 0,l=new ve(s,u,r,c);l.back.onClick=function(){return o.onClick(l)},a.cells.push(l)},a=this,u=0;u<t;++u)s(u)}return t.prototype.getSpritesToRender=function(){for(var t=[],e=0,i=this.cells;e<i.length;e++){var n=i[e];null!=n.item&&t.push(n.item.sprite)}return t},t.prototype.getTextsToRender=function(){return[]},t}(),ve=function(){function t(t,e,i,n){var r=this,o=Dt.assets.planetAtlas.getRegion("inventory_cell.png");this.back=new ue,this.back.sprite.position.set(t,e,5),this.back.sprite.setTextureRegion(o,!0),this.back.sprite.setVerticesAlpha(.5),this.back.label.visible=!1,this.back.updateHitBox(),this.back.onMouseOver=function(){return r.back.sprite.setVerticesAlpha(.7)},this.back.onMouseOut=function(){return r.back.sprite.setVerticesAlpha(.5)},i.addElement(this.back),null!=n&&(this.item=ge.build(n),this.setItem(this.item))}return t.prototype.setItem=function(t){if(this.item=t,this.item)switch(this.item.sprite.parent=this.back.sprite,this.item.rarity){case Ht.Usual:this.back.sprite.setVerticesColor(1,1,1,.5);break;case Ht.Special:this.back.sprite.setVerticesColor(.5,.5,1,.5);break;case Ht.Legendary:this.back.sprite.setVerticesColor(206/255,92/255,0,.5)}else this.back.sprite.setVerticesColor(1,1,1,.5)},t}(),ge=function(){function t(){}return t.build=function(t){var e,i;switch(t.type){case jt.Weapon:if(null==t.weapon)throw new Error("ItemType is weapon but no weapon data provided");var n=new we;n.damageMin=t.weapon.damageMin,n.damageMax=t.weapon.damageMax,n.shieldPiercing=t.weapon.shieldPiercing,n.criticalChanceMultiplier=t.weapon.criticalChanceMultiplier,n.addAttack=t.weapon.addAttack,e="laser1.png",i=n;break;case jt.Shield:if(null==t.shield)throw new Error("ItemType is shield but no shield data provided");var r=new xe;r.shieldMultiplier=t.shield.shieldMultiplier,r.addProtect=t.shield.addProtect,e="shield1.png",i=r;break;case jt.Engine:if(null==t.engine)throw new Error("ItemType is engine but no engine data provided");var o=new be;o.dodgeMultiplier=t.engine.dodgeMultiplier,o.speedBoost=t.engine.speedBoost,e="",i=o;break;case jt.Misc:if(null==t.misc)throw new Error("ItemType is misc but no misc data provided");var s=new _e;s.count=t.misc.count,e="",i=s;break;case jt.Consumable:if(null==t.consumable)throw new Error("ItemType is consumable but no consumable data provided");var a=new Te;a.count=t.consumable.count,a.consType=t.consumable.type,e="",i=a;break;default:throw new Error("Unknown item type: "+t.type)}i.cost=t.cost,i.name=t.name,i.rarity=t.rarity,i.type=t.type;var h=Dt.assets.planetAtlas.getRegion(e||"blank.png");return i.sprite=new Rt(40,40),i.sprite.setTextureRegion(h,!!e),i.sprite.position.set(0,0,6),i.sprite.rotation=45,i.sprite.width*=.6,i.sprite.height*=.6,i.sprite.setDefaultVertices(),i},t.prototype.toItemData=function(){return{cost:this.cost,name:this.name,rarity:this.rarity,type:this.type}},t}(),we=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ye(e,t),e.prototype.toItemData=function(){var e=t.prototype.toItemData.call(this);return e.weapon={damageMin:this.damageMin,damageMax:this.damageMax,shieldPiercing:this.shieldPiercing,criticalChanceMultiplier:this.criticalChanceMultiplier,addAttack:this.addAttack},e},e}(ge),xe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ye(e,t),e.prototype.toItemData=function(){var e=t.prototype.toItemData.call(this);return e.shield={shieldMultiplier:this.shieldMultiplier,addProtect:this.addProtect},e},e}(ge),be=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ye(e,t),e.prototype.toItemData=function(){var e=t.prototype.toItemData.call(this);return e.engine={dodgeMultiplier:this.dodgeMultiplier,speedBoost:this.speedBoost},e},e}(ge),_e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ye(e,t),e.prototype.toItemData=function(){var e=t.prototype.toItemData.call(this);return e.misc={count:this.count},e},e}(ge),Te=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ye(e,t),e.prototype.toItemData=function(){var e=t.prototype.toItemData.call(this);return e.consumable={count:this.count,type:this.consType},e},e}(ge),Me=function(){function t(t,e,i,n){var r=this,o=Dt.assets.planetAtlas.getRegion("ship_cell.png");this.cellSprite=new ue,this.cellSprite.label.visible=!1,this.cellSprite.sprite.setTextureRegion(o,!0),this.cellSprite.sprite.position.set(e+t.position.x,i+t.position.y,2),this.cellSprite.sprite.setVerticesAlpha(.3),this.cellSprite.onMouseOver=function(){return r.cellSprite.sprite.setVerticesAlpha(.7)},this.cellSprite.onMouseOut=function(){return r.cellSprite.sprite.setVerticesAlpha(.3)},this.cellSprite.updateHitBox(),n.addElement(this.cellSprite),this._originalPosition=(new p).set(t.position),this.setItem(t.item?ge.build(t.item):void 0)}return t.prototype.setItem=function(t){this.item=t,this.item&&(this.item.sprite.parent=this.cellSprite.sprite)},t.prototype.toShipCellData=function(){return{position:this._originalPosition,item:this.item?this.item.toItemData():void 0}},t}(),Se=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ce=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n,r)||this,s=Dt.assets.planetAtlas.getRegion("inventory_cell_selected.png");return o.protectMark=new Rt(70,70),o.protectMark.position.set(0,0,15),o.protectMark.parent=o.cellSprite.sprite,o.protectMark.visible=!1,o.protectMark.setVerticesColor(.3,.3,1,1),o.protectMark.setTextureRegion(s,!0),o.protectMark.setSize(1.34*o.protectMark.width,1.34*o.protectMark.height),o.attackMark=new Rt(15,15),o.attackMark.position.set(0,0,15),o.attackMark.parent=o.cellSprite.sprite,o.attackMark.visible=!1,o.attackMark.setVerticesColor(1,.3,.3,1),o.attackMark.setTextureRegion(s,!0),o.attackMark.setSize(.8*o.attackMark.width,.8*o.attackMark.height),o}return Se(e,t),e.prototype.markAsProtected=function(){this.markedAsProtected=!0,this.protectMark.visible=!0},e.prototype.markAsAttacked=function(){this.markedAsAttacked=!0,this.attackMark.visible=!0},e.prototype.isMouseOver=function(t){return this.cellSprite.hitBox.hit(t)},e.prototype.reset=function(){this.protectMark.visible=this.attackMark.visible=!1,this.markedAsAttacked=!1,this.markedAsProtected=!1},e}(Me),Pe=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),ke=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n,r)||this;return o.removeAfterNumberOfTurns=0,o._amount=30,o.background.sprite.setVerticesColor(.1,.7,.1,.3),o.effectText.text="+Л",o}return Pe(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return"Вылечить "+this._amount+" единиц здоровья"},enumerable:!0,configurable:!0}),e.prototype.canUse=function(e,i){return t.prototype.canUse.call(this,e,i)&&e.playerData.shipHealth<e.playerData.shipMaxHealth},e.prototype.internalUse=function(t,e){t.playerData.shipHealth=Math.min(t.playerData.shipHealth+this._amount,t.playerData.shipMaxHealth),t.updateHealth()},e.prototype.removeEffect=function(t,e){},e}(ce);!function(t){t[t.Human=0]="Human",t[t.Ai=1]="Ai"}(ne||(ne={}));var Ae,Ee=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),De=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n,r)||this;return o.name="+1 Защита",o.removeAfterNumberOfTurns=0,o.background.sprite.setVerticesColor(.1,.1,.7,.3),o.effectText.text="+Щ",o}return Ee(e,t),e.prototype.internalUse=function(t,e){++t.protectsLeft},e.prototype.removeEffect=function(t,e){},e}(ce),Be=function(){function t(){this.shipCells=[],this.playerStats=[],this.consumableItems=[],this.activeItems=[]}return t.build=function(e,i,n){var r=new t;r.type=i,r.playerData=e;r.background=new Rt(400,y.height-150,new p(0,0)),r.background.setVerticesColor(52/255,111/255,149/255,1);var o=Dt.assets.planetAtlas.getRegion("blank.png");switch(r.background.setTextureRegion(o,!1),r.type){case ne.Human:r.background.position.set(10,140,1),r.background.setVerticesColor(.3,.4,.3,1);break;case ne.Ai:r.background.position.set(y.width-10-r.background.width,140,1),r.background.setVerticesColor(.4,.3,.3,1)}r.playerStats.push(new ie("Урон (сумм)","",10,340,250),new ie("Крит. шанс","",10,365,250),new ie("Крит. урон","",10,390,250),new ie("Щит","",10,415,250));for(var s=0,a=r.playerStats;s<a.length;s++){a[s].caption.parent=r.background}for(var h=new p(190,130),u=0,c=e.cells;u<c.length;u++){var l=c[u],f=new Ce(l,h.x,h.y,n);f.cellSprite.sprite.parent=r.background,f.cellSprite.updateHitBox(),r.shipCells.push(f)}r.health=new ee(20,30),r.health.back.parent=r.background;for(var d=0,m=0,v=e.inventory.filter(function(t){return t.type===jt.Consumable});m<v.length;m++){var g=v[m],w=void 0;if(null==g.consumable)throw new Error("Item type is consumable but no consumable data found");switch(g.consumable.type){case Ut.Heal:w=new ke(g,45+80*d++,r.background.height-45,n);break;case Ut.IncreaseCriticalChance:w=new de(g,45+80*d++,r.background.height-45,n);break;case Ut.MoreAttackCount:w=new pe(g,45+80*d++,r.background.height-45,n);break;case Ut.MoreProtectCount:w=new De(g,45+80*d++,r.background.height-45,n);break;default:throw new Error("Unknown item type: "+g.type)}w.background.sprite.parent=r.background,w.background.updateHitBox(),r.consumableItems.push(w)}return r.updateHealth(),r.updateStats(),r.resetTurnState(),r},t.prototype.getSpritesToRender=function(){for(var t=[this.background,this.health.back,this.health.current],e=0,i=this.shipCells;e<i.length;e++){var n=i[e];t.push(n.cellSprite.sprite),n.item&&t.push(n.item.sprite),t.push(n.attackMark,n.protectMark)}for(var r=0,o=this.consumableItems;r<o.length;r++){var s=o[r];t.push(s.background.sprite)}return t},t.prototype.getTextsToRender=function(){for(var t=[this.health.text],e=0,i=this.playerStats;e<i.length;e++){var n=i[e];t.push(n.caption,n.value)}for(var r=0,o=this.consumableItems;r<o.length;r++){var s=o[r];t.push(s.countText,s.effectText)}return t},t.prototype.updateHealth=function(){this.health.updateHealth(this.playerData.shipHealth,this.playerData.shipMaxHealth)},t.prototype.resetTurnState=function(){for(var t=0,e=this.shipCells;t<e.length;t++){e[t].reset()}this.attacksLeft=re.attackCount(this.playerData),this.protectsLeft=re.protectCount(this.playerData);for(var i=0,n=this.activeItems;i<n.length;i++){var r=n[i];--r.roundLeft>0||r.item.removeEffect(this,r.other)}this.activeItems=this.activeItems.filter(function(t){return t.roundLeft>0})},t.prototype.hasProtectsLeft=function(){return this.protectsLeft>0},t.prototype.hasAttacksLeft=function(){return this.attacksLeft>0},t.prototype.isOwnCell=function(t){return this.shipCells.some(function(e){return e===t})},t.prototype.markAsProtect=function(t){if(!this.hasProtectsLeft())throw new Error("No protects left");if(!this.isOwnCell(t))throw new Error("Wrong cell to protect, perhaps it is enemy's one");t.markAsProtected(),--this.protectsLeft},t.prototype.markAsAttack=function(t){if(!this.hasAttacksLeft())throw new Error("No attacks left");if(this.isOwnCell(t))throw new Error("Wrong cell to attack, perhaps it is yours");t.markAsAttacked(),--this.attacksLeft},t.prototype.aiChooseProtectAndAttack=function(t){for(var e,i=!1;this.hasProtectsLeft();){var n=this.shipCells.filter(function(t){return!t.markedAsProtected});if(0===n.length)break;e=n[Math.floor(Math.random()*n.length)],this.markAsProtect(e),i=!0}for(;this.hasAttacksLeft();){var r=t.shipCells.filter(function(t){return!t.markedAsAttacked});if(0===r.length)break;e=r[Math.floor(Math.random()*r.length)],this.markAsAttack(e),i=!0}return i},t.prototype.updateStats=function(){this.playerStats[0].value.text=re.attackDamageMinMaxSummary(this.playerData),this.playerStats[1].value.text=re.criticalChanceSummary(this.playerData),this.playerStats[2].value.text=re.criticalMultiplierSummary(this.playerData),this.playerStats[3].value.text=re.protectSummary(this.playerData)},t.prototype.hit=function(t){this.playerData.shipHealth-=t,this.playerData.shipHealth<0&&(this.playerData.shipHealth=0),this.updateHealth()},t.prototype.isAlive=function(){return this.playerData.shipHealth>0},t}(),Oe=function(){function t(t,e){this.spriteMaterial=e,this.spriteBatch=new Vt,this.textBatch=new zt(t)}return t.prototype.render=function(t){var e=this;this.spriteMaterial.bind(),this.spriteBatch.start(),this.textBatch.start(),t.forEach(function(t){e.spriteBatch.drawArray(t.getSpritesToRender()),e.textBatch.drawArray(t.getTextsToRender())}),this.spriteBatch.finish(),this.textBatch.finish()},t}(),Re=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(t){t[t.Start=0]="Start",t[t.HumanTurnProtect=1]="HumanTurnProtect",t[t.HumanTurnAttack=2]="HumanTurnAttack",t[t.AiTurn=3]="AiTurn",t[t.Animation=4]="Animation",t[t.Victory=5]="Victory",t[t.Defeat=6]="Defeat"}(Ae||(Ae={}));var Fe,Ie,Ve=function(t){function e(){return t.call(this)||this}return Re(e,t),e.prototype.load=function(){return console.log("Fight scene is loaded"),this.guiManager=new Bt(Dt.assets.planetMaterial,new Vt,new zt(Dt.assets.font),Dt.assets.guiCamera),this.actionManager=new G,this.renderHelper=new Oe(Dt.assets.font,Dt.assets.planetMaterial),this.emitter=new $t(this.renderHelper,function(){return Zt.createSmallParticle()},64),this.textEmitter=new Jt(this.renderHelper,function(){return Zt.createTextParticle()},8),this.dialog=new Gt,this.reset(),t.prototype.load.call(this)},e.prototype.render=function(){Dt.assets.gameCamera.update(),this.renderHelper.render([this.human,this.enemy,this.dialog]),this.emitter.render(),this.textEmitter.render()},e.prototype.update=function(t){this.guiManager.update(t),this.actionManager.update(t),this.emitter.update(t),this.textEmitter.update(t)},e.prototype.onKeyDown=function(t){},e.prototype.onMouseDown=function(t,e){if(e===f.LeftButton){var i=Dt.assets.gameCamera.screenToWorld(t).asVector2();if(this.checkItemsClick(i),this.fightState===Ae.HumanTurnProtect){if((n=this.human.shipCells.filter(function(t){return t.isMouseOver(i)})).length>1)throw new Error("Hit too many cells");if(0===n.length)return;if((r=n[0]).markedAsProtected)return void console.log("Cell is already protected");this.human.markAsProtect(r),this.canUseConsumableItems=!1,this.setFightState(Ae.HumanTurnProtect)}else if(this.fightState===Ae.HumanTurnAttack){var n,r;if((n=this.enemy.shipCells.filter(function(t){return t.isMouseOver(i)})).length>1)throw new Error("Hit too many cells");if(0===n.length)return;if((r=n[0]).markedAsAttacked)return void console.log("Cell is already attacked");this.human.markAsAttack(r),this.canUseConsumableItems=!1,this.setFightState(Ae.HumanTurnAttack)}}},e.prototype.onMouseMove=function(t){},e.prototype.onMouseUp=function(t,e){},e.prototype.reset=function(){this.turnNumber=1,this.human=Be.build(te.humanData,ne.Human,this.guiManager),this.enemy=Be.build(te.enemyData,ne.Ai,this.guiManager),this.setFightState(Ae.Start)},e.prototype.calculateTurn=function(t,e){for(var i=this,n=0,r=re.calculateDamages(t.playerData),o=re.calculateProtections(e.playerData),s=function(s){0===r.length&&(r=re.calculateDamages(t.playerData)),0===o.length&&(o=re.calculateProtections(e.playerData));var h=r.pop();if(s.markedAsProtected){var u=o.pop(),c=Math.min(1,1-u.protectionMultiplier+h.shieldPiercing);h.damage*=c}h.damage=Math.floor(h.damage),a.actionManager.add(function(){e.hit(h.damage);var t=s.cellSprite.sprite.absoluteMatrix.position.asVector2(),n=h.isCritical?new B(1,.2,.2,1):new B(.7,.7,.1,1);Zt.emitDamageCount(i.textEmitter,t,h.damage,n,h.isCritical?1.3:1),s.markedAsProtected?Zt.emitHitWithShield(i.emitter,t):Zt.emitHit(i.emitter,t)},n+=2)},a=this,h=0,u=e.shipCells.filter(function(t){return t.markedAsAttacked});h<u.length;h++){s(u[h])}},e.prototype.setFightState=function(t){var e=this;switch(t){case Ae.Start:this.dialog.text.text="Раунд "+this.turnNumber++,this.human.resetTurnState(),this.enemy.resetTurnState(),this.canUseConsumableItems=!0,this.actionManager.add(function(){return e.setFightState(Ae.HumanTurnProtect)},3);break;case Ae.HumanTurnProtect:if(!this.human.hasProtectsLeft())return void this.setFightState(Ae.HumanTurnAttack);this.dialog.text.text="Выберите "+this.human.protectsLeft+" своих отсека для защиты",this.canUseConsumableItems&&(this.dialog.text.text+=" или воспользуйтесь одноразовыми предметами");break;case Ae.HumanTurnAttack:if(!this.human.hasAttacksLeft())return void this.setFightState(Ae.AiTurn);this.dialog.text.text="Выберите "+this.human.attacksLeft+" отсека противника для атаки",this.canUseConsumableItems&&(this.dialog.text.text+=" или воспользуйтесь одноразовыми предметами");break;case Ae.AiTurn:this.dialog.text.text="Ход противника",this.actionManager.add(function(){return e.enemy.aiChooseProtectAndAttack(e.human)},2).then(function(){return e.setFightState(Ae.Animation)},2);break;case Ae.Animation:this.dialog.text.text="Рассчитываем бой...",this.actionManager.add(function(){return e.calculateTurn(e.human,e.enemy)},.5).then(function(){return e.calculateTurn(e.enemy,e.human)},4).then(function(){var t=!e.enemy.isAlive();!e.human.isAlive()?e.setFightState(Ae.Defeat):t?e.setFightState(Ae.Victory):e.setFightState(Ae.Start)},5);break;case Ae.Victory:this.dialog.text.text="Вы победили!";break;case Ae.Defeat:this.dialog.text.text="Вы проиграли!"}this.fightState=t},e.prototype.checkItemsClick=function(t){var e=this;if(this.fightState===Ae.HumanTurnAttack||this.fightState===Ae.HumanTurnProtect){var i=this.human.consumableItems.filter(function(e){return e.isMouseOver(t)});if(i.length>1)throw new Error("Hit too many items");if(0!==i.length){var n=i[0];if(n.canUse(this.human,this.enemy))this.actionManager.add(function(){return e.dialog.text.text="Используем «"+n.name+"»"}).then(function(){return e.setFightState(e.fightState)},2),n.use(this.human,this.enemy),this.human.activeItems.push({item:n,other:this.enemy,roundLeft:n.removeAfterNumberOfTurns});else{var r=this.dialog.text.text;this.actionManager.add(function(){return e.dialog.text.text="Нельзя использовать «"+n.name+"»"}).then(function(){return e.dialog.text.text=r},2)}}}},e}(z),Ne=function(){function t(t,e){this.camera=t,this.speed=e,this.movement=new p}return t.prototype.update=function(t){this.movement.set(0,0),v.isKeyDown[f.W]||v.isKeyDown[f.Up]?this.movement.addToSelf(0,-1):(v.isKeyDown[f.S]||v.isKeyDown[f.Down])&&this.movement.addToSelf(0,1),v.isKeyDown[f.A]||v.isKeyDown[f.Left]?this.movement.addToSelf(-1,0):(v.isKeyDown[f.D]||v.isKeyDown[f.Right])&&this.movement.addToSelf(1,0),this.movement.normalize().multiplyNumSelf(t*this.speed),this.camera.position.addToSelf(this.movement)},t}(),ze=function(){function t(){}return t.prototype.initialize=function(){},t.prototype.getSpritesToRender=function(){return[this.sprite]},t.prototype.getTextsToRender=function(){return[]},t.prototype.update=function(){},t}(),Le=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ue=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Le(e,t),e.buildPlanet1=function(){var t=new e;return t.initialize(),t.sprite.position.set(500,500,5),t.sprite.setVerticesColor(new B(29/255,172/255,109/255,1)),t.text.text="Земля",t},e.prototype.initialize=function(){t.prototype.initialize.call(this);var e=Dt.assets.solarAtlas.getRegion("circle_bordered.png");this.sprite=new Rt,this.sprite.setTextureRegion(e,!1),this.sprite.setSize(128,128),this.text=new Wt,this.text.pivotPoint.set(.5,0),this.text.parent=this.sprite,this.text.position.set(0,70,6),this.text.color=new B(.9,.9,.9,1)},e.prototype.getTextsToRender=function(){return[this.text]},e}(ze),je=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),He=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return je(e,t),e.buildPlayer=function(){var t=new e;return t.initialize(),t.sprite.position.set(y.width/2,y.height/2,5),t.speed=50,t},e.prototype.initialize=function(){t.prototype.initialize.call(this);var e=Dt.assets.solarAtlas.getRegion("triangle.png");this.sprite=new Rt,this.sprite.setTextureRegion(e,!1),this.sprite.setSize(16,16)},e.prototype.update=function(){},e}(ze),We=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Ge=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return We(e,t),e.build=function(){var t=new e;return t.initialize(),t.sprite.visible=!1,t},e.prototype.initialize=function(){t.prototype.initialize.call(this);var e=Dt.assets.solarAtlas.getRegion("circle.png");this.sprite=new Rt,this.sprite.setTextureRegion(e,!1),this.sprite.setSize(24,24),this.sprite.setVerticesColor(new B(.3,1,.3,1)),this.sprite.position.set(0,0,10)},e}(ze),Ke=new(function(){function t(){}return t.prototype.reset=function(){this.player=He.buildPlayer(),this.targetCursor=Ge.build(),this.planets=[Ue.buildPlanet1()],this.actionManager=new G,this.deltaTime=0},t}()),Xe=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Qe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Xe(e,t),e.build=function(){var t=new e;return t.initialize(),t},e.prototype.initialize=function(){t.prototype.initialize.call(this),this.sprite=new Rt;var e=Dt.assets.solarAtlas.getRegion("smoke.png");this.sprite.setTextureRegion(e,!0),this.sprite.position.set(0,0,1)},e.prototype.onActivate=function(){this.sprite.visible=!0;var t=new p(y.width*Math.random(),y.height*Math.random());this.sprite.position.set(t),this.sprite.rotation=360*Math.random(),this.sprite.setVerticesColor(new B(.2*Math.random(),.4*Math.random(),Math.random(),.2))},e.prototype.onDeactivate=function(){this.sprite.visible=!1},e}(ze),Ye=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Xe(e,t),e.prototype.initialize=function(){for(var t=0;t<10;++t)this.get()},e.prototype.update=function(t){},e.prototype.render=function(t){for(var e=0,i=0,n=this.poolObjects;i<n.length;i++){var r=n[i];r.active&&(r.sprite.position.z=1+.1*e++,t.drawSingle(r.sprite))}},e}(j),qe=function(){function t(){this.spriteBatch=new Vt,this.textBatch=new zt(Dt.assets.font),this.solarObjects=[],this.material=Dt.assets.solarMaterial,this.nebulaPool=new Ye(function(){return Qe.build()},16),this.cameraController=new Ne(Dt.assets.gameCamera,400)}return t.prototype.initialize=function(){y.setClearColorRGB(2/255,4/255,34/255,1),Ke.reset(),this.solarObjects=this.solarObjects.concat(Ke.planets),this.solarObjects.push(Ke.player,Ke.targetCursor),this.nebulaPool.initialize()},t.prototype.free=function(){this.spriteBatch.free()},t.prototype.draw=function(){this.material.bind(),this.spriteBatch.start(),this.textBatch.start();for(var t=0,e=this.solarObjects;t<e.length;t++){var i=e[t],n=i.getSpritesToRender(),r=i.getTextsToRender();this.spriteBatch.drawArray(n),this.textBatch.drawArray(r)}this.nebulaPool.render(this.spriteBatch),this.spriteBatch.finish(),this.textBatch.finish()},t.prototype.update=function(t){Ke.deltaTime=t,Ke.actionManager.update(t);for(var e=0,i=this.solarObjects;e<i.length;e++){i[e].update()}this.cameraController.update(t)},t.prototype.movePlayerToPosition=function(t){Ke.targetCursor.sprite.visible=!0,Ke.targetCursor.sprite.position.set(t),Ke.player.sprite.rotation=t.subtract(Ke.player.sprite.position).toAngle()+90,this.lastPlayerMoveAction&&this.lastPlayerMoveAction.onDeactivate(),this.lastPlayerMoveAction=Ke.actionManager.add(function(e){var i=t.subtract(Ke.player.sprite.position);return i.length()<1?(Ke.targetCursor.sprite.visible=!1,!0):(i.normalize().multiplyNumSelf(e*Ke.player.speed),Ke.player.sprite.position.addToSelf(i),!1)})},t}(),$e=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),Je=function(t){function e(){return t.call(this)||this}return $e(e,t),e.prototype.load=function(){return console.log("Game scene is loaded"),this.solarManager=new qe,this.solarManager.initialize(),t.prototype.load.call(this)},e.prototype.render=function(){Dt.assets.gameCamera.update(),this.solarManager.draw()},e.prototype.update=function(t){this.solarManager.update(t)},e.prototype.onKeyDown=function(t){},e.prototype.onMouseDown=function(t,e){if(e===f.LeftButton){var i=Dt.assets.gameCamera.screenToWorld(t);this.solarManager.movePlayerToPosition((new p).set(i))}},e.prototype.onMouseMove=function(t){},e.prototype.onMouseUp=function(t,e){},e}(z),Ze={background:{},buttons:[{name:"StartButton",labelText:"Start",labelColor:new B(.3,.3,.3,1),labelScale:1,size:new p(150,40),position:new c(480,400,1),pivotPoint:new p(.5,.5),verticesColor:new B(.9,.8,.8,1),hoverVerticesColor:new B(1,1,1,1)},{name:"HelpButton",labelText:"Help",labelColor:new B(.3,.3,.3,1),labelScale:1,size:new p(150,40),position:new c(480,460,1),pivotPoint:new p(.5,.5),verticesColor:new B(.8,.9,.8,1),hoverVerticesColor:new B(1,1,1,1)},{name:"TestFightButton",labelText:"Test Fight",labelColor:new B(.3,.3,.3,1),labelScale:1,size:new p(150,40),position:new c(480,520,1),pivotPoint:new p(.5,.5),verticesColor:new B(.8,.8,.9,1),hoverVerticesColor:new B(1,1,1,1)},{name:"TestPlanetButton",labelText:"Test Planet",labelColor:new B(.3,.3,.3,1),labelScale:1,size:new p(150,40),position:new c(480,580,1),pivotPoint:new p(.5,.5),verticesColor:new B(.8,.9,.9,1),hoverVerticesColor:new B(1,1,1,1)}]},ti=function(){function t(){}return t.loadMenu=function(t,e){e.buttons.forEach(function(e){var i=new ue;if(i.name=e.name,i.sprite.setSize(e.size.x,e.size.y),i.sprite.position.set(e.position),i.sprite.setVerticesColor(e.verticesColor),i.sprite.pivotPoint.set(e.pivotPoint),i.sprite.setDefaultVertices(),i.label.color.set(e.labelColor),i.label.text=e.labelText,i.label.scale=e.labelScale,null!=e.labelPosition&&i.label.position.set(e.labelPosition),null!=e.labelPivot&&i.label.pivotPoint.set(e.labelPivot),null!=e.textureRegion){var n=t.material.textures[0].texture;if(null!=n){var r=n.getRegion(e.textureRegion.name);i.sprite.setTextureRegion(r,e.textureRegion.adjustSize)}}i.updateHitBox(),i.onMouseOver=function(t,i){return t.sprite.setVerticesColor(e.hoverVerticesColor)},i.onMouseOut=function(t,i){return t.sprite.setVerticesColor(e.verticesColor)},t.addElement(i)})},t}(),ei=function(){return function(){}}(),ii=(function(){}(),new ei),ni="game",ri="mainMenu",oi="help",si="fight",ai="planet",hi=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),ui=function(t){function e(){return t.call(this)||this}return hi(e,t),e.prototype.load=function(){var e=this;return this.guiManager=new Bt(Dt.assets.blankMaterial,new Vt,new zt(Dt.assets.font),Dt.assets.guiCamera),ti.loadMenu(this.guiManager,Ze),this.guiManager.getElement("StartButton").onClick=function(){return e.sceneManager.switchTo(ni)},this.guiManager.getElement("HelpButton").onClick=function(){return e.sceneManager.switchTo(oi)},this.guiManager.getElement("TestFightButton").onClick=function(){return e.testFight()},this.guiManager.getElement("TestPlanetButton").onClick=function(){return e.testPlanet()},t.prototype.load.call(this)},e.prototype.unload=function(){return this.guiManager.free(),t.prototype.unload.call(this)},e.prototype.render=function(){Dt.assets.guiCamera.update(),this.guiManager.render()},e.prototype.update=function(t){this.guiManager.update(t)},e.prototype.onKeyDown=function(t){},e.prototype.onMouseDown=function(t,e){},e.prototype.onMouseMove=function(t){},e.prototype.onMouseUp=function(t,e){},e.prototype.testFight=function(){te.enemyData={criticalChance:.1,criticalMultiplier:2,cells:[{position:new p(-50,0),item:{type:jt.Weapon,name:"Чумовой лазер",cost:1e3,rarity:Ht.Legendary,weapon:{damageMin:8,damageMax:16}}},{position:new p(50,0),item:{type:jt.Weapon,name:"Крутой лазер",cost:500,rarity:Ht.Special,weapon:{damageMin:7,damageMax:13}}},{position:new p(-100,100),item:{type:jt.Shield,name:"Какой-то щит",cost:500,rarity:Ht.Legendary,shield:{shieldMultiplier:.45}}},{position:new p(100,100),item:{type:jt.Shield,name:"Какой-то щит",cost:500,rarity:Ht.Legendary,shield:{shieldMultiplier:.45}}},{position:new p(0,125)}],shipHealth:100,shipMaxHealth:100,credits:0,inventorySize:16,inventory:[]},te.humanData={criticalChance:.1,criticalMultiplier:2,cells:[{position:new p(-50,0),item:{type:jt.Weapon,name:"Чумовой лазер",cost:1e3,rarity:Ht.Legendary,weapon:{damageMin:8,damageMax:16}}},{position:new p(50,0),item:{type:jt.Weapon,name:"Крутой лазер",cost:500,rarity:Ht.Special,weapon:{damageMin:7,damageMax:13}}},{position:new p(-100,100),item:{type:jt.Shield,name:"Какой-то щит",cost:500,rarity:Ht.Legendary,shield:{shieldMultiplier:.45}}},{position:new p(100,100),item:{type:jt.Shield,name:"Какой-то щит",cost:500,rarity:Ht.Legendary,shield:{shieldMultiplier:.45}}},{position:new p(0,125)}],shipHealth:100,shipMaxHealth:100,credits:0,inventorySize:16,inventory:[{type:jt.Consumable,consumable:{type:Ut.Heal,count:1},cost:50,rarity:Ht.Special,name:"Лечение"},{type:jt.Consumable,consumable:{type:Ut.IncreaseCriticalChance,count:1},cost:50,rarity:Ht.Special,name:"Повысить шанс крит. урона"},{type:jt.Consumable,consumable:{type:Ut.MoreProtectCount,count:2},cost:50,rarity:Ht.Special,name:"+1 Защита"},{type:jt.Consumable,consumable:{type:Ut.MoreAttackCount,count:2},cost:50,rarity:Ht.Special,name:"+1 нападение"}]},this.sceneManager.switchTo(si)},e.prototype.testPlanet=function(){ii.player={criticalChance:.1,criticalMultiplier:2,cells:[{position:new p(-50,0),item:{type:jt.Weapon,name:"Чумовой лазер",cost:1e3,rarity:Ht.Legendary,weapon:{damageMin:8,damageMax:16,addAttack:1,criticalChanceMultiplier:.2}}},{position:new p(50,0),item:{type:jt.Weapon,name:"Крутой лазер",cost:500,rarity:Ht.Special,weapon:{damageMin:7,damageMax:13}}},{position:new p(-100,100)},{position:new p(100,100)},{position:new p(0,125)}],shipHealth:63,shipMaxHealth:100,credits:5e3,inventorySize:16,inventory:[{type:jt.Consumable,consumable:{type:Ut.Heal,count:1},cost:50,rarity:Ht.Special,name:"Лечение"},{type:jt.Consumable,consumable:{type:Ut.IncreaseCriticalChance,count:1},cost:50,rarity:Ht.Special,name:"+Шанс крит. урона"},{type:jt.Consumable,consumable:{type:Ut.MoreProtectCount,count:2},cost:50,rarity:Ht.Special,name:"+1 Защита"},{type:jt.Consumable,consumable:{type:Ut.MoreAttackCount,count:2},cost:50,rarity:Ht.Special,name:"+1 нападение"},{type:jt.Weapon,name:"Какой-то лазер",cost:300,rarity:Ht.Usual,weapon:{damageMin:6,damageMax:12}}]},ii.planet={name:"Земля",shopSize:24,shopItems:[{type:jt.Weapon,name:"Какой-то лазер",cost:300,rarity:Ht.Usual,weapon:{damageMin:6,damageMax:12,shieldPiercing:.1}},{type:jt.Shield,name:"Какой-то щит",cost:500,rarity:Ht.Legendary,shield:{shieldMultiplier:.45}}]},this.sceneManager.switchTo(ai)},e}(z),ci={background:{},buttons:[{name:"TakeOffButton",labelText:"Взлететь",labelColor:new B(1,1,1,1),labelScale:1,size:new p(150,40),position:new c(810,35,1),pivotPoint:new p(.5,.5),verticesColor:new B(.8,.8,.8,1),hoverVerticesColor:new B(1,1,1,1),textureRegion:{name:"button_red.png",adjustSize:!0}},{name:"RepairButton",labelText:"Починить",labelColor:new B(1,1,1,1),labelScale:1,labelPosition:new p(20,0),labelPivot:new p(0,.5),size:new p(150,40),position:new c(20,723,2),pivotPoint:new p(0,.5),verticesColor:new B(.8,.8,.8,1),hoverVerticesColor:new B(1,1,1,1),textureRegion:{name:"repair_button.png",adjustSize:!0}},{name:"BuySellButton",labelText:"---",labelColor:new B(1,1,1,1),labelScale:1,size:new p(150,40),position:new c(810,733,1),pivotPoint:new p(.5,.5),verticesColor:new B(.8,.8,.8,1),hoverVerticesColor:new B(1,1,1,1),textureRegion:{name:"button_green.png",adjustSize:!0}},{name:"ShipTransferButton",labelText:"---",labelColor:new B(1,1,1,1),labelScale:1,size:new p(150,40),position:new c(580,733,1),pivotPoint:new p(.5,.5),verticesColor:new B(.8,.8,.8,1),hoverVerticesColor:new B(1,1,1,1),textureRegion:{name:"button_green.png",adjustSize:!0}}]},li=function(){function t(t,e){this.stats=[];var i=Dt.assets.planetAtlas.getRegion("ship_cell.png"),n=Dt.assets.planetAtlas.getRegion("blank.png");this.back=new Rt(473,205,new p(0,0)),this.back.position.set(t,e,1),this.back.setVerticesColor(52/255,111/255,149/255,1),this.back.setTextureRegion(n,!1),this.itemBack=new Rt(1,1),this.itemBack.parent=this.back,this.itemBack.setTextureRegion(i,!0),this.itemBack.position.set(this.itemBack.width/2+5,this.itemBack.height/2+5,2),this.itemBack.setVerticesAlpha(.5),this.item=new Rt(1,1),this.item.parent=this.itemBack,this.item.position.set(0,0,3),this.item.rotation=45,this.item.setTextureRegion(n,!1),this.type=new Wt("Тип предмета"),this.type.parent=this.back,this.type.pivotPoint.set(0,1),this.type.position.set(5,this.back.height-5,2),this.name=new Wt("Название"),this.name.parent=this.back,this.name.pivotPoint.set(.5,0),this.name.position.set(this.back.width/2,5,2),this.name.scale=1.3,this.name.color.set(25/255,222/255,115/255,1),this.description=new Wt,this.description.parent=this.back,this.description.pivotPoint.set(0,0),this.description.position.set(5,95,2),this.description.maxTextWidth=this.back.width-10,this.description.isWrapped=!0,this.description.scale=.8,this.description.text="Какая-то многострочная и очень длинная строка, в которой есть все, что нужно знать",this.cost=new Wt("$"),this.cost.parent=this.back,this.cost.pivotPoint.set(1,1),this.cost.position.set(this.back.width-5,this.back.height-5,2);for(var r=this.itemBack.width/2+this.itemBack.position.x+10,o=0;o<5;o++){var s=new ie("","",r,40+25*o,200);s.caption.parent=this.back,this.stats.push(s)}}return t.prototype.update=function(t,e){for(var i=0,n=this.stats;i<n.length;i++){var r=n[i];r.caption.text=r.value.text=""}switch(this.description.text="",this.cost.text="$"+e,this.name.text=t.name,t.rarity){case Ht.Usual:this.itemBack.setVerticesColor(1,1,1,1);break;case Ht.Special:this.itemBack.setVerticesColor(.5,.5,1,1);break;case Ht.Legendary:this.itemBack.setVerticesColor(206/255,92/255,0,1)}switch(t.type){case jt.Consumable:this.type.text="Расходуемое";var o=t;switch(this.stats[0].caption.text="Количество",this.stats[0].value.text=""+o.count,o.consType){case Ut.Heal:this.description.text="Лечит корабль на некоторое количество единиц, которое определяется во время боя";break;case Ut.IncreaseCriticalChance:this.description.text="Увеличивает шанс критического удара по врагу на один раунд";break;case Ut.MoreAttackCount:this.description.text="Увеличивает число атак по вражескому кораблю на один раунд";break;case Ut.MoreProtectCount:this.description.text="Увеличивает число ваших отсеков, закрываемых щитом, на один раунд";break;default:this.description.text="Неизвестный науке расходуемый предмет. Ну, или как минимум программисту этой игры. Баг, короче."}break;case jt.Engine:this.type.text="Двигатель";var s=t;this.stats[0].caption.text="Уклонение",this.stats[0].value.text=""+s.dodgeMultiplier,this.stats[1].caption.text="Скорость",this.stats[1].value.text=""+s.speedBoost;break;case jt.Misc:this.type.text="Всячина",this.description.text="Отличная штука! Ее можно использовать чуть менее чем никак. Продайте, пока не кончился срок годности.";break;case jt.Shield:this.type.text="Генератор щита";var a=t;this.stats[0].caption.text="Сила щита",this.stats[0].value.text=""+a.shieldMultiplier,a.addProtect&&(this.stats[1].caption.text="Доп. щиты",this.stats[1].value.text="+"+a.addProtect);break;case jt.Weapon:this.type.text="Оружие";var h=t;this.stats[0].caption.text="Урон",this.stats[0].value.text=h.damageMin+"–"+h.damageMax;var u=1;h.criticalChanceMultiplier&&(this.stats[u].caption.text="Крит. шанс",this.stats[u].value.text="+"+100*h.criticalChanceMultiplier+" %",++u),h.shieldPiercing&&(this.stats[u].caption.text="Пробитие щита",this.stats[u].value.text="+"+100*h.shieldPiercing+" %",++u),h.addAttack&&(this.stats[u].caption.text="Доп. атаки",this.stats[u].value.text="+"+h.addAttack,++u);break;default:this.type.text="?!?!!?"}this.item.vertices=t.sprite.vertices.slice(),this.item.setSize(1.5*t.sprite.width,1.5*t.sprite.height),this.item.setDefaultVertices()},t.prototype.getSpritesToRender=function(){return[this.back,this.item,this.itemBack]},t.prototype.getTextsToRender=function(){for(var t=[this.name,this.type,this.description,this.cost],e=0,i=this.stats;e<i.length;e++){var n=i[e];t.push(n.caption,n.value)}return t},t.prototype.setVisible=function(t){this.back.visible=this.item.visible=this.itemBack.visible=this.name.visible=this.type.visible=this.description.visible=this.cost.visible=t;for(var e=0,i=this.stats;e<i.length;e++){var n=i[e];n.caption.visible=n.value.visible=t}},t}(),pi=function(){function t(){this.playerStats=[],this.shipCells=[],this.onShipCellClick=function(){}}return t.build=function(e,i){var n=new t;n.playerData=e;n.background=new Rt(400,y.height-80,new p(0,0)),n.background.position.set(10,70,1),n.background.setVerticesColor(52/255,111/255,149/255,1);var r=Dt.assets.planetAtlas.getRegion("blank.png");n.background.setTextureRegion(r,!1);n.playerStats.push(new ie("Урон (сумм)","",10,340,250),new ie("Крит. шанс","",10,365,250),new ie("Крит. урон","",10,390,250),new ie("Щит","",10,415,250));for(var o=0,s=n.playerStats;o<s.length;o++){s[o].caption.parent=n.background}for(var a=new p(200,140),h=0,u=e.cells;h<u.length;h++){var c=u[h];n.shipCells.push(new Me(c,a.x,a.y,i))}n.health=new ee(20,630),n.updateHealth(),n.inventory=new me(e.inventorySize,e.inventory,480,150,i),n.inventoryCaption=new Wt("Инвентарь"),n.inventoryCaption.position.set(450,70,2),n.inventoryCaption.color.set(1,1,1,1),n.inventoryCaption.pivotPoint.set(0,0),n.inventoryCaption.scale=1.3,n.creditsText=new Wt("$---"),n.creditsText.position.set(920,70,2),n.creditsText.color.set(1,1,1,1),n.creditsText.pivotPoint.set(1,0),n.creditsText.scale=1.3,n.updateCreditsText();for(var l=function(t){t.cellSprite.onClick=function(){return n.onShipCellClick(t)}},f=0,d=n.shipCells;f<d.length;f++){l(d[f])}return n},t.prototype.updateHealth=function(){this.health.updateHealth(this.playerData.shipHealth,this.playerData.shipMaxHealth)},t.prototype.updateCreditsText=function(){this.creditsText.text="$"+this.playerData.credits},t.prototype.updateStats=function(){this.playerStats[0].value.text=re.attackDamageMinMaxSummary(this.playerData),this.playerStats[1].value.text=re.criticalChanceSummary(this.playerData),this.playerStats[2].value.text=re.criticalMultiplierSummary(this.playerData),this.playerStats[3].value.text=re.protectSummary(this.playerData)},t.prototype.getSpritesToRender=function(){for(var t=[this.background,this.health.back,this.health.current],e=0,i=this.shipCells;e<i.length;e++){var n=i[e];n.item&&t.push(n.item.sprite)}return t.concat(this.inventory.getSpritesToRender())},t.prototype.getTextsToRender=function(){for(var t=[this.inventoryCaption,this.creditsText,this.health.text],e=0,i=this.playerStats;e<i.length;e++){var n=i[e];t.push(n.caption,n.value)}return t.concat(this.inventory.getTextsToRender())},t}(),fi=function(){function t(t,e,i,n){this.caption=new Wt("Магазин"),this.caption.position.set(e-30,i,2),this.caption.color.set(1,1,1,1),this.caption.scale=1.3,this.inventory=new me(t.shopSize,t.shopItems,e,i+70,n)}return t.prototype.getSpritesToRender=function(){return this.inventory.getSpritesToRender()},t.prototype.getTextsToRender=function(){return[this.caption].concat(this.inventory.getTextsToRender())},t}(),di=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(t){t[t.Buy=0]="Buy",t[t.Sell=1]="Sell"}(Fe||(Fe={})),function(t){t[t.Setup=0]="Setup",t[t.Remove=1]="Remove"}(Ie||(Ie={}));var yi=function(t){function e(){return t.call(this)||this}return di(e,t),e.prototype.load=function(){var e=this;return this.initGui(),this.renderHelper=new Oe(Dt.assets.font,Dt.assets.planetMaterial),this.player=pi.build(ii.player,this.guiManager),this.shop=new fi(ii.planet,480,260,this.guiManager),this.player.inventory.onClick=function(t){return e.onInventoryClick(t,!1)},this.shop.inventory.onClick=function(t){return e.onInventoryClick(t,!0)},this.player.onShipCellClick=function(t){return e.onShipCellClick(t)},this.itemDescription=new li(450.5,490),this.itemDescription.setVisible(!1),this.updateRepairText(),this.player.updateStats(),t.prototype.load.call(this)},e.prototype.unload=function(){return this.guiManager.free(),t.prototype.unload.call(this)},e.prototype.render=function(){Dt.assets.guiCamera.update(),this.renderHelper.render([this.player,this.shop,this.itemDescription,this]),this.guiManager.render()},e.prototype.update=function(t){this.guiManager.update(t)},e.prototype.onKeyDown=function(t){},e.prototype.onMouseDown=function(t,e){},e.prototype.onMouseMove=function(t){},e.prototype.onMouseUp=function(t,e){},e.prototype.getSpritesToRender=function(){return[this.selectedCellBorder]},e.prototype.getTextsToRender=function(){return[this.planetName,this.noMoneyText]},e.prototype.initGui=function(){var t=this;this.guiManager=new Bt(Dt.assets.planetMaterial,new Vt,new zt(Dt.assets.font),Dt.assets.guiCamera),ti.loadMenu(this.guiManager,ci),this.takeOffButton=this.guiManager.getElement("TakeOffButton"),this.takeOffButton.onClick=function(){t.updatePlayerData(),t.sceneManager.switchTo(ni)},this.repairButton=this.guiManager.getElement("RepairButton"),this.repairButton.onClick=function(){t.tryRepairShip()},this.buyOrSellButton=this.guiManager.getElement("BuySellButton"),this.buyOrSellButton.visible=!1,this.buyOrSellButton.onClick=function(){return t.onBuySellButtonClick()},this.shipTransferButton=this.guiManager.getElement("ShipTransferButton"),this.shipTransferButton.visible=!1,this.shipTransferButton.onClick=function(){return t.onShipTransferButtonClick()},this.planetName=new Wt("Планета «"+ii.planet.name+"»"),this.planetName.position.set(480,25,1),this.planetName.scale=1.7,this.planetName.pivotPoint.set(.5,.5),this.noMoneyText=new Wt("Недостаточно денег\nдля покупки"),this.noMoneyText.position.set(450.5,700,1),this.noMoneyText.pivotPoint.set(0,0),this.noMoneyText.color.set(1,.1,.1,1),this.noMoneyText.visible=!1,this.selectedCellBorder=new Rt;var e=Dt.assets.planetAtlas.getRegion("inventory_cell_selected.png");this.selectedCellBorder.setTextureRegion(e),this.selectedCellBorder.setVerticesColor(.7,1,.7,1),this.selectedCellBorder.position.set(-100,-100,10)},e.prototype.updateRepairText=function(){var t=this.getHealthPointPrice()*(this.player.playerData.shipMaxHealth-this.player.playerData.shipHealth);this.guiManager.getElement("RepairButton").label.text="Починить                    $"+t},e.prototype.tryRepairShip=function(){var t=this.player.playerData;if(t.shipHealth!==t.shipMaxHealth)if(0!==t.credits){var e=this.getHealthPointPrice(),i=Math.min(this.player.playerData.shipMaxHealth-this.player.playerData.shipHealth,h(t.credits,e)),n=i*e;t.credits-=n,t.shipHealth+=i,this.updateRepairText(),this.player.updateHealth(),this.player.updateCreditsText(),console.log("Healed "+i+" points for "+n+" ("+e+" per point)")}else console.log("No money - no honey");else console.log("Health is max")},e.prototype.getHealthPointPrice=function(){return 3},e.prototype.onInventoryClick=function(t,e){if(this.shopMode=e?Fe.Buy:Fe.Sell,this.selectedInventoryCell=t.item?t:void 0,this.selectedCellBorder.position.set(t.back.sprite.absoluteMatrix.position.asVector2()),!t.item)return this.itemDescription.setVisible(!1),this.buyOrSellButton.visible=!1,this.shipTransferButton.visible=!1,void(this.noMoneyText.visible=!1);this.itemDescription.setVisible(!0),this.buyOrSellButton.visible=!0,this.buyOrSellButton.label.text=e?"Купить":"Продать",this.itemDescription.update(t.item,e?this.getItemBuyPrice(t.item):this.getItemSellPrice(t.item));var i=e&&!this.isEnoughMoneyToBuy(t.item);this.noMoneyText.visible=i,this.buyOrSellButton.enabled=!i,!e&&this.hasEmptyShipCells()&&this.canSetupOnShip(t.item)?(this.shipTransferButton.visible=!0,this.shipTransferButton.label.text="Поставить",this.shipMode=Ie.Setup):this.shipTransferButton.visible=!1},e.prototype.onShipCellClick=function(t){if(this.buyOrSellButton.visible=!1,this.noMoneyText.visible=!1,this.selectedCellBorder.position.set(t.cellSprite.sprite.absoluteMatrix.position.asVector2()),!t.item)return this.itemDescription.setVisible(!1),this.shipTransferButton.visible=!1,void(this.selectedShipCell=void 0);this.itemDescription.setVisible(!0),this.shipTransferButton.visible=!0,this.shipTransferButton.label.text="Убрать",this.shipMode=Ie.Remove,this.selectedShipCell=t,this.itemDescription.update(t.item,this.getItemSellPrice(t.item))},e.prototype.hasEmptyShipCells=function(){return this.player.shipCells.some(function(t){return!t.item})},e.prototype.canSetupOnShip=function(t){return t.type===jt.Engine||t.type===jt.Shield||t.type===jt.Weapon},e.prototype.getItemBuyPrice=function(t){return Math.ceil(t.cost*this.getPlayerBuyMultiplier())},e.prototype.getItemSellPrice=function(t){return Math.ceil(t.cost*this.getPlayerSellMultiplier())},e.prototype.isEnoughMoneyToBuy=function(t){return this.player.playerData.credits>=this.getItemBuyPrice(t)},e.prototype.onShipTransferButtonClick=function(){if(this.shipMode===Ie.Setup){var t=this.player.shipCells.filter(function(t){return!t.item});if(0===t.length)throw new Error("Can not setup item - no emptyCells");if(this.shopMode===Fe.Buy)throw new Error("Can not setup item - ShopMode is Buy");if(!this.selectedInventoryCell)throw new Error("Can not setup item - not selected inventory cell");if(!this.selectedInventoryCell.item)throw new Error("Can not setup item - selected inventory cell has no item");t[0].setItem(this.selectedInventoryCell.item),this.selectedInventoryCell.setItem(),this.onInventoryClick(this.selectedInventoryCell,!1)}else{var e=this.player.inventory.cells.filter(function(t){return!t.item});if(0===e.length)throw new Error("Can not remove item - no emptyCells in inventory");if(!this.selectedShipCell)throw new Error("Can not remove item - no selected ship cell");if(!this.selectedShipCell.item)throw new Error("Can not remove item - selected ship cell has no item");e[0].setItem(this.selectedShipCell.item),this.selectedShipCell.setItem(),this.onShipCellClick(this.selectedShipCell)}this.updatePlayerData(),this.player.updateStats(),this.player.updateHealth()},e.prototype.onBuySellButtonClick=function(){if(this.shopMode===Fe.Buy){if(0===(t=this.player.inventory.cells.filter(function(t){return!t.item})).length)throw new Error("Can not buy item - no emptyCells in inventory");if(!this.selectedInventoryCell)throw new Error("Can not buy item - no selected inventory cell");if(!this.selectedInventoryCell.item)throw new Error("Can not buy item - selected inventory cell has no item");if(!this.isEnoughMoneyToBuy)throw new Error("Can not buy item - not enough money");t[0].setItem(this.selectedInventoryCell.item),this.player.playerData.credits-=this.getItemBuyPrice(this.selectedInventoryCell.item),this.selectedInventoryCell.setItem(),this.player.updateCreditsText(),this.onInventoryClick(this.selectedInventoryCell,!0),this.updatePlayerData()}else{if(!this.selectedInventoryCell)throw new Error("Can not sell item - no selected inventory cell");if(!this.selectedInventoryCell.item)throw new Error("Can not sell item - selected inventory cell has no item");var t;((t=this.shop.inventory.cells.filter(function(t){return!t.item})).length>0?t[0]:this.shop.inventory.cells[this.shop.inventory.cells.length-1]).setItem(this.selectedInventoryCell.item),this.player.playerData.credits+=this.getItemSellPrice(this.selectedInventoryCell.item),this.selectedInventoryCell.setItem(),this.player.updateCreditsText(),this.onInventoryClick(this.selectedInventoryCell,!1),this.updatePlayerData()}},e.prototype.getPlayerBuyMultiplier=function(){return 1.3},e.prototype.getPlayerSellMultiplier=function(){return.7},e.prototype.updatePlayerData=function(){var t=this.player.playerData;t.cells=this.player.shipCells.map(function(t){return t.toShipCellData()}),t.inventory=this.player.inventory.cells.filter(function(t){return t.item}).map(function(t){return t.item}).map(function(t){return t.toItemData()})},e}(z),mi=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),vi=function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{h(n.next(t))}catch(t){o(t)}}function a(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){t.done?r(t.value):new i(function(e){e(t.value)}).then(s,a)}h((n=n.apply(t,e||[])).next())})},gi=function(t,e){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},wi=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.sceneManager=new L,e}return mi(e,t),e.prototype.onInit=function(){return vi(this,void 0,void 0,function(){return gi(this,function(t){switch(t.label){case 0:return this.renderer.setClearColorRGB(10/255,53/255,71/255,1),[4,Dt.assets.loadAll()];case 1:return t.sent(),this.sceneManager.addScene(ni,new Je),this.sceneManager.addScene(ri,new ui),this.sceneManager.addScene(si,new Ve),this.sceneManager.addScene(ai,new yi),this.sceneManager.switchTo(ri),[2]}})})},e.prototype.onUpdate=function(t){Dt.actionManager.update(t),Dt.tweener.update(t),this.sceneManager.update(t)},e.prototype.onRender=function(){t.prototype.onRender.call(this),this.sceneManager.render()},e.prototype.onMouseMove=function(t){this.sceneManager.onMouseMove(t)},e.prototype.onMouseDown=function(t,e){this.sceneManager.onMouseDown(t,e)},e.prototype.onMouseUp=function(t,e){this.sceneManager.onMouseUp(t,e)},e.prototype.onKeyDown=function(t){this.sceneManager.onKeyDown(t)},e.prototype.onKeyUp=function(t){this.sceneManager.onKeyUp(t)},e}(V),xi=document.getElementById("canvas-main");xi&&new wi(xi).run()}]);